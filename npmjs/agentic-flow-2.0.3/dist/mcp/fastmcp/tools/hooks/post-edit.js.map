{"version":3,"file":"post-edit.js","sourceRoot":"","sources":["../../../../../src/mcp/fastmcp/tools/hooks/post-edit.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Post-Edit Hook - Learn from edit outcomes\n * Updates Q-table patterns and stores successful patterns\n *\n * NOW WITH RUVECTOR INTELLIGENCE:\n * - Completes trajectory tracking for reinforcement learning\n * - Stores patterns in ReasoningBank via SONA\n * - Uses EWC++ to prevent catastrophic forgetting\n */\n\nimport { z } from 'zod';\nimport * as path from 'path';\nimport type { ToolDefinition } from '../../types/index.js';\nimport {\n  loadIntelligence,\n  saveIntelligence,\n  simpleEmbed\n} from './shared.js';\nimport {\n  recordTrajectoryStep,\n  endTaskTrajectory,\n  storePattern,\n  forceLearningCycle,\n  getIntelligenceStats\n} from './intelligence-bridge.js';\nimport { activeEditTrajectories } from './pre-edit.js';\n\nconst LEARNING_RATE = 0.1;\nconst SUCCESS_REWARD = 1.0;\nconst FAILURE_PENALTY = -0.3;\n\nexport const hookPostEditTool: ToolDefinition = {\n  name: 'hook_post_edit',\n  description: 'Post-edit learning: record outcome, update patterns, distill memories',\n  parameters: z.object({\n    filePath: z.string().describe('Path to file that was edited'),\n    success: z.boolean().describe('Whether the edit was successful'),\n    agent: z.string().optional().describe('Agent that performed the edit'),\n    duration: z.number().optional().describe('Edit duration in ms'),\n    errorMessage: z.string().optional().describe('Error message if failed')\n  }),\n  execute: async ({ filePath, success, agent, duration, errorMessage }, { onProgress }) => {\n    const startTime = Date.now();\n    const intel = loadIntelligence();\n    const ext = path.extname(filePath);\n    const state = `edit:${ext}`;\n\n    // RUVECTOR INTELLIGENCE: Complete trajectory and learn\n    let learningOutcome = null;\n    let intelligenceEnabled = false;\n\n    try {\n      const trajectoryId = activeEditTrajectories.get(filePath);\n\n      if (trajectoryId !== undefined) {\n        // Record the final step\n        await recordTrajectoryStep(\n          trajectoryId,\n          `edit-${success ? 'success' : 'failure'}`,\n          success ? SUCCESS_REWARD : FAILURE_PENALTY,\n          {\n            file: filePath,\n            errorFixed: success,\n            testPassed: success\n          }\n        );\n\n        // End trajectory and get learning outcome\n        const quality = success ? 0.9 : 0.3;\n        learningOutcome = await endTaskTrajectory(trajectoryId, success, quality);\n\n        // Store successful pattern in ReasoningBank\n        if (success && agent) {\n          await storePattern(\n            `Edit ${ext} file: ${path.basename(filePath)}`,\n            `Agent ${agent} successfully edited the file`,\n            SUCCESS_REWARD\n          );\n        }\n\n        // Clean up\n        activeEditTrajectories.delete(filePath);\n        intelligenceEnabled = true;\n      }\n    } catch (error) {\n      console.debug('[PostEdit] Intelligence learning failed:', error);\n    }\n\n    // 1. Update Q-table pattern (fallback learning)\n    if (agent) {\n      if (!intel.patterns[state]) {\n        intel.patterns[state] = {};\n      }\n\n      const currentValue = intel.patterns[state][agent] || 0;\n      const reward = success ? SUCCESS_REWARD : FAILURE_PENALTY;\n\n      // Q-learning update: Q(s,a) = Q(s,a) + Î± * (r - Q(s,a))\n      intel.patterns[state][agent] = currentValue + LEARNING_RATE * (reward - currentValue);\n    }\n\n    // 2. Record in metrics\n    intel.metrics.totalRoutes++;\n    if (success) {\n      intel.metrics.successfulRoutes++;\n    }\n\n    intel.metrics.routingHistory.push({\n      timestamp: new Date().toISOString(),\n      task: `edit:${filePath}`,\n      agent: agent || 'unknown',\n      success\n    });\n\n    // Keep last 100 entries\n    if (intel.metrics.routingHistory.length > 100) {\n      intel.metrics.routingHistory = intel.metrics.routingHistory.slice(-100);\n    }\n\n    // 3. Store error pattern if failed\n    if (!success && errorMessage) {\n      const existingPattern = intel.errorPatterns.find(\n        p => p.errorType === errorMessage.split(':')[0]\n      );\n\n      if (existingPattern) {\n        existingPattern.agentSuccess[agent || 'unknown'] =\n          (existingPattern.agentSuccess[agent || 'unknown'] || 0) - 1;\n      } else {\n        intel.errorPatterns.push({\n          errorType: errorMessage.split(':')[0] || 'UnknownError',\n          context: `${ext} file edit`,\n          resolution: '',\n          agentSuccess: { [agent || 'unknown']: -1 }\n        });\n      }\n\n      // Keep last 50 error patterns\n      if (intel.errorPatterns.length > 50) {\n        intel.errorPatterns = intel.errorPatterns.slice(-50);\n      }\n    }\n\n    // 4. Distill successful pattern as memory\n    if (success && agent) {\n      const memoryContent = `Successful ${ext} edit by ${agent} on ${path.basename(filePath)}`;\n      intel.memories.push({\n        content: memoryContent,\n        type: 'success',\n        created: new Date().toISOString(),\n        embedding: simpleEmbed(memoryContent)\n      });\n\n      // Keep last 200 memories\n      if (intel.memories.length > 200) {\n        intel.memories = intel.memories.slice(-200);\n      }\n    }\n\n    // 5. Save updated intelligence\n    saveIntelligence(intel);\n\n    const latency = Date.now() - startTime;\n\n    // Get intelligence stats for monitoring\n    let intelligenceStats = null;\n    try {\n      intelligenceStats = await getIntelligenceStats();\n    } catch (e) {\n      // Ignore if not available\n    }\n\n    return {\n      success: true,\n      patternsUpdated: true,\n      newPatternValue: agent ? intel.patterns[state]?.[agent] : null,\n      routingAccuracy: intel.metrics.totalRoutes > 0\n        ? intel.metrics.successfulRoutes / intel.metrics.totalRoutes\n        : 0,\n      // RuVector Intelligence additions\n      intelligenceEnabled,\n      learningOutcome,\n      intelligenceStats,\n      latencyMs: latency,\n      timestamp: new Date().toISOString()\n    };\n  }\n};\n"]}
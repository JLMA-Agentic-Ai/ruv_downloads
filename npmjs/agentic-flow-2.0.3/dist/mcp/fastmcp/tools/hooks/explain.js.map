{"version":3,"file":"explain.js","sourceRoot":"","sources":["../../../../../src/mcp/fastmcp/tools/hooks/explain.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Explain Hook - Explain routing decisions with full transparency\n */\n\nimport { z } from 'zod';\nimport * as path from 'path';\nimport type { ToolDefinition } from '../../types/index.js';\nimport {\n  loadIntelligence,\n  getAgentForFile,\n  simpleEmbed,\n  cosineSimilarity\n} from './shared.js';\n\nexport const hookExplainTool: ToolDefinition = {\n  name: 'hook_explain',\n  description: 'Explain why an agent would be selected for a task',\n  parameters: z.object({\n    task: z.string().describe('Task description'),\n    file: z.string().optional().describe('Optional file context'),\n    agent: z.string().optional().describe('Specific agent to explain selection for')\n  }),\n  execute: async ({ task, file, agent }, { onProgress }) => {\n    const startTime = Date.now();\n    const intel = loadIntelligence();\n\n    // Collect all reasoning\n    const reasons: Array<{\n      factor: string;\n      weight: number;\n      evidence: string;\n      contributes: 'positive' | 'negative' | 'neutral';\n    }> = [];\n\n    // All agent scores\n    const allScores: Record<string, number> = {};\n\n    // 1. File pattern analysis\n    if (file) {\n      const ext = path.extname(file);\n      const suggestedAgent = getAgentForFile(file);\n\n      reasons.push({\n        factor: 'File Extension',\n        weight: 2.0,\n        evidence: `${ext} files are typically handled by ${suggestedAgent}`,\n        contributes: agent === suggestedAgent ? 'positive' : 'neutral'\n      });\n\n      allScores[suggestedAgent] = (allScores[suggestedAgent] || 0) + 2.0;\n\n      // Learned patterns\n      const state = `edit:${ext}`;\n      if (intel.patterns[state]) {\n        const patterns = intel.patterns[state];\n        const sortedPatterns = Object.entries(patterns)\n          .sort((a, b) => (b[1] as number) - (a[1] as number));\n\n        for (const [patternAgent, value] of sortedPatterns.slice(0, 3)) {\n          if (typeof value === 'number') {\n            allScores[patternAgent] = (allScores[patternAgent] || 0) + value;\n            reasons.push({\n              factor: 'Learned Pattern',\n              weight: value,\n              evidence: `Historical Q-value of ${value.toFixed(2)} for ${patternAgent} on ${ext} files`,\n              contributes: agent === patternAgent\n                ? (value > 0 ? 'positive' : 'negative')\n                : 'neutral'\n            });\n          }\n        }\n      }\n    }\n\n    // 2. Task keyword analysis\n    const taskLower = task.toLowerCase();\n    const keywordMatches: string[] = [];\n\n    const keywordMap: Record<string, string[]> = {\n      'test-engineer': ['test', 'spec', 'coverage'],\n      'documentation-specialist': ['document', 'readme', 'docs'],\n      'security-specialist': ['security', 'auth', 'vulnerability'],\n      'database-specialist': ['database', 'sql', 'query'],\n      'optimizer': ['optimize', 'performance', 'speed'],\n      'researcher': ['research', 'find', 'explore']\n    };\n\n    for (const [agentType, keywords] of Object.entries(keywordMap)) {\n      for (const keyword of keywords) {\n        if (taskLower.includes(keyword)) {\n          keywordMatches.push(keyword);\n          allScores[agentType] = (allScores[agentType] || 0) + 1.5;\n\n          reasons.push({\n            factor: 'Keyword Match',\n            weight: 1.5,\n            evidence: `Task mentions \"${keyword}\" â†’ suggests ${agentType}`,\n            contributes: agent === agentType ? 'positive' : 'neutral'\n          });\n        }\n      }\n    }\n\n    // 3. Memory similarity analysis\n    if (intel.memories.length > 0) {\n      const taskEmbed = simpleEmbed(task);\n      const similarMemories: Array<{ content: string; similarity: number }> = [];\n\n      for (const mem of intel.memories) {\n        if (mem.embedding) {\n          const similarity = cosineSimilarity(taskEmbed, mem.embedding);\n          if (similarity > 0.3) {\n            similarMemories.push({\n              content: mem.content.slice(0, 100),\n              similarity\n            });\n          }\n        }\n      }\n\n      if (similarMemories.length > 0) {\n        similarMemories.sort((a, b) => b.similarity - a.similarity);\n        const topMemory = similarMemories[0];\n\n        reasons.push({\n          factor: 'Memory Similarity',\n          weight: topMemory.similarity,\n          evidence: `Similar past task: \"${topMemory.content}...\"`,\n          contributes: 'positive'\n        });\n      }\n    }\n\n    // 4. Error pattern analysis\n    const relevantErrors = intel.errorPatterns.filter(ep =>\n      task.toLowerCase().includes(ep.errorType.toLowerCase()) ||\n      ep.context.toLowerCase().includes(task.toLowerCase().split(' ')[0])\n    );\n\n    if (relevantErrors.length > 0) {\n      for (const ep of relevantErrors.slice(0, 2)) {\n        const bestAgent = Object.entries(ep.agentSuccess)\n          .sort((a, b) => b[1] - a[1])[0];\n\n        if (bestAgent) {\n          reasons.push({\n            factor: 'Error History',\n            weight: 1.0,\n            evidence: `${bestAgent[0]} has fixed ${ep.errorType} ${bestAgent[1]} times`,\n            contributes: agent === bestAgent[0] ? 'positive' : 'neutral'\n          });\n        }\n      }\n    }\n\n    // 5. Calculate final scores and ranking\n    const ranking = Object.entries(allScores)\n      .sort((a, b) => b[1] - a[1])\n      .map(([agentName, score], index) => ({\n        rank: index + 1,\n        agent: agentName,\n        score,\n        isRequested: agent === agentName\n      }));\n\n    // 6. Generate explanation summary\n    const topAgent = ranking[0];\n    const requestedAgentRank = agent\n      ? ranking.find(r => r.agent === agent)\n      : null;\n\n    let summary: string;\n    if (!agent) {\n      summary = `${topAgent?.agent || 'coder'} is recommended with score ${topAgent?.score.toFixed(2) || 0}`;\n    } else if (requestedAgentRank?.rank === 1) {\n      summary = `${agent} is the top choice with score ${requestedAgentRank.score.toFixed(2)}`;\n    } else if (requestedAgentRank) {\n      summary = `${agent} ranks #${requestedAgentRank.rank} with score ${requestedAgentRank.score.toFixed(2)}. ${topAgent?.agent} is preferred.`;\n    } else {\n      summary = `${agent} has no specific advantages for this task. Consider ${topAgent?.agent || 'coder'}.`;\n    }\n\n    const latency = Date.now() - startTime;\n\n    return {\n      success: true,\n      summary,\n      reasons,\n      ranking: ranking.slice(0, 5),\n      requestedAgent: agent || null,\n      recommendedAgent: topAgent?.agent || 'coder',\n      memoryCount: intel.memories.length,\n      patternCount: Object.keys(intel.patterns).length,\n      latencyMs: latency,\n      timestamp: new Date().toISOString()\n    };\n  }\n};\n"]}
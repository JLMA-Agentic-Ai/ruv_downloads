{"version":3,"file":"pre-command.js","sourceRoot":"","sources":["../../../../../src/mcp/fastmcp/tools/hooks/pre-command.ts"],"names":[],"mappings":"AAAA;;;GAGG;AAEH,OAAO,EAAE,CAAC,EAAE,MAAM,KAAK,CAAC;AAExB,OAAO,EACL,gBAAgB,EAChB,iBAAiB,EAElB,MAAM,aAAa,CAAC;AAErB,wCAAwC;AACxC,MAAM,iBAAiB,GAA2B;IAChD,QAAQ,EAAE,uCAAuC;IACjD,SAAS,EAAE,6CAA6C;IACxD,WAAW,EAAE,2CAA2C;IACxD,WAAW,EAAE,6CAA6C;IAC1D,WAAW,EAAE,6CAA6C;CAC3D,CAAC;AAEF,MAAM,CAAC,MAAM,kBAAkB,GAAmB;IAChD,IAAI,EAAE,kBAAkB;IACxB,WAAW,EAAE,sEAAsE;IACnF,UAAU,EAAE,CAAC,CAAC,MAAM,CAAC;QACnB,OAAO,EAAE,CAAC,CAAC,MAAM,EAAE,CAAC,QAAQ,CAAC,mBAAmB,CAAC;KAClD,CAAC;IACF,OAAO,EAAE,KAAK,EAAE,EAAE,OAAO,EAAE,EAAE,EAAE,UAAU,EAAE,EAAE,EAAE;QAC7C,MAAM,SAAS,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QAC7B,MAAM,KAAK,GAAG,gBAAgB,EAAE,CAAC;QAEjC,uBAAuB;QACvB,MAAM,SAAS,GAAG,iBAAiB,CAAC,OAAO,CAAC,CAAC;QAE7C,sCAAsC;QACtC,MAAM,WAAW,GAAa,EAAE,CAAC;QACjC,KAAK,MAAM,CAAC,KAAK,EAAE,IAAI,CAAC,IAAI,MAAM,CAAC,OAAO,CAAC,iBAAiB,CAAC,EAAE,CAAC;YAC9D,IAAI,OAAO,CAAC,QAAQ,CAAC,KAAK,CAAC,EAAE,CAAC;gBAC5B,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YACzB,CAAC;QACH,CAAC;QAED,mDAAmD;QACnD,MAAM,QAAQ,GAAa,EAAE,CAAC;QAC9B,MAAM,OAAO,GAAG,OAAO,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC;QAEtC,KAAK,MAAM,EAAE,IAAI,KAAK,CAAC,aAAa,EAAE,CAAC;YACrC,IAAI,EAAE,CAAC,OAAO,CAAC,QAAQ,CAAC,OAAO,CAAC,IAAI,EAAE,CAAC,UAAU,EAAE,CAAC;gBAClD,QAAQ,CAAC,IAAI,CAAC,mBAAmB,EAAE,CAAC,UAAU,EAAE,CAAC,CAAC;YACpD,CAAC;QACH,CAAC;QAED,+BAA+B;QAC/B,MAAM,QAAQ,GAAG,SAAS,GAAG,GAAG,CAAC;QACjC,MAAM,oBAAoB,GAAG,SAAS,IAAI,GAAG,IAAI,SAAS,GAAG,GAAG,CAAC;QACjE,MAAM,OAAO,GAAG,SAAS,IAAI,GAAG,CAAC;QAEjC,qBAAqB;QACrB,IAAI,YAA0D,CAAC;QAC/D,IAAI,SAAS,GAAG,GAAG;YAAE,YAAY,GAAG,MAAM,CAAC;aACtC,IAAI,SAAS,GAAG,GAAG;YAAE,YAAY,GAAG,SAAS,CAAC;aAC9C,IAAI,SAAS,GAAG,GAAG;YAAE,YAAY,GAAG,WAAW,CAAC;;YAChD,YAAY,GAAG,SAAS,CAAC;QAE9B,MAAM,OAAO,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,SAAS,CAAC;QAEvC,OAAO;YACL,OAAO,EAAE,IAAI;YACb,SAAS;YACT,YAAY;YACZ,QAAQ;YACR,oBAAoB;YACpB,OAAO;YACP,WAAW;YACX,QAAQ,EAAE,QAAQ,CAAC,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC;YAC9B,SAAS,EAAE,OAAO;YAClB,SAAS,EAAE,IAAI,IAAI,EAAE,CAAC,WAAW,EAAE;SACpC,CAAC;IACJ,CAAC;CACF,CAAC","sourcesContent":["/**\n * Pre-Command Hook - Command risk assessment\n * Assesses command safety and suggests alternatives\n */\n\nimport { z } from 'zod';\nimport type { ToolDefinition } from '../../types/index.js';\nimport {\n  loadIntelligence,\n  assessCommandRisk,\n  dangerousPatterns\n} from './shared.js';\n\n// Safer alternatives for risky commands\nconst saferAlternatives: Record<string, string> = {\n  'rm -rf': 'rm -ri (interactive) or move to trash',\n  'sudo rm': 'Consider using specific permissions instead',\n  'chmod 777': 'chmod 755 or more restrictive permissions',\n  'curl | sh': 'Download script first, review, then execute',\n  'wget | sh': 'Download script first, review, then execute'\n};\n\nexport const hookPreCommandTool: ToolDefinition = {\n  name: 'hook_pre_command',\n  description: 'Pre-command intelligence: assess risk level and suggest alternatives',\n  parameters: z.object({\n    command: z.string().describe('Command to assess')\n  }),\n  execute: async ({ command }, { onProgress }) => {\n    const startTime = Date.now();\n    const intel = loadIntelligence();\n\n    // 1. Assess risk level\n    const riskLevel = assessCommandRisk(command);\n\n    // 2. Find matching safer alternatives\n    const suggestions: string[] = [];\n    for (const [risky, safe] of Object.entries(saferAlternatives)) {\n      if (command.includes(risky)) {\n        suggestions.push(safe);\n      }\n    }\n\n    // 3. Check if command matches known error patterns\n    const warnings: string[] = [];\n    const cmdBase = command.split(' ')[0];\n\n    for (const ep of intel.errorPatterns) {\n      if (ep.context.includes(cmdBase) && ep.resolution) {\n        warnings.push(`Previous issue: ${ep.resolution}`);\n      }\n    }\n\n    // 4. Determine approval status\n    const approved = riskLevel < 0.7;\n    const requiresConfirmation = riskLevel >= 0.5 && riskLevel < 0.9;\n    const blocked = riskLevel >= 0.9;\n\n    // 5. Categorize risk\n    let riskCategory: 'safe' | 'caution' | 'dangerous' | 'blocked';\n    if (riskLevel < 0.3) riskCategory = 'safe';\n    else if (riskLevel < 0.6) riskCategory = 'caution';\n    else if (riskLevel < 0.9) riskCategory = 'dangerous';\n    else riskCategory = 'blocked';\n\n    const latency = Date.now() - startTime;\n\n    return {\n      success: true,\n      riskLevel,\n      riskCategory,\n      approved,\n      requiresConfirmation,\n      blocked,\n      suggestions,\n      warnings: warnings.slice(0, 2),\n      latencyMs: latency,\n      timestamp: new Date().toISOString()\n    };\n  }\n};\n"]}
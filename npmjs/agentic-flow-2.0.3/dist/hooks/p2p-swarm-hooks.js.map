{"version":3,"file":"p2p-swarm-hooks.js","sourceRoot":"","sources":["../../src/hooks/p2p-swarm-hooks.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * P2P Swarm V2 Hooks Integration\n *\n * Provides hook handlers for P2P swarm coordination:\n * - PreToolUse: Check swarm connection, validate capabilities\n * - PostToolUse: Sync learning data to swarm\n * - SessionStart: Initialize swarm connection\n * - Stop: Cleanup swarm connection\n */\n\nimport { createP2PSwarmV2, P2PSwarmV2 } from '../swarm/p2p-swarm-v2.js';\nimport { logger } from '../utils/logger.js';\n\n// Global swarm instance for hooks\nlet hooksSwarmInstance: P2PSwarmV2 | null = null;\n\n/**\n * Get or create swarm instance for hooks\n */\nexport async function getHooksSwarm(agentId?: string, swarmKey?: string): Promise<P2PSwarmV2> {\n  if (!hooksSwarmInstance) {\n    const id = agentId || `hooks-agent-${Date.now().toString(36)}`;\n    hooksSwarmInstance = await createP2PSwarmV2(id, swarmKey);\n    logger.info('P2P Swarm initialized for hooks', { agentId: id });\n  }\n  return hooksSwarmInstance;\n}\n\n/**\n * Disconnect hooks swarm\n */\nexport function disconnectHooksSwarm(): void {\n  if (hooksSwarmInstance) {\n    hooksSwarmInstance.disconnect();\n    hooksSwarmInstance = null;\n    logger.info('P2P Swarm disconnected from hooks');\n  }\n}\n\n/**\n * SessionStart hook - Initialize P2P swarm connection\n */\nexport async function onSessionStart(config?: {\n  agentId?: string;\n  swarmKey?: string;\n  enableExecutor?: boolean;\n}): Promise<{\n  connected: boolean;\n  agentId: string;\n  swarmId: string;\n  swarmKey: string;\n  memberCount: number;\n}> {\n  try {\n    // Check if swarm is enabled\n    if (process.env.AGENTIC_FLOW_P2P_SWARM !== 'true') {\n      return {\n        connected: false,\n        agentId: '',\n        swarmId: '',\n        swarmKey: '',\n        memberCount: 0,\n      };\n    }\n\n    const swarm = await getHooksSwarm(\n      config?.agentId || process.env.AGENTIC_FLOW_SWARM_AGENT_ID,\n      config?.swarmKey || process.env.AGENTIC_FLOW_SWARM_KEY\n    );\n\n    if (config?.enableExecutor) {\n      swarm.startTaskExecutor();\n    }\n\n    const status = swarm.getStatus();\n\n    return {\n      connected: status.connected,\n      agentId: status.agentId,\n      swarmId: status.swarmId,\n      swarmKey: swarm.getSwarmKey(),\n      memberCount: swarm.getLiveMemberCount(),\n    };\n  } catch (error) {\n    logger.error('Failed to initialize P2P swarm on session start', { error });\n    return {\n      connected: false,\n      agentId: '',\n      swarmId: '',\n      swarmKey: '',\n      memberCount: 0,\n    };\n  }\n}\n\n/**\n * Stop hook - Cleanup P2P swarm connection\n */\nexport function onStop(): void {\n  disconnectHooksSwarm();\n}\n\n/**\n * PreToolUse hook - Check swarm status before tool execution\n */\nexport async function onPreToolUse(toolName: string, params: Record<string, any>): Promise<{\n  allow: boolean;\n  swarmConnected: boolean;\n  liveMembers: number;\n  recommendation?: string;\n}> {\n  if (!hooksSwarmInstance) {\n    return {\n      allow: true, // Allow if swarm not initialized\n      swarmConnected: false,\n      liveMembers: 0,\n    };\n  }\n\n  const status = hooksSwarmInstance.getStatus();\n  const liveMembers = hooksSwarmInstance.getLiveMemberCount();\n\n  // Provide recommendations based on swarm state\n  let recommendation: string | undefined;\n\n  if (toolName === 'Bash' || toolName === 'Edit' || toolName === 'Write') {\n    // Suggest syncing after file operations\n    recommendation = 'Consider syncing learning data to swarm after this operation';\n  }\n\n  return {\n    allow: true,\n    swarmConnected: status.connected,\n    liveMembers,\n    recommendation,\n  };\n}\n\n/**\n * PostToolUse hook - Sync learning data after tool execution\n */\nexport async function onPostToolUse(\n  toolName: string,\n  params: Record<string, any>,\n  result: any\n): Promise<{\n  synced: boolean;\n  syncType?: string;\n  messageId?: string;\n}> {\n  if (!hooksSwarmInstance) {\n    return { synced: false };\n  }\n\n  try {\n    // Sync relevant data based on tool type\n    if (toolName === 'Edit' || toolName === 'Write') {\n      // Publish file change notification\n      const messageId = await hooksSwarmInstance.publish('file_changes', {\n        tool: toolName,\n        file: params.file_path || params.path,\n        timestamp: Date.now(),\n        success: !result?.error,\n      });\n\n      return {\n        synced: true,\n        syncType: 'file_change',\n        messageId,\n      };\n    }\n\n    if (toolName === 'Bash') {\n      // Publish command execution notification\n      const messageId = await hooksSwarmInstance.publish('commands', {\n        command: (params.command || '').substring(0, 100),\n        timestamp: Date.now(),\n        success: result?.exitCode === 0,\n      });\n\n      return {\n        synced: true,\n        syncType: 'command',\n        messageId,\n      };\n    }\n\n    return { synced: false };\n  } catch (error) {\n    logger.warn('Failed to sync to P2P swarm', { error, toolName });\n    return { synced: false };\n  }\n}\n\n/**\n * Sync Q-table to swarm (for learning coordination)\n */\nexport async function syncQTable(qTable: number[][]): Promise<{\n  success: boolean;\n  cid?: string;\n  error?: string;\n}> {\n  if (!hooksSwarmInstance) {\n    return {\n      success: false,\n      error: 'P2P swarm not connected',\n    };\n  }\n\n  try {\n    const pointer = await hooksSwarmInstance.syncQTable(qTable);\n    return {\n      success: true,\n      cid: pointer.cid,\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : String(error),\n    };\n  }\n}\n\n/**\n * Sync memory vectors to swarm\n */\nexport async function syncMemory(\n  vectors: number[][],\n  namespace: string = 'default'\n): Promise<{\n  success: boolean;\n  cid?: string;\n  error?: string;\n}> {\n  if (!hooksSwarmInstance) {\n    return {\n      success: false,\n      error: 'P2P swarm not connected',\n    };\n  }\n\n  try {\n    const pointer = await hooksSwarmInstance.syncMemory(vectors, namespace);\n    return {\n      success: true,\n      cid: pointer.cid,\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : String(error),\n    };\n  }\n}\n\n/**\n * Get swarm status for hooks context\n */\nexport function getSwarmStatus(): {\n  connected: boolean;\n  agentId?: string;\n  swarmId?: string;\n  liveMembers: number;\n  relays?: { healthy: number; total: number };\n} {\n  if (!hooksSwarmInstance) {\n    return {\n      connected: false,\n      liveMembers: 0,\n    };\n  }\n\n  const status = hooksSwarmInstance.getStatus();\n  return {\n    connected: status.connected,\n    agentId: status.agentId,\n    swarmId: status.swarmId,\n    liveMembers: hooksSwarmInstance.getLiveMemberCount(),\n    relays: {\n      healthy: status.relays.healthy,\n      total: status.relays.total,\n    },\n  };\n}\n\n/**\n * Subscribe to swarm topic for real-time updates\n */\nexport function subscribeToTopic(\n  topic: string,\n  callback: (data: any, from: string) => void\n): void {\n  if (!hooksSwarmInstance) {\n    logger.warn('Cannot subscribe: P2P swarm not connected');\n    return;\n  }\n\n  hooksSwarmInstance.subscribe(topic, callback);\n}\n\n/**\n * Publish to swarm topic\n */\nexport async function publishToTopic(\n  topic: string,\n  payload: any\n): Promise<string | null> {\n  if (!hooksSwarmInstance) {\n    logger.warn('Cannot publish: P2P swarm not connected');\n    return null;\n  }\n\n  try {\n    return await hooksSwarmInstance.publish(topic, payload);\n  } catch (error) {\n    logger.error('Failed to publish to swarm', { error, topic });\n    return null;\n  }\n}\n\n// Export hook handlers for registration\nexport const p2pSwarmHooks = {\n  onSessionStart,\n  onStop,\n  onPreToolUse,\n  onPostToolUse,\n  syncQTable,\n  syncMemory,\n  getSwarmStatus,\n  subscribeToTopic,\n  publishToTopic,\n  getHooksSwarm,\n  disconnectHooksSwarm,\n};\n\nexport default p2pSwarmHooks;\n"]}
{"version":3,"file":"session-manager.js","sourceRoot":"","sources":["../../src/sdk/session-manager.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * SDK Session Manager - Manages Claude Agent SDK session lifecycle\n *\n * Provides session ID capture, resume capability, and session forking\n * for maintaining context across multiple queries.\n */\n\nimport { logger } from \"../utils/logger.js\";\n\n// Session info stored in memory\ninterface SessionInfo {\n  sessionId: string;\n  startTime: number;\n  messageCount: number;\n  lastActivity: number;\n  agentName?: string;\n  resumed: boolean;\n}\n\n// Session TTL: 30 minutes of inactivity\nconst SESSION_TTL_MS = 30 * 60 * 1000;\n\n// In-memory session storage\nconst activeSessions = new Map<string, SessionInfo>();\n\n// Current session for quick access\nlet currentSessionId: string | null = null;\n\n// Cleanup stale sessions periodically\nfunction cleanupStaleSessions(): void {\n  const now = Date.now();\n  for (const [id, session] of activeSessions.entries()) {\n    if (now - session.lastActivity > SESSION_TTL_MS) {\n      activeSessions.delete(id);\n      if (currentSessionId === id) {\n        currentSessionId = null;\n      }\n    }\n  }\n}\n\n// Run cleanup every 5 minutes\nsetInterval(cleanupStaleSessions, 5 * 60 * 1000).unref();\n\n/**\n * SDK Message types (from documentation)\n */\ninterface SDKSystemMessage {\n  type: 'system';\n  subtype: 'init' | 'compact_boundary';\n  uuid: string;\n  session_id: string;\n  apiKeySource?: string;\n  cwd?: string;\n  tools?: string[];\n  model?: string;\n  permissionMode?: string;\n}\n\ninterface SDKResultMessage {\n  type: 'result';\n  subtype: 'success' | 'error_max_turns' | 'error_during_execution' | 'error_max_budget_usd';\n  uuid: string;\n  session_id: string;\n  duration_ms: number;\n  total_cost_usd: number;\n  result?: string;\n  errors?: string[];\n}\n\ntype SDKMessage = SDKSystemMessage | SDKResultMessage | { type: string; session_id?: string };\n\n/**\n * Capture session ID from SDK init message\n * Call this for every message received from query()\n */\nexport function captureSessionId(message: SDKMessage): string | null {\n  if (\n    message.type === 'system' &&\n    (message as SDKSystemMessage).subtype === 'init' &&\n    (message as SDKSystemMessage).session_id\n  ) {\n    const sessionId = (message as SDKSystemMessage).session_id;\n\n    // Store session info\n    activeSessions.set(sessionId, {\n      sessionId,\n      startTime: Date.now(),\n      messageCount: 1,\n      lastActivity: Date.now(),\n      resumed: false\n    });\n\n    currentSessionId = sessionId;\n\n    logger.info('Session captured', {\n      sessionId,\n      model: (message as SDKSystemMessage).model,\n      tools: (message as SDKSystemMessage).tools?.length\n    });\n\n    return sessionId;\n  }\n\n  // Update message count for existing session\n  if (message.session_id && activeSessions.has(message.session_id)) {\n    const session = activeSessions.get(message.session_id)!;\n    session.messageCount++;\n    session.lastActivity = Date.now();\n  }\n\n  return null;\n}\n\n/**\n * Get the current active session ID\n */\nexport function getCurrentSessionId(): string | null {\n  return currentSessionId;\n}\n\n/**\n * Get session info by ID\n */\nexport function getSessionInfo(sessionId: string): SessionInfo | undefined {\n  return activeSessions.get(sessionId);\n}\n\n/**\n * Get all active sessions\n */\nexport function getActiveSessions(): SessionInfo[] {\n  return Array.from(activeSessions.values());\n}\n\n/**\n * Get resume options for continuing a session\n * @param sessionId - Session ID to resume, or uses current session if not provided\n */\nexport function getResumeOptions(sessionId?: string): { resume?: string } {\n  const id = sessionId || currentSessionId;\n\n  if (!id) {\n    return {};\n  }\n\n  // Mark session as resumed\n  const session = activeSessions.get(id);\n  if (session) {\n    session.resumed = true;\n  }\n\n  logger.info('Preparing session resume', { sessionId: id });\n\n  return {\n    resume: id\n  };\n}\n\n/**\n * Get fork options for creating a new session branch from an existing one\n * @param sessionId - Session ID to fork from\n */\nexport function getForkOptions(sessionId: string): { resume: string; forkSession: boolean } {\n  logger.info('Forking session', { sourceSessionId: sessionId });\n\n  return {\n    resume: sessionId,\n    forkSession: true\n  };\n}\n\n/**\n * Mark a session as ended\n */\nexport function endSession(sessionId: string): void {\n  if (activeSessions.has(sessionId)) {\n    const session = activeSessions.get(sessionId)!;\n    logger.info('Session ended', {\n      sessionId,\n      duration: Date.now() - session.startTime,\n      messageCount: session.messageCount\n    });\n\n    activeSessions.delete(sessionId);\n\n    if (currentSessionId === sessionId) {\n      currentSessionId = null;\n    }\n  }\n}\n\n/**\n * Clear all sessions (for testing/reset)\n */\nexport function clearAllSessions(): void {\n  activeSessions.clear();\n  currentSessionId = null;\n  logger.info('All sessions cleared');\n}\n\n/**\n * Get session statistics\n */\nexport function getSessionStats(): {\n  totalSessions: number;\n  activeSessions: number;\n  currentSessionId: string | null;\n  totalMessages: number;\n} {\n  const sessions = Array.from(activeSessions.values());\n\n  return {\n    totalSessions: sessions.length,\n    activeSessions: sessions.filter(s => !s.resumed).length,\n    currentSessionId,\n    totalMessages: sessions.reduce((sum, s) => sum + s.messageCount, 0)\n  };\n}\n\n/**\n * Process result message and extract session info\n */\nexport function processResultMessage(message: SDKMessage): {\n  success: boolean;\n  sessionId?: string;\n  duration?: number;\n  cost?: number;\n  result?: string;\n  errors?: string[];\n} | null {\n  if (message.type !== 'result') return null;\n\n  const resultMsg = message as SDKResultMessage;\n\n  return {\n    success: resultMsg.subtype === 'success',\n    sessionId: resultMsg.session_id,\n    duration: resultMsg.duration_ms,\n    cost: resultMsg.total_cost_usd,\n    result: resultMsg.result,\n    errors: resultMsg.errors\n  };\n}\n\n/**\n * Build query options with session support\n */\nexport function buildQueryOptionsWithSession(\n  baseOptions: Record<string, any>,\n  options: {\n    resumeSession?: boolean;\n    sessionId?: string;\n    forkSession?: boolean;\n  } = {}\n): Record<string, any> {\n  const { resumeSession, sessionId, forkSession } = options;\n\n  if (forkSession && sessionId) {\n    return {\n      ...baseOptions,\n      ...getForkOptions(sessionId)\n    };\n  }\n\n  if (resumeSession) {\n    return {\n      ...baseOptions,\n      ...getResumeOptions(sessionId)\n    };\n  }\n\n  return baseOptions;\n}\n"]}
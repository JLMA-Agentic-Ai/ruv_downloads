{"version":3,"file":"e2b-swarm-optimizer.js","sourceRoot":"","sources":["../../src/sdk/e2b-swarm-optimizer.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * E2B Swarm Optimizer - Performance optimization for E2B swarms\n *\n * Provides automatic optimization strategies:\n * - Agent pool sizing\n * - Task batching\n * - Load rebalancing\n * - Resource cleanup\n */\n\nimport { logger } from \"../utils/logger.js\";\nimport { E2BSwarmOrchestrator, E2BSwarmMetrics, E2BAgent, E2BTask, E2BTaskResult } from \"./e2b-swarm.js\";\n\n/**\n * Optimization configuration\n */\nexport interface OptimizationConfig {\n  targetUtilization: number;      // Target agent utilization (0-1)\n  maxErrorRate: number;           // Maximum acceptable error rate\n  minAgents: number;              // Minimum agent count\n  maxAgents: number;              // Maximum agent count\n  scaleUpThreshold: number;       // Queue depth to trigger scale up\n  scaleDownThreshold: number;     // Idle time to trigger scale down (ms)\n  batchSize: number;              // Default task batch size\n  optimizationInterval: number;   // How often to run optimization (ms)\n}\n\n/**\n * Optimization report\n */\nexport interface OptimizationReport {\n  timestamp: number;\n  metrics: E2BSwarmMetrics;\n  recommendations: OptimizationRecommendation[];\n  actionsApplied: string[];\n  healthScore: number;\n}\n\n/**\n * Optimization recommendation\n */\nexport interface OptimizationRecommendation {\n  type: 'scale-up' | 'scale-down' | 'rebalance' | 'cleanup' | 'batch' | 'capability-add';\n  priority: 'low' | 'medium' | 'high' | 'critical';\n  description: string;\n  impact: string;\n  autoApply: boolean;\n}\n\n/**\n * E2B Swarm Optimizer\n */\nexport class E2BSwarmOptimizer {\n  private swarm: E2BSwarmOrchestrator;\n  private config: OptimizationConfig;\n  private optimizationHistory: OptimizationReport[] = [];\n  private intervalId: NodeJS.Timeout | null = null;\n\n  constructor(swarm: E2BSwarmOrchestrator, config?: Partial<OptimizationConfig>) {\n    this.swarm = swarm;\n    this.config = {\n      targetUtilization: config?.targetUtilization || 0.7,\n      maxErrorRate: config?.maxErrorRate || 0.1,\n      minAgents: config?.minAgents || 2,\n      maxAgents: config?.maxAgents || 10,\n      scaleUpThreshold: config?.scaleUpThreshold || 5,\n      scaleDownThreshold: config?.scaleDownThreshold || 60000,\n      batchSize: config?.batchSize || 10,\n      optimizationInterval: config?.optimizationInterval || 30000\n    };\n  }\n\n  /**\n   * Start automatic optimization\n   */\n  startAutoOptimization(): void {\n    if (this.intervalId) return;\n\n    this.intervalId = setInterval(async () => {\n      await this.optimize();\n    }, this.config.optimizationInterval);\n\n    logger.info('Auto-optimization started', { interval: this.config.optimizationInterval });\n  }\n\n  /**\n   * Stop automatic optimization\n   */\n  stopAutoOptimization(): void {\n    if (this.intervalId) {\n      clearInterval(this.intervalId);\n      this.intervalId = null;\n      logger.info('Auto-optimization stopped');\n    }\n  }\n\n  /**\n   * Run optimization cycle\n   */\n  async optimize(): Promise<OptimizationReport> {\n    const metrics = this.swarm.getMetrics();\n    const recommendations = this.analyzeMetrics(metrics);\n    const actionsApplied: string[] = [];\n\n    // Apply auto-applicable recommendations\n    for (const rec of recommendations.filter(r => r.autoApply)) {\n      const applied = await this.applyRecommendation(rec);\n      if (applied) {\n        actionsApplied.push(rec.type);\n      }\n    }\n\n    const report: OptimizationReport = {\n      timestamp: Date.now(),\n      metrics,\n      recommendations,\n      actionsApplied,\n      healthScore: this.calculateHealthScore(metrics)\n    };\n\n    this.optimizationHistory.push(report);\n\n    // Keep only last 100 reports\n    if (this.optimizationHistory.length > 100) {\n      this.optimizationHistory = this.optimizationHistory.slice(-100);\n    }\n\n    logger.info('Optimization cycle complete', {\n      healthScore: report.healthScore,\n      recommendations: recommendations.length,\n      actionsApplied: actionsApplied.length\n    });\n\n    return report;\n  }\n\n  /**\n   * Analyze metrics and generate recommendations\n   */\n  private analyzeMetrics(metrics: E2BSwarmMetrics): OptimizationRecommendation[] {\n    const recommendations: OptimizationRecommendation[] = [];\n\n    // Check error rate\n    if (metrics.errorRate > this.config.maxErrorRate) {\n      recommendations.push({\n        type: 'cleanup',\n        priority: 'high',\n        description: `Error rate ${(metrics.errorRate * 100).toFixed(1)}% exceeds threshold ${(this.config.maxErrorRate * 100).toFixed(1)}%`,\n        impact: 'Restart failing agents to reduce errors',\n        autoApply: true\n      });\n    }\n\n    // Check utilization - need to scale up\n    const avgUtilization = this.calculateAverageUtilization(metrics);\n    if (avgUtilization > this.config.targetUtilization && metrics.totalAgents < this.config.maxAgents) {\n      recommendations.push({\n        type: 'scale-up',\n        priority: 'medium',\n        description: `Utilization ${(avgUtilization * 100).toFixed(1)}% above target ${(this.config.targetUtilization * 100).toFixed(1)}%`,\n        impact: 'Add more agents to handle load',\n        autoApply: false\n      });\n    }\n\n    // Check utilization - can scale down\n    if (avgUtilization < 0.2 && metrics.totalAgents > this.config.minAgents) {\n      recommendations.push({\n        type: 'scale-down',\n        priority: 'low',\n        description: `Utilization ${(avgUtilization * 100).toFixed(1)}% is very low`,\n        impact: 'Remove idle agents to save resources',\n        autoApply: false\n      });\n    }\n\n    // Check for imbalanced agents\n    const utilizationValues = Object.values(metrics.agentUtilization);\n    if (utilizationValues.length > 1) {\n      const max = Math.max(...utilizationValues);\n      const min = Math.min(...utilizationValues);\n      if (max - min > 0.5) {\n        recommendations.push({\n          type: 'rebalance',\n          priority: 'medium',\n          description: `Agent utilization imbalanced (${(min * 100).toFixed(0)}% - ${(max * 100).toFixed(0)}%)`,\n          impact: 'Redistribute tasks for better balance',\n          autoApply: true\n        });\n      }\n    }\n\n    return recommendations;\n  }\n\n  /**\n   * Apply an optimization recommendation\n   */\n  private async applyRecommendation(rec: OptimizationRecommendation): Promise<boolean> {\n    try {\n      switch (rec.type) {\n        case 'cleanup':\n          return await this.cleanupFailingAgents();\n        case 'rebalance':\n          return await this.rebalanceLoad();\n        default:\n          return false;\n      }\n    } catch (error) {\n      logger.warn('Failed to apply recommendation', { type: rec.type, error: (error as Error).message });\n      return false;\n    }\n  }\n\n  /**\n   * Cleanup failing agents\n   */\n  private async cleanupFailingAgents(): Promise<boolean> {\n    const agents = this.swarm.getAgents();\n    let cleaned = false;\n\n    for (const agent of agents) {\n      if (agent.status === 'error' || (agent.errors > 5 && agent.tasksCompleted > 0)) {\n        const errorRate = agent.errors / (agent.tasksCompleted + agent.errors);\n        if (errorRate > 0.3) {\n          await this.swarm.terminateAgent(agent.id);\n          logger.info('Cleaned up failing agent', { id: agent.id, errorRate });\n          cleaned = true;\n        }\n      }\n    }\n\n    return cleaned;\n  }\n\n  /**\n   * Rebalance load across agents\n   */\n  private async rebalanceLoad(): Promise<boolean> {\n    // For now, just log - actual rebalancing would require task migration\n    logger.info('Load rebalancing requested');\n    return true;\n  }\n\n  /**\n   * Calculate average utilization\n   */\n  private calculateAverageUtilization(metrics: E2BSwarmMetrics): number {\n    const values = Object.values(metrics.agentUtilization);\n    if (values.length === 0) return 0;\n    return values.reduce((a, b) => a + b, 0) / values.length;\n  }\n\n  /**\n   * Calculate health score (0-100)\n   */\n  private calculateHealthScore(metrics: E2BSwarmMetrics): number {\n    let score = 100;\n\n    // Penalize high error rate\n    score -= metrics.errorRate * 50;\n\n    // Penalize very high or very low utilization\n    const avgUtil = this.calculateAverageUtilization(metrics);\n    if (avgUtil > 0.9) score -= 10;\n    if (avgUtil < 0.1 && metrics.totalAgents > 0) score -= 5;\n\n    // Penalize no agents\n    if (metrics.totalAgents === 0) score -= 30;\n\n    // Penalize all agents busy\n    if (metrics.activeAgents === metrics.totalAgents && metrics.totalAgents > 0) score -= 10;\n\n    return Math.max(0, Math.min(100, score));\n  }\n\n  /**\n   * Get optimization history\n   */\n  getHistory(): OptimizationReport[] {\n    return [...this.optimizationHistory];\n  }\n\n  /**\n   * Get current health score\n   */\n  getHealthScore(): number {\n    return this.calculateHealthScore(this.swarm.getMetrics());\n  }\n\n  /**\n   * Get optimization summary\n   */\n  getSummary(): {\n    healthScore: number;\n    totalOptimizations: number;\n    lastOptimization: number | null;\n    actionsApplied: number;\n    currentMetrics: E2BSwarmMetrics;\n  } {\n    const lastReport = this.optimizationHistory[this.optimizationHistory.length - 1];\n    return {\n      healthScore: this.getHealthScore(),\n      totalOptimizations: this.optimizationHistory.length,\n      lastOptimization: lastReport?.timestamp || null,\n      actionsApplied: this.optimizationHistory.reduce((sum, r) => sum + r.actionsApplied.length, 0),\n      currentMetrics: this.swarm.getMetrics()\n    };\n  }\n}\n\n/**\n * Create optimizer for a swarm\n */\nexport function createSwarmOptimizer(\n  swarm: E2BSwarmOrchestrator,\n  config?: Partial<OptimizationConfig>\n): E2BSwarmOptimizer {\n  return new E2BSwarmOptimizer(swarm, config);\n}\n\n/**\n * Quick optimization pass\n */\nexport async function optimizeSwarm(swarm: E2BSwarmOrchestrator): Promise<OptimizationReport> {\n  const optimizer = createSwarmOptimizer(swarm);\n  return optimizer.optimize();\n}\n"]}
{"version":3,"file":"security.js","sourceRoot":"","sources":["../../src/sdk/security.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Security Module - Comprehensive security hardening for SDK operations\n *\n * Provides:\n * - Input validation and sanitization\n * - Rate limiting\n * - Audit logging\n * - Secret detection\n * - Path traversal protection\n * - Command injection prevention\n */\n\nimport { logger } from \"../utils/logger.js\";\nimport { existsSync, appendFileSync, mkdirSync } from \"fs\";\nimport { join, resolve, normalize, dirname } from \"path\";\nimport { homedir } from \"os\";\nimport { createHash, randomBytes } from \"crypto\";\n\n// =============================================================================\n// Input Validation\n// =============================================================================\n\n/**\n * Validate and sanitize file paths\n */\nexport function sanitizePath(inputPath: string, allowedBases: string[] = [process.cwd()]): string | null {\n  if (!inputPath || typeof inputPath !== 'string') {\n    return null;\n  }\n\n  // Normalize the path\n  const normalizedPath = normalize(resolve(inputPath));\n\n  // Check for null bytes (path traversal attack)\n  if (inputPath.includes('\\0')) {\n    logger.warn('Null byte detected in path', { path: inputPath });\n    return null;\n  }\n\n  // Check for path traversal attempts\n  if (inputPath.includes('..')) {\n    const resolved = resolve(inputPath);\n    const isWithinAllowed = allowedBases.some(base =>\n      resolved.startsWith(resolve(base))\n    );\n\n    if (!isWithinAllowed) {\n      logger.warn('Path traversal attempt blocked', { path: inputPath });\n      return null;\n    }\n  }\n\n  // Verify the path is within allowed bases\n  const isAllowed = allowedBases.some(base =>\n    normalizedPath.startsWith(resolve(base))\n  );\n\n  if (!isAllowed) {\n    logger.warn('Path outside allowed directories', { path: normalizedPath, allowed: allowedBases });\n    return null;\n  }\n\n  return normalizedPath;\n}\n\n/**\n * Validate command for injection attacks\n */\nexport function validateCommand(command: string): { valid: boolean; reason?: string } {\n  if (!command || typeof command !== 'string') {\n    return { valid: false, reason: 'Command must be a non-empty string' };\n  }\n\n  // Check for command chaining/injection patterns\n  const dangerousPatterns = [\n    /;\\s*rm\\s/i,           // Command chaining with rm\n    /\\|\\s*sh\\b/i,          // Piping to shell\n    /\\|\\s*bash\\b/i,        // Piping to bash\n    /`[^`]+`/,             // Backtick command substitution\n    /\\$\\([^)]*\\beval\\b/,   // Eval in command substitution\n    />\\s*\\/dev\\/sd[a-z]/i, // Writing to block devices\n    /&&\\s*rm\\s+-rf/i,      // Chained destructive rm\n    /\\|\\|\\s*rm\\s+-rf/i,    // OR chained destructive rm\n    /\\bnc\\s+-[elp]/i,      // Netcat reverse shell flags\n    /\\bcurl\\b.*\\|\\s*\\w+sh/i, // Curl pipe to shell\n    /\\bwget\\b.*\\|\\s*\\w+sh/i, // Wget pipe to shell\n    />\\s*~\\/.bashrc/i,     // Writing to shell config\n    />\\s*~\\/.profile/i,    // Writing to profile\n    />\\s*\\/etc\\//i,        // Writing to /etc\n    /\\bsudo\\s/i,           // Sudo escalation\n    /\\bchmod\\s+[0-7]*7[0-7]*/i, // World-writable permissions\n  ];\n\n  for (const pattern of dangerousPatterns) {\n    if (pattern.test(command)) {\n      return { valid: false, reason: `Dangerous pattern detected: ${pattern.source}` };\n    }\n  }\n\n  // Check command length\n  if (command.length > 10000) {\n    return { valid: false, reason: 'Command too long (max 10000 chars)' };\n  }\n\n  return { valid: true };\n}\n\n/**\n * Sanitize user input for logging\n */\nexport function sanitizeForLog(input: any, maxLength: number = 1000): string {\n  if (input === null || input === undefined) {\n    return 'null';\n  }\n\n  let str = typeof input === 'string' ? input : JSON.stringify(input);\n\n  // Truncate\n  if (str.length > maxLength) {\n    str = str.substring(0, maxLength) + '...[truncated]';\n  }\n\n  // Remove potential secrets\n  str = redactSecrets(str);\n\n  return str;\n}\n\n// =============================================================================\n// Secret Detection\n// =============================================================================\n\n/**\n * Patterns that indicate potential secrets\n */\nconst SECRET_PATTERNS = [\n  // API Keys\n  { pattern: /sk-[a-zA-Z0-9]{20,}/g, replacement: 'sk-***REDACTED***' },\n  { pattern: /api[_-]?key['\":\\s]*[a-zA-Z0-9]{20,}/gi, replacement: 'api_key=***REDACTED***' },\n  { pattern: /bearer\\s+[a-zA-Z0-9._-]{20,}/gi, replacement: 'bearer ***REDACTED***' },\n\n  // Anthropic/OpenAI\n  { pattern: /sk-ant-[a-zA-Z0-9-]{20,}/g, replacement: 'sk-ant-***REDACTED***' },\n  { pattern: /sk-proj-[a-zA-Z0-9-]{20,}/g, replacement: 'sk-proj-***REDACTED***' },\n\n  // AWS\n  { pattern: /AKIA[0-9A-Z]{16}/g, replacement: 'AKIA***REDACTED***' },\n  { pattern: /aws[_-]?secret['\":\\s]*[a-zA-Z0-9/+=]{40}/gi, replacement: 'aws_secret=***REDACTED***' },\n\n  // GitHub\n  { pattern: /ghp_[a-zA-Z0-9]{36}/g, replacement: 'ghp_***REDACTED***' },\n  { pattern: /github_pat_[a-zA-Z0-9_]{22,}/g, replacement: 'github_pat_***REDACTED***' },\n\n  // Generic tokens/passwords\n  { pattern: /password['\":\\s]*[^\\s'\"]{8,}/gi, replacement: 'password=***REDACTED***' },\n  { pattern: /token['\":\\s]*[a-zA-Z0-9._-]{20,}/gi, replacement: 'token=***REDACTED***' },\n  { pattern: /secret['\":\\s]*[a-zA-Z0-9._-]{20,}/gi, replacement: 'secret=***REDACTED***' },\n\n  // Private keys\n  { pattern: /-----BEGIN [A-Z]+ PRIVATE KEY-----[\\s\\S]*?-----END [A-Z]+ PRIVATE KEY-----/g, replacement: '***PRIVATE_KEY_REDACTED***' },\n\n  // Database URLs\n  { pattern: /postgres:\\/\\/[^@]+@[^\\s]+/gi, replacement: 'postgres://***REDACTED***' },\n  { pattern: /mysql:\\/\\/[^@]+@[^\\s]+/gi, replacement: 'mysql://***REDACTED***' },\n  { pattern: /mongodb(\\+srv)?:\\/\\/[^@]+@[^\\s]+/gi, replacement: 'mongodb://***REDACTED***' },\n];\n\n/**\n * Redact secrets from a string\n */\nexport function redactSecrets(text: string): string {\n  let result = text;\n\n  for (const { pattern, replacement } of SECRET_PATTERNS) {\n    result = result.replace(pattern, replacement);\n  }\n\n  return result;\n}\n\n/**\n * Check if text contains potential secrets\n */\nexport function containsSecrets(text: string): boolean {\n  for (const { pattern } of SECRET_PATTERNS) {\n    if (pattern.test(text)) {\n      // Reset lastIndex for global patterns\n      pattern.lastIndex = 0;\n      return true;\n    }\n    pattern.lastIndex = 0;\n  }\n  return false;\n}\n\n// =============================================================================\n// Rate Limiting\n// =============================================================================\n\ninterface RateLimitEntry {\n  count: number;\n  resetTime: number;\n}\n\nconst rateLimitStore = new Map<string, RateLimitEntry>();\n\n/**\n * Rate limit configuration\n */\nexport interface RateLimitConfig {\n  maxRequests: number;\n  windowMs: number;\n}\n\n/**\n * Check rate limit\n */\nexport function checkRateLimit(key: string, config: RateLimitConfig): { allowed: boolean; remaining: number; resetIn: number } {\n  const now = Date.now();\n  const entry = rateLimitStore.get(key);\n\n  if (!entry || now > entry.resetTime) {\n    // New window\n    rateLimitStore.set(key, {\n      count: 1,\n      resetTime: now + config.windowMs\n    });\n    return { allowed: true, remaining: config.maxRequests - 1, resetIn: config.windowMs };\n  }\n\n  if (entry.count >= config.maxRequests) {\n    return { allowed: false, remaining: 0, resetIn: entry.resetTime - now };\n  }\n\n  entry.count++;\n  return { allowed: true, remaining: config.maxRequests - entry.count, resetIn: entry.resetTime - now };\n}\n\n/**\n * Create a rate limiter function\n */\nexport function createRateLimiter(config: RateLimitConfig): (key: string) => boolean {\n  return (key: string) => checkRateLimit(key, config).allowed;\n}\n\n// =============================================================================\n// Audit Logging\n// =============================================================================\n\n/**\n * Audit log entry\n */\nexport interface AuditLogEntry {\n  timestamp: string;\n  event: string;\n  actor: string;\n  resource: string;\n  action: string;\n  outcome: 'success' | 'failure' | 'blocked';\n  details?: Record<string, any>;\n  ip?: string;\n  sessionId?: string;\n}\n\n// Audit log path\nconst AUDIT_LOG_DIR = join(homedir(), '.agentic-flow', 'audit');\nconst AUDIT_LOG_FILE = join(AUDIT_LOG_DIR, 'security.log');\n\n/**\n * Write audit log entry\n */\nexport function auditLog(entry: Omit<AuditLogEntry, 'timestamp'>): void {\n  const fullEntry: AuditLogEntry = {\n    ...entry,\n    timestamp: new Date().toISOString()\n  };\n\n  // Log to application logger\n  logger.info('Security audit', fullEntry);\n\n  // Write to audit file\n  try {\n    if (!existsSync(AUDIT_LOG_DIR)) {\n      mkdirSync(AUDIT_LOG_DIR, { recursive: true });\n    }\n    appendFileSync(AUDIT_LOG_FILE, JSON.stringify(fullEntry) + '\\n');\n  } catch (error) {\n    logger.warn('Failed to write audit log', { error: (error as Error).message });\n  }\n}\n\n/**\n * Audit tool usage\n */\nexport function auditToolUsage(\n  toolName: string,\n  input: any,\n  outcome: 'success' | 'failure' | 'blocked',\n  sessionId?: string\n): void {\n  auditLog({\n    event: 'tool_usage',\n    actor: 'agent',\n    resource: toolName,\n    action: 'execute',\n    outcome,\n    details: { input: sanitizeForLog(input, 500) },\n    sessionId\n  });\n}\n\n/**\n * Audit permission decision\n */\nexport function auditPermissionDecision(\n  toolName: string,\n  decision: 'allow' | 'deny',\n  reason: string,\n  sessionId?: string\n): void {\n  auditLog({\n    event: 'permission_decision',\n    actor: 'permission_handler',\n    resource: toolName,\n    action: decision,\n    outcome: decision === 'allow' ? 'success' : 'blocked',\n    details: { reason },\n    sessionId\n  });\n}\n\n// =============================================================================\n// Security Context\n// =============================================================================\n\n/**\n * Security context for a session\n */\nexport interface SecurityContext {\n  sessionId: string;\n  allowedPaths: string[];\n  allowedCommands: string[];\n  blockedPatterns: RegExp[];\n  rateLimit: RateLimitConfig;\n  auditEnabled: boolean;\n}\n\n/**\n * Default security context\n */\nexport function getDefaultSecurityContext(): SecurityContext {\n  return {\n    sessionId: randomBytes(16).toString('hex'),\n    allowedPaths: [\n      process.cwd(),\n      '/tmp',\n      join(homedir(), '.agentic-flow')\n    ],\n    allowedCommands: [\n      'ls', 'cat', 'head', 'tail', 'grep', 'find', 'wc',\n      'git', 'npm', 'node', 'python', 'python3',\n      'echo', 'pwd', 'date', 'which', 'env'\n    ],\n    blockedPatterns: [\n      /rm\\s+-rf\\s+[\\/~]/,\n      /chmod\\s+777/,\n      /curl.*\\|\\s*bash/,\n      /wget.*\\|\\s*sh/,\n      />\\s*\\/etc\\//\n    ],\n    rateLimit: {\n      maxRequests: 100,\n      windowMs: 60000 // 1 minute\n    },\n    auditEnabled: true\n  };\n}\n\n/**\n * Validate operation against security context\n */\nexport function validateOperation(\n  operation: 'read' | 'write' | 'execute',\n  target: string,\n  context: SecurityContext\n): { allowed: boolean; reason?: string } {\n  // Check rate limit\n  const rateCheck = checkRateLimit(`${context.sessionId}:${operation}`, context.rateLimit);\n  if (!rateCheck.allowed) {\n    return { allowed: false, reason: `Rate limit exceeded. Reset in ${Math.ceil(rateCheck.resetIn / 1000)}s` };\n  }\n\n  // Check path for read/write\n  if (operation === 'read' || operation === 'write') {\n    const sanitized = sanitizePath(target, context.allowedPaths);\n    if (!sanitized) {\n      return { allowed: false, reason: 'Path not allowed or invalid' };\n    }\n  }\n\n  // Check command for execute\n  if (operation === 'execute') {\n    const validation = validateCommand(target);\n    if (!validation.valid) {\n      return { allowed: false, reason: validation.reason };\n    }\n\n    // Check against blocked patterns\n    for (const pattern of context.blockedPatterns) {\n      if (pattern.test(target)) {\n        return { allowed: false, reason: `Blocked pattern: ${pattern.source}` };\n      }\n    }\n  }\n\n  // Audit if enabled\n  if (context.auditEnabled) {\n    auditLog({\n      event: 'operation_validated',\n      actor: 'security_context',\n      resource: target,\n      action: operation,\n      outcome: 'success',\n      sessionId: context.sessionId\n    });\n  }\n\n  return { allowed: true };\n}\n\n// =============================================================================\n// Secure Hash\n// =============================================================================\n\n/**\n * Create secure hash of content\n */\nexport function secureHash(content: string, algorithm: 'sha256' | 'sha512' = 'sha256'): string {\n  return createHash(algorithm).update(content).digest('hex');\n}\n\n/**\n * Generate secure random token\n */\nexport function generateSecureToken(length: number = 32): string {\n  return randomBytes(length).toString('hex');\n}\n\n// =============================================================================\n// Exports\n// =============================================================================\n\nexport {\n  SECRET_PATTERNS,\n  AUDIT_LOG_DIR,\n  AUDIT_LOG_FILE\n};\n"]}
{"version":3,"file":"permission-handler.js","sourceRoot":"","sources":["../../src/sdk/permission-handler.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * SDK Permission Handler - Custom permission control for Claude Agent SDK\n *\n * Provides fine-grained permission control beyond simple bypass mode,\n * including dangerous command blocking, directory restrictions, and audit logging.\n */\n\nimport { logger } from \"../utils/logger.js\";\nimport { existsSync, appendFileSync } from \"fs\";\nimport { join, resolve, dirname } from \"path\";\nimport { homedir } from \"os\";\n\n/**\n * Permission result from canUseTool\n */\nexport interface PermissionResult {\n  behavior: 'allow' | 'deny';\n  updatedInput?: any;\n  message?: string;\n  interrupt?: boolean;\n}\n\n/**\n * Tool input type (generic)\n */\nexport type ToolInput = Record<string, unknown>;\n\n/**\n * Permission handler options\n */\nexport interface PermissionHandlerOptions {\n  signal: AbortSignal;\n  suggestions?: Array<{\n    type: string;\n    rules?: Array<{ toolName: string; ruleContent?: string }>;\n    behavior?: string;\n    destination?: string;\n  }>;\n}\n\n// Dangerous command patterns to block\nconst DANGEROUS_PATTERNS = [\n  // Destructive file operations\n  /rm\\s+-rf\\s+[\\/~]/,\n  /rm\\s+-rf\\s+\\*/,\n  /rm\\s+--no-preserve-root/,\n\n  // Permission changes\n  /chmod\\s+777\\s+\\//,\n  /chown\\s+-R.*\\s+\\//,\n\n  // Remote code execution\n  /curl.*\\|\\s*(bash|sh|zsh)/,\n  /wget.*\\|\\s*(bash|sh|zsh)/,\n  /curl.*-o\\s*\\/tmp.*&&.*bash/,\n\n  // Dangerous evals (only match explicit eval with strings, not general command substitution)\n  /eval\\s+['\"`]/,\n  /\\$\\([^)]*rm\\s/,  // Only block command substitution containing rm\n  /\\$\\([^)]*curl.*\\|/,  // Block curl piped inside substitution\n\n  // SQL injection patterns\n  /DROP\\s+TABLE/i,\n  /DELETE\\s+FROM.*WHERE\\s+1\\s*=\\s*1/i,\n  /TRUNCATE\\s+TABLE/i,\n\n  // System damage\n  /mkfs\\./,\n  /dd\\s+if=.*of=\\/dev/,\n  /shutdown\\s/,\n  /reboot\\s/,\n\n  // Dangerous git operations\n  /git\\s+push\\s+.*--force/,\n  /git\\s+push\\s+-f\\s/,\n  /git\\s+reset\\s+--hard\\s+origin/,\n\n  // Package publishing (require explicit confirmation)\n  /npm\\s+publish/,\n\n  // Credential exposure\n  /cat.*\\.env\\b/,\n  /cat.*credentials/i,\n  /cat.*\\.ssh\\/id_/,\n];\n\n// File path patterns to block\nconst BLOCKED_PATHS = [\n  /^\\/etc\\/passwd$/,\n  /^\\/etc\\/shadow$/,\n  /^\\/etc\\/sudoers/,\n  /\\.ssh\\/id_/,\n  /\\.aws\\/credentials/,\n  /\\.env$/,\n  /\\.env\\.local$/,\n  /\\.env\\.production$/,\n];\n\n// Allowed directories (relative to cwd by default)\nlet allowedDirectories: string[] = [];\n\n/**\n * Initialize permission handler with allowed directories\n */\nexport function initPermissionHandler(dirs?: string[]): void {\n  allowedDirectories = dirs || [\n    process.cwd(),\n    '/tmp',\n    '/var/tmp',\n    join(homedir(), '.agentic-flow')\n  ];\n\n  logger.info('Permission handler initialized', { allowedDirs: allowedDirectories.length });\n}\n\n// Initialize with defaults\ninitPermissionHandler();\n\n/**\n * Check if a path is in allowed directories\n */\nfunction isPathAllowed(filePath: string): boolean {\n  if (!filePath) return true;\n\n  const resolvedPath = resolve(filePath);\n\n  // Check against blocked patterns\n  for (const pattern of BLOCKED_PATHS) {\n    if (pattern.test(resolvedPath)) {\n      return false;\n    }\n  }\n\n  // Check if in allowed directories\n  return allowedDirectories.some(dir => resolvedPath.startsWith(resolve(dir)));\n}\n\n/**\n * Check if a command contains dangerous patterns\n */\nfunction isDangerousCommand(command: string): { dangerous: boolean; pattern?: string } {\n  if (!command) return { dangerous: false };\n\n  for (const pattern of DANGEROUS_PATTERNS) {\n    if (pattern.test(command)) {\n      return { dangerous: true, pattern: pattern.source };\n    }\n  }\n\n  return { dangerous: false };\n}\n\n/**\n * Log permission decision for audit\n */\nfunction logPermissionDecision(\n  toolName: string,\n  input: ToolInput,\n  decision: 'allow' | 'deny',\n  reason?: string\n): void {\n  const logEntry = {\n    timestamp: new Date().toISOString(),\n    tool: toolName,\n    decision,\n    reason,\n    input: JSON.stringify(input).substring(0, 500) // Truncate for safety\n  };\n\n  logger.info('Permission decision', logEntry);\n\n  // Optionally write to audit log file\n  const auditLogPath = join(process.cwd(), '.agentic-flow', 'audit.log');\n  try {\n    const dir = dirname(auditLogPath);\n    if (existsSync(dir)) {\n      appendFileSync(auditLogPath, JSON.stringify(logEntry) + '\\n');\n    }\n  } catch (e) {\n    // Silently fail if can't write audit log\n  }\n}\n\n/**\n * Custom permission handler for Claude Agent SDK\n *\n * This replaces the simple 'bypassPermissions' mode with intelligent permission control\n */\nexport async function customPermissionHandler(\n  toolName: string,\n  input: ToolInput,\n  options: PermissionHandlerOptions\n): Promise<PermissionResult> {\n  // Always allow read-only tools\n  const readOnlyTools = ['Read', 'Glob', 'Grep', 'WebSearch', 'WebFetch', 'TodoWrite'];\n  if (readOnlyTools.includes(toolName)) {\n    logPermissionDecision(toolName, input, 'allow', 'read-only tool');\n    return { behavior: 'allow', updatedInput: input };\n  }\n\n  // Check Bash commands\n  if (toolName === 'Bash') {\n    const command = (input as any).command || '';\n    const { dangerous, pattern } = isDangerousCommand(command);\n\n    if (dangerous) {\n      logPermissionDecision(toolName, input, 'deny', `dangerous pattern: ${pattern}`);\n      return {\n        behavior: 'deny',\n        message: `Dangerous command blocked: matches pattern \"${pattern}\"`,\n        interrupt: false\n      };\n    }\n\n    logPermissionDecision(toolName, input, 'allow', 'command safe');\n    return { behavior: 'allow', updatedInput: input };\n  }\n\n  // Check file operations\n  if (['Write', 'Edit', 'NotebookEdit'].includes(toolName)) {\n    const filePath = (input as any).file_path || (input as any).notebook_path || '';\n\n    if (!isPathAllowed(filePath)) {\n      logPermissionDecision(toolName, input, 'deny', `path not allowed: ${filePath}`);\n      return {\n        behavior: 'deny',\n        message: `File access not allowed: ${filePath}`,\n        interrupt: false\n      };\n    }\n\n    logPermissionDecision(toolName, input, 'allow', 'path allowed');\n    return { behavior: 'allow', updatedInput: input };\n  }\n\n  // Check MCP resource operations\n  if (['ListMcpResources', 'ReadMcpResource'].includes(toolName)) {\n    logPermissionDecision(toolName, input, 'allow', 'MCP resource access');\n    return { behavior: 'allow', updatedInput: input };\n  }\n\n  // Check background shell operations\n  if (['KillBash', 'BashOutput'].includes(toolName)) {\n    logPermissionDecision(toolName, input, 'allow', 'shell control');\n    return { behavior: 'allow', updatedInput: input };\n  }\n\n  // Task tool for subagents - always allow\n  if (toolName === 'Task') {\n    logPermissionDecision(toolName, input, 'allow', 'subagent task');\n    return { behavior: 'allow', updatedInput: input };\n  }\n\n  // AskUserQuestion - always allow (interactive)\n  if (toolName === 'AskUserQuestion') {\n    logPermissionDecision(toolName, input, 'allow', 'user interaction');\n    return { behavior: 'allow', updatedInput: input };\n  }\n\n  // ExitPlanMode - always allow\n  if (toolName === 'ExitPlanMode') {\n    logPermissionDecision(toolName, input, 'allow', 'plan mode control');\n    return { behavior: 'allow', updatedInput: input };\n  }\n\n  // Default: allow with logging\n  logPermissionDecision(toolName, input, 'allow', 'default allow');\n  return { behavior: 'allow', updatedInput: input };\n}\n\n/**\n * Strict permission handler - more restrictive, blocks more operations\n */\nexport async function strictPermissionHandler(\n  toolName: string,\n  input: ToolInput,\n  options: PermissionHandlerOptions\n): Promise<PermissionResult> {\n  // Only allow read operations by default\n  const allowedTools = ['Read', 'Glob', 'Grep', 'WebSearch', 'TodoWrite'];\n\n  if (!allowedTools.includes(toolName)) {\n    logPermissionDecision(toolName, input, 'deny', 'strict mode - tool not allowed');\n    return {\n      behavior: 'deny',\n      message: `Tool ${toolName} not allowed in strict mode`,\n      interrupt: false\n    };\n  }\n\n  return customPermissionHandler(toolName, input, options);\n}\n\n/**\n * Get permission handler by mode\n */\nexport function getPermissionHandler(\n  mode: 'default' | 'strict' | 'bypass'\n): ((toolName: string, input: ToolInput, options: PermissionHandlerOptions) => Promise<PermissionResult>) | undefined {\n  switch (mode) {\n    case 'default':\n      return customPermissionHandler;\n    case 'strict':\n      return strictPermissionHandler;\n    case 'bypass':\n      return undefined; // No handler = bypass all permissions\n    default:\n      return customPermissionHandler;\n  }\n}\n"]}
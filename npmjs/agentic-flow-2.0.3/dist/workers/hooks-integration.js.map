{"version":3,"file":"hooks-integration.js","sourceRoot":"","sources":["../../src/workers/hooks-integration.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Hooks Integration for Background Workers\n * Integrates with Claude Code's hook system and SDK\n */\n\nimport { getWorkerDispatchService, WorkerDispatchService } from './dispatch-service.js';\nimport { getTriggerDetector, TriggerDetector } from './trigger-detector.js';\nimport { getWorkerRegistry, WorkerRegistry } from './worker-registry.js';\nimport { getResourceGovernor, ResourceGovernor } from './resource-governor.js';\nimport { WorkerInfo, WorkerTrigger, ContextInjection, SearchResult } from './types.js';\n\n// Hook event types from SDK\nexport type HookEvent =\n  | 'PreToolUse'\n  | 'PostToolUse'\n  | 'PostToolUseFailure'\n  | 'UserPromptSubmit'\n  | 'SessionStart'\n  | 'SessionEnd'\n  | 'Notification';\n\nexport interface HookInput {\n  hook_event_name: string;\n  session_id: string;\n  transcript_path?: string;\n  cwd?: string;\n  [key: string]: unknown;\n}\n\nexport interface UserPromptSubmitInput extends HookInput {\n  hook_event_name: 'UserPromptSubmit';\n  prompt: string;\n}\n\nexport interface HookOutput {\n  continue?: boolean;\n  suppressOutput?: boolean;\n  decision?: 'approve' | 'block';\n  systemMessage?: string;\n  reason?: string;\n  hookSpecificOutput?: {\n    hookEventName: string;\n    additionalContext?: string;\n    [key: string]: unknown;\n  };\n}\n\nexport type HookCallback = (\n  input: HookInput,\n  toolUseId: string | undefined,\n  options: { signal: AbortSignal }\n) => Promise<HookOutput>;\n\n/**\n * UserPromptSubmit hook for background worker dispatch\n * Detects triggers and spawns workers in background\n */\nexport const userPromptSubmitWorkerHook: HookCallback = async (input, _toolUseId, { signal }) => {\n  if (input.hook_event_name !== 'UserPromptSubmit') return {};\n\n  const { prompt, session_id } = input as UserPromptSubmitInput;\n  if (!prompt) return {};\n\n  try {\n    const detector = getTriggerDetector();\n\n    // Fast check if any triggers present\n    if (!detector.hasTriggers(prompt)) {\n      return {};\n    }\n\n    const dispatcher = getWorkerDispatchService();\n    const { triggers, workerIds } = await dispatcher.dispatchFromPrompt(prompt, session_id);\n\n    if (triggers.length === 0) {\n      return {};\n    }\n\n    // Format message for user feedback\n    const workerList = triggers.map((t, i) =>\n      `${t.keyword}${t.topic ? `: \"${t.topic}\"` : ''}`\n    ).join(', ');\n\n    return {\n      hookSpecificOutput: {\n        hookEventName: 'UserPromptSubmit',\n        additionalContext: `\\u26A1 Background workers spawned: ${workerList}`,\n        workersSpawned: workerIds,\n        triggers: triggers.map(t => t.keyword)\n      }\n    };\n  } catch (error) {\n    // Silent failure - don't block conversation\n    console.warn('Worker dispatch hook error:', error);\n    return {};\n  }\n};\n\n/**\n * Context injection hook\n * Searches completed worker results and injects relevant context\n */\nexport const contextInjectionHook: HookCallback = async (input, _toolUseId, { signal }) => {\n  if (input.hook_event_name !== 'UserPromptSubmit') return {};\n\n  const { prompt, session_id } = input as UserPromptSubmitInput;\n  if (!prompt) return {};\n\n  try {\n    const context = await getRelevantWorkerContext(prompt, session_id);\n\n    if (!context || context.context.length === 0) {\n      return {};\n    }\n\n    return {\n      hookSpecificOutput: {\n        hookEventName: 'UserPromptSubmit',\n        additionalContext: formatContextForInjection(context),\n        backgroundContext: context\n      }\n    };\n  } catch (error) {\n    // Silent failure\n    return {};\n  }\n};\n\n/**\n * Session start hook - restore worker context\n */\nexport const sessionStartWorkerHook: HookCallback = async (input, _toolUseId, { signal }) => {\n  if (input.hook_event_name !== 'SessionStart') return {};\n\n  const { session_id } = input;\n\n  try {\n    const registry = getWorkerRegistry();\n    const activeWorkers = registry.getActive(session_id as string);\n    const completedWorkers = registry.getAll({\n      sessionId: session_id as string,\n      status: 'complete',\n      limit: 10\n    });\n\n    if (activeWorkers.length === 0 && completedWorkers.length === 0) {\n      return {};\n    }\n\n    const message = [\n      activeWorkers.length > 0 ? `${activeWorkers.length} active workers` : '',\n      completedWorkers.length > 0 ? `${completedWorkers.length} completed` : ''\n    ].filter(Boolean).join(', ');\n\n    return {\n      hookSpecificOutput: {\n        hookEventName: 'SessionStart',\n        additionalContext: `Background workers: ${message}`,\n        activeWorkers: activeWorkers.map(w => w.id),\n        completedWorkers: completedWorkers.map(w => w.id)\n      }\n    };\n  } catch (error) {\n    return {};\n  }\n};\n\n/**\n * Session end hook - cleanup and persist\n */\nexport const sessionEndWorkerHook: HookCallback = async (input, _toolUseId, { signal }) => {\n  if (input.hook_event_name !== 'SessionEnd') return {};\n\n  const { session_id } = input;\n\n  try {\n    const governor = getResourceGovernor();\n    const registry = getWorkerRegistry();\n\n    // Cancel any running workers for this session\n    const activeWorkers = governor.getActiveWorkers()\n      .filter(w => w.sessionId === session_id);\n\n    for (const worker of activeWorkers) {\n      governor.forceCleanup(worker.id);\n    }\n\n    // Cleanup old records\n    registry.cleanup(24 * 60 * 60 * 1000); // 24 hours\n\n    return {};\n  } catch (error) {\n    return {};\n  }\n};\n\n/**\n * Get relevant worker context for a prompt\n */\nexport async function getRelevantWorkerContext(\n  prompt: string,\n  sessionId?: string\n): Promise<ContextInjection | null> {\n  const registry = getWorkerRegistry();\n\n  // Get completed workers\n  const completed = registry.getAll({\n    sessionId,\n    status: 'complete',\n    limit: 50\n  });\n\n  if (completed.length === 0) {\n    return null;\n  }\n\n  // Simple keyword matching for relevance\n  const keywords = prompt.toLowerCase()\n    .split(/\\s+/)\n    .filter(w => w.length > 3);\n\n  const scored: Array<{ worker: WorkerInfo; score: number }> = [];\n\n  for (const worker of completed) {\n    const workerText = `${worker.trigger} ${worker.topic || ''}`.toLowerCase();\n    let score = 0;\n\n    for (const keyword of keywords) {\n      if (workerText.includes(keyword)) {\n        score += 1;\n      }\n    }\n\n    // Boost recent workers\n    const age = Date.now() - (worker.completedAt || worker.createdAt);\n    const ageHours = age / (60 * 60 * 1000);\n    if (ageHours < 1) score += 0.5;\n    else if (ageHours < 24) score += 0.2;\n\n    if (score > 0) {\n      scored.push({ worker, score });\n    }\n  }\n\n  if (scored.length === 0) {\n    return null;\n  }\n\n  // Sort by score and take top 3\n  scored.sort((a, b) => b.score - a.score);\n  const relevant = scored.slice(0, 3);\n\n  return {\n    context: relevant.map(({ worker, score }) => ({\n      source: 'background-worker',\n      type: worker.trigger,\n      content: worker.topic || worker.trigger,\n      score: Math.min(1, score / keywords.length)\n    })),\n    source: 'background-worker',\n    confidence: relevant[0].score / keywords.length\n  };\n}\n\n/**\n * Format context for injection into prompt\n */\nfunction formatContextForInjection(context: ContextInjection): string {\n  const lines = context.context.map(c =>\n    `- ${c.type}${c.content !== c.type ? `: ${c.content}` : ''} (${Math.round(c.score * 100)}% relevant)`\n  );\n\n  return `Background analysis available:\\n${lines.join('\\n')}`;\n}\n\n/**\n * Get all worker hooks for SDK integration\n */\nexport function getWorkerHooks(): Partial<Record<HookEvent, Array<{ hooks: HookCallback[] }>>> {\n  return {\n    UserPromptSubmit: [\n      { hooks: [userPromptSubmitWorkerHook, contextInjectionHook] }\n    ],\n    SessionStart: [\n      { hooks: [sessionStartWorkerHook] }\n    ],\n    SessionEnd: [\n      { hooks: [sessionEndWorkerHook] }\n    ]\n  };\n}\n\n/**\n * Generate hooks configuration for .claude/settings.json\n */\nexport function generateHooksConfig(): object {\n  return {\n    hooks: {\n      UserPromptSubmit: [\n        {\n          hooks: [\n            {\n              type: 'command',\n              command: 'npx agentic-flow workers dispatch \"$USER_PROMPT\" --session \"$SESSION_ID\" --json 2>/dev/null || true',\n              timeout: 5000,\n              background: true\n            }\n          ]\n        }\n      ],\n      SessionEnd: [\n        {\n          hooks: [\n            {\n              type: 'command',\n              command: 'npx agentic-flow workers cleanup --age 24',\n              timeout: 3000\n            }\n          ]\n        }\n      ]\n    }\n  };\n}\n\n/**\n * Worker event emitter for external integration\n */\nexport class WorkerEventBridge {\n  private dispatcher: WorkerDispatchService;\n\n  constructor() {\n    this.dispatcher = getWorkerDispatchService();\n    this.setupEventForwarding();\n  }\n\n  private setupEventForwarding(): void {\n    this.dispatcher.on('worker:spawned', (data) => {\n      this.emit('spawned', data);\n    });\n\n    this.dispatcher.on('worker:progress', (data) => {\n      this.emit('progress', data);\n    });\n\n    this.dispatcher.on('worker:complete', (data) => {\n      this.emit('complete', data);\n    });\n\n    this.dispatcher.on('worker:error', (data) => {\n      this.emit('error', data);\n    });\n\n    this.dispatcher.on('worker:deposit', (data) => {\n      this.emit('deposit', data);\n    });\n  }\n\n  private emit(event: string, data: unknown): void {\n    // Emit to console for hook consumption\n    console.log(JSON.stringify({\n      type: 'worker-event',\n      event,\n      data,\n      timestamp: Date.now()\n    }));\n  }\n\n  /**\n   * Get dispatcher for direct access\n   */\n  getDispatcher(): WorkerDispatchService {\n    return this.dispatcher;\n  }\n}\n"]}
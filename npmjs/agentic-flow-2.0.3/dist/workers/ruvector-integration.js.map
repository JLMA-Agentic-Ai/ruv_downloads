{"version":3,"file":"ruvector-integration.js","sourceRoot":"","sources":["../../src/workers/ruvector-integration.ts"],"names":[],"mappings":"AAAA;;;;;;;;GAQG;AAEH,OAAO,EAAE,YAAY,EAAE,MAAM,QAAQ,CAAC;AAqCtC,MAAM,cAAc,GAAyB;IAC3C,UAAU,EAAE,IAAI;IAChB,mBAAmB,EAAE,IAAI;IACzB,UAAU,EAAE,IAAI;IAChB,WAAW,EAAE,OAAO;IACpB,YAAY,EAAE,GAAG;IACjB,KAAK,EAAE,EAAE;IACT,kBAAkB,EAAE,GAAG;IACvB,gBAAgB,EAAE,GAAG;CACtB,CAAC;AAwBF;;;GAGG;AACH,MAAM,OAAO,yBAA0B,SAAQ,YAAY;IACjD,MAAM,CAAuB;IAC7B,WAAW,GAAuB,IAAI,CAAC;IACvC,aAAa,GAA+B,IAAI,CAAC;IACjD,YAAY,GAAwB,IAAI,CAAC;IACzC,iBAAiB,GAA6B,IAAI,CAAC;IACnD,cAAc,GAA0B,IAAI,CAAC;IAC7C,WAAW,GAAG,KAAK,CAAC;IACpB,kBAAkB,GAMrB,IAAI,GAAG,EAAE,CAAC;IAEf,YAAY,SAAwC,EAAE;QACpD,KAAK,EAAE,CAAC;QACR,IAAI,CAAC,MAAM,GAAG,EAAE,GAAG,cAAc,EAAE,GAAG,MAAM,EAAE,CAAC;IACjD,CAAC;IAED;;;;OAIG;IACH,KAAK,CAAC,UAAU;QACd,IAAI,IAAI,CAAC,WAAW;YAAE,OAAO,IAAI,CAAC;QAElC,IAAI,CAAC;YACH,mEAAmE;YACnE,IAAI,CAAC;gBACH,MAAM,QAAQ,GAAG,MAAM,MAAM,CAAC,UAAU,CAAC,CAAC;gBAC1C,IAAI,CAAC,YAAY,GAAG,QAAQ,CAAC;gBAE7B,sCAAsC;gBACtC,IAAI,IAAI,CAAC,MAAM,CAAC,UAAU,IAAI,QAAQ,CAAC,UAAU,EAAE,CAAC;oBAClD,IAAI,CAAC;wBACH,iFAAiF;wBACjF,IAAI,CAAC,WAAW,GAAG,IAAK,QAAQ,CAAC,UAAkB,CAAC,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,CAAC;wBAC9E,IAAI,CAAC,IAAI,CAAC,eAAe,EAAE,EAAE,MAAM,EAAE,MAAM,EAAE,CAAC,CAAC;oBACjD,CAAC;oBAAC,OAAO,CAAC,EAAE,CAAC;wBACX,mBAAmB;oBACrB,CAAC;gBACH,CAAC;gBAED,iEAAiE;gBACjE,IAAI,IAAI,CAAC,MAAM,CAAC,mBAAmB,IAAI,QAAQ,CAAC,QAAQ,EAAE,CAAC;oBACzD,IAAI,CAAC;wBACH,+EAA+E;wBAC/E,IAAI,CAAC,aAAa,GAAG,IAAK,QAAQ,CAAC,QAAgB,CAAC;4BAClD,UAAU,EAAE,IAAI,CAAC,MAAM,CAAC,YAAY;4BACpC,WAAW,EAAE,0BAA0B;4BACvC,UAAU,EAAE;gCACV,cAAc,EAAE,IAAI,CAAC,MAAM,CAAC,kBAAkB;gCAC9C,CAAC,EAAE,IAAI,CAAC,MAAM,CAAC,KAAK;6BACrB;yBACF,CAAC,CAAC;wBACH,IAAI,CAAC,IAAI,CAAC,eAAe,EAAE,EAAE,MAAM,EAAE,eAAe,EAAE,CAAC,CAAC;oBAC1D,CAAC;oBAAC,OAAO,CAAC,EAAE,CAAC;wBACX,0DAA0D;oBAC5D,CAAC;gBACH,CAAC;gBAED,2BAA2B;gBAC3B,IAAI,IAAI,CAAC,MAAM,CAAC,UAAU,IAAI,IAAI,CAAC,aAAa,EAAE,CAAC;oBACjD,IAAI,CAAC,IAAI,CAAC,eAAe,EAAE,EAAE,MAAM,EAAE,MAAM,EAAE,CAAC,CAAC;gBACjD,CAAC;YACH,CAAC;YAAC,OAAO,CAAC,EAAE,CAAC;gBACX,2EAA2E;gBAC3E,2DAA2D;YAC7D,CAAC;YAED,qEAAqE;YACrE,IAAI,CAAC;gBACH,MAAM,SAAS,GAAG,MAAM,MAAM,CAAC,sCAAsC,CAAC,CAAC;gBACvE,IAAI,CAAC,iBAAiB,GAAG,SAAS,CAAC,oBAAoB,EAAE,EAAE,CAAC;gBAC5D,IAAI,CAAC,IAAI,CAAC,eAAe,EAAE,EAAE,MAAM,EAAE,cAAc,EAAE,CAAC,CAAC;YACzD,CAAC;YAAC,OAAO,CAAC,EAAE,CAAC;gBACX,iCAAiC;YACnC,CAAC;YAED,gEAAgE;YAChE,IAAI,CAAC;gBACH,MAAM,EAAE,qBAAqB,EAAE,GAAG,MAAM,MAAM,CAAC,yBAAyB,CAAC,CAAC;gBAC1E,IAAI,CAAC,cAAc,GAAG,MAAM,qBAAqB,EAAE,CAAC;gBACpD,IAAI,IAAI,CAAC,cAAc,EAAE,CAAC;oBACxB,IAAI,CAAC,IAAI,CAAC,eAAe,EAAE,EAAE,MAAM,EAAE,iBAAiB,EAAE,MAAM,EAAE,IAAI,EAAE,CAAC,CAAC;gBAC1E,CAAC;YACH,CAAC;YAAC,OAAO,CAAC,EAAE,CAAC;gBACX,+CAA+C;YACjD,CAAC;YAED,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC;YACxB,IAAI,CAAC,IAAI,CAAC,aAAa,EAAE;gBACvB,IAAI,EAAE,CAAC,CAAC,IAAI,CAAC,WAAW;gBACxB,aAAa,EAAE,CAAC,CAAC,IAAI,CAAC,aAAa;gBACnC,IAAI,EAAE,CAAC,CAAC,IAAI,CAAC,YAAY;gBACzB,YAAY,EAAE,CAAC,CAAC,IAAI,CAAC,iBAAiB;gBACtC,cAAc,EAAE,CAAC,CAAC,IAAI,CAAC,cAAc;aACtC,CAAC,CAAC;YAEH,OAAO,IAAI,CAAC;QACd,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,6DAA6D;YAC7D,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC;YACxB,IAAI,CAAC,IAAI,CAAC,aAAa,EAAE;gBACvB,IAAI,EAAE,KAAK;gBACX,aAAa,EAAE,KAAK;gBACpB,IAAI,EAAE,KAAK;gBACX,YAAY,EAAE,KAAK;gBACnB,cAAc,EAAE,KAAK;aACtB,CAAC,CAAC;YACH,OAAO,IAAI,CAAC,CAAC,mDAAmD;QAClE,CAAC;IACH,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,eAAe,CACnB,QAAgB,EAChB,OAAsB,EACtB,KAAoB;QAEpB,MAAM,IAAI,CAAC,UAAU,EAAE,CAAC;QAExB,MAAM,YAAY,GAAG,QAAQ,QAAQ,IAAI,IAAI,CAAC,GAAG,EAAE,EAAE,CAAC;QAEtD,8CAA8C;QAC9C,IAAI,SAA+B,CAAC;QACpC,IAAI,IAAI,CAAC,YAAY,IAAI,KAAK,EAAE,CAAC;YAC/B,IAAI,CAAC;gBACH,mDAAmD;gBACnD,SAAS,GAAG,MAAM,IAAI,CAAC,iBAAiB,CAAC,GAAG,OAAO,IAAI,KAAK,EAAE,CAAC,CAAC;YAClE,CAAC;YAAC,OAAO,CAAC,EAAE,CAAC;gBACX,wBAAwB;YAC1B,CAAC;QACH,CAAC;QAED,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,YAAY,EAAE;YACxC,QAAQ;YACR,OAAO;YACP,KAAK,EAAE,EAAE;YACT,SAAS,EAAE,IAAI,CAAC,GAAG,EAAE;YACrB,SAAS;SACV,CAAC,CAAC;QAEH,qCAAqC;QACrC,IAAI,IAAI,CAAC,WAAW,EAAE,CAAC;YACrB,IAAI,CAAC;gBACH,MAAM,IAAI,CAAC,WAAW,CAAC,eAAe,EAAE,CAAC,YAAY,EAAE;oBACrD,KAAK,EAAE,UAAU,OAAO,EAAE;oBAC1B,QAAQ,EAAE,CAAC,QAAQ,EAAE,KAAK,IAAI,SAAS,CAAC;oBACxC,SAAS;iBACV,CAAC,CAAC;YACL,CAAC;YAAC,OAAO,CAAC,EAAE,CAAC;gBACX,+BAA+B;YACjC,CAAC;QACH,CAAC;QAED,IAAI,CAAC,IAAI,CAAC,oBAAoB,EAAE,EAAE,YAAY,EAAE,QAAQ,EAAE,OAAO,EAAE,CAAC,CAAC;QACrE,OAAO,YAAY,CAAC;IACtB,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,UAAU,CACd,YAAoB,EACpB,KAAa,EACb,OAKC;QAED,MAAM,UAAU,GAAG,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC;QAC7D,IAAI,CAAC,UAAU;YAAE,OAAO;QAExB,uFAAuF;QACvF,MAAM,WAAW,GAAG,IAAI,CAAC,mBAAmB,CAAC,KAAK,EAAE,OAAO,CAAC,CAAC;QAE7D,MAAM,IAAI,GAAe;YACvB,KAAK;YACL,WAAW;YACX,QAAQ,EAAE,OAAO,CAAC,QAAQ;YAC1B,cAAc,EAAE,OAAO,CAAC,cAAc;YACtC,WAAW,EAAE,OAAO,CAAC,WAAW;SACjC,CAAC;QAEF,UAAU,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAE5B,gCAAgC;QAChC,IAAI,IAAI,CAAC,WAAW,EAAE,CAAC;YACrB,IAAI,CAAC;gBACH,MAAM,IAAI,CAAC,WAAW,CAAC,UAAU,EAAE,CAAC,YAAY,EAAE;oBAChD,WAAW;oBACX,gBAAgB,EAAE,WAAW,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;oBACnD,MAAM,EAAE,OAAO,CAAC,WAAW;oBAC3B,SAAS,EAAE,IAAI,CAAC,GAAG,EAAE;iBACtB,CAAC,CAAC;YACL,CAAC;YAAC,OAAO,CAAC,EAAE,CAAC;gBACX,cAAc;YAChB,CAAC;QACH,CAAC;QAED,IAAI,CAAC,IAAI,CAAC,eAAe,EAAE,EAAE,YAAY,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;IAC5D,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,kBAAkB,CACtB,YAAoB,EACpB,OAAsB;QAEtB,MAAM,UAAU,GAAG,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC;QAC7D,IAAI,CAAC,UAAU,EAAE,CAAC;YAChB,OAAO;gBACL,YAAY;gBACZ,YAAY,EAAE,CAAC;gBACf,eAAe,EAAE,CAAC;gBAClB,cAAc,EAAE,EAAE;gBAClB,cAAc,EAAE,KAAK;aACtB,CAAC;QACJ,CAAC;QAED,MAAM,QAAQ,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,UAAU,CAAC,SAAS,CAAC;QACnD,MAAM,YAAY,GAAG,IAAI,CAAC,qBAAqB,CAAC,UAAU,EAAE,OAAO,CAAC,CAAC;QACrE,IAAI,eAAe,GAAG,CAAC,CAAC;QACxB,MAAM,cAAc,GAAa,EAAE,CAAC;QACpC,IAAI,cAAc,GAAG,KAAK,CAAC;QAE3B,oDAAoD;QACpD,IAAI,IAAI,CAAC,aAAa,IAAI,YAAY,IAAI,IAAI,CAAC,MAAM,CAAC,gBAAgB,EAAE,CAAC;YACvE,IAAI,CAAC;gBACH,MAAM,SAAS,GAAG,UAAU,UAAU,CAAC,OAAO,IAAI,YAAY,EAAE,CAAC;gBAEjE,2BAA2B;gBAC3B,MAAM,IAAI,CAAC,YAAY,CAAC,SAAS,EAAE;oBACjC,OAAO,EAAE,UAAU,CAAC,OAAO;oBAC3B,KAAK,EAAE,UAAU,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,KAAK,CAAC;oBACzC,QAAQ;oBACR,YAAY;oBACZ,OAAO,EAAE,OAAO,CAAC,IAAI;iBACtB,CAAC,CAAC;gBAEH,cAAc,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;gBAC/B,eAAe,EAAE,CAAC;YACpB,CAAC;YAAC,OAAO,CAAC,EAAE,CAAC;gBACX,OAAO,CAAC,IAAI,CAAC,qCAAqC,EAAE,CAAC,CAAC,CAAC;YACzD,CAAC;QACH,CAAC;QAED,gDAAgD;QAChD,IAAI,IAAI,CAAC,WAAW,EAAE,CAAC;YACrB,IAAI,CAAC;gBACH,MAAM,IAAI,CAAC,WAAW,CAAC,aAAa,EAAE,CAAC,YAAY,EAAE,YAAY,CAAC,CAAC;gBAEnE,iCAAiC;gBACjC,IAAI,YAAY,IAAI,GAAG,EAAE,CAAC;oBACxB,MAAM,IAAI,CAAC,WAAW,CAAC,UAAU,EAAE,EAAE,CAAC;oBACtC,cAAc,GAAG,IAAI,CAAC;gBACxB,CAAC;YACH,CAAC;YAAC,OAAO,CAAC,EAAE,CAAC;gBACX,cAAc;YAChB,CAAC;QACH,CAAC;QAED,oCAAoC;QACpC,IAAI,IAAI,CAAC,YAAY,IAAI,UAAU,CAAC,SAAS,EAAE,CAAC;YAC9C,IAAI,CAAC;gBACH,MAAM,IAAI,CAAC,YAAY,CAAC,YAAY,EAAE,UAAU,CAAC,SAAS,EAAE;oBAC1D,OAAO,EAAE,UAAU,CAAC,OAAO;oBAC3B,YAAY;oBACZ,SAAS,EAAE,IAAI,CAAC,GAAG,EAAE;iBACtB,CAAC,CAAC;YACL,CAAC;YAAC,OAAO,CAAC,EAAE,CAAC;gBACX,cAAc;YAChB,CAAC;QACH,CAAC;QAED,UAAU;QACV,IAAI,CAAC,kBAAkB,CAAC,MAAM,CAAC,YAAY,CAAC,CAAC;QAE7C,MAAM,MAAM,GAAyB;YACnC,YAAY;YACZ,YAAY;YACZ,eAAe;YACf,cAAc;YACd,cAAc;SACf,CAAC;QAEF,IAAI,CAAC,IAAI,CAAC,sBAAsB,EAAE,MAAM,CAAC,CAAC;QAC1C,OAAO,MAAM,CAAC;IAChB,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,oBAAoB,CACxB,OAAsB,EACtB,KAAoB,EACpB,QAAgB,CAAC;QAMjB,MAAM,IAAI,CAAC,UAAU,EAAE,CAAC;QAExB,MAAM,QAAQ,GAIT,EAAE,CAAC;QAER,2BAA2B;QAC3B,IAAI,IAAI,CAAC,YAAY,IAAI,KAAK,EAAE,CAAC;YAC/B,IAAI,CAAC;gBACH,MAAM,SAAS,GAAG,MAAM,IAAI,CAAC,iBAAiB,CAAC,GAAG,OAAO,IAAI,KAAK,EAAE,CAAC,CAAC;gBACtE,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,UAAU,CAAC,SAAS,EAAE,KAAK,CAAC,CAAC;gBAExD,KAAK,MAAM,MAAM,IAAI,OAAO,EAAE,CAAC;oBAC7B,QAAQ,CAAC,IAAI,CAAC;wBACZ,GAAG,EAAE,MAAM,CAAC,EAAE;wBACd,UAAU,EAAE,MAAM,CAAC,UAAU;wBAC7B,OAAO,EAAE,MAAM,CAAC,QAAQ,IAAI,EAAE;qBAC/B,CAAC,CAAC;gBACL,CAAC;YACH,CAAC;YAAC,OAAO,CAAC,EAAE,CAAC;gBACX,4BAA4B;YAC9B,CAAC;QACH,CAAC;QAED,2BAA2B;QAC3B,IAAI,IAAI,CAAC,aAAa,IAAI,QAAQ,CAAC,MAAM,GAAG,KAAK,EAAE,CAAC;YAClD,IAAI,CAAC;gBACH,MAAM,UAAU,GAAG,MAAM,IAAI,CAAC,aAAa,CAAC,gBAAgB,EAAE,CAC5D,GAAG,OAAO,IAAI,KAAK,IAAI,EAAE,EAAE,EAC3B,EAAE,MAAM,EAAE,SAAS,EAAE,KAAK,EAAE,KAAK,GAAG,QAAQ,CAAC,MAAM,EAAE,CACtD,CAAC;gBAEF,IAAI,UAAU,EAAE,CAAC;oBACf,KAAK,MAAM,CAAC,IAAI,UAAU,EAAE,CAAC;wBAC3B,QAAQ,CAAC,IAAI,CAAC;4BACZ,GAAG,EAAE,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC,GAAG;4BAClB,UAAU,EAAE,CAAC,CAAC,KAAK,IAAI,GAAG;4BAC1B,OAAO,EAAE,CAAC,CAAC,OAAO,IAAI,CAAC;yBACxB,CAAC,CAAC;oBACL,CAAC;gBACH,CAAC;YACH,CAAC;YAAC,OAAO,CAAC,EAAE,CAAC;gBACX,cAAc;YAChB,CAAC;QACH,CAAC;QAED,OAAO,QAAQ,CAAC;IAClB,CAAC;IAED;;OAEG;IACK,KAAK,CAAC,YAAY,CACxB,GAAW,EACX,IAA6B;QAE7B,IAAI,CAAC,IAAI,CAAC,aAAa;YAAE,OAAO;QAEhC,IAAI,CAAC;YACH,2DAA2D;YAC3D,IAAI,IAAI,CAAC,aAAa,CAAC,eAAe,EAAE,CAAC;gBACvC,MAAM,IAAI,CAAC,aAAa,CAAC,eAAe,CACtC,IAAI,EACJ,EAAE,KAAK,EAAE,SAAS,EAAE,UAAU,EAAE,IAAI,CAAC,YAAsB,EAAE,EAC7D,gBAAgB,GAAG,EAAE,EACrB,EAAE,MAAM,EAAE,GAAG,EAAE,MAAM,EAAE,SAAS,EAAE,CACnC,CAAC;YACJ,CAAC;iBAAM,CAAC;gBACN,gCAAgC;gBAChC,MAAM,EAAE,GAAG,IAAI,CAAC,aAAa,CAAC,EAAE,CAAC;gBACjC,IAAI,EAAE,EAAE,YAAY,EAAE,CAAC;oBACrB,MAAM,EAAE,CAAC,YAAY,CAAC,GAAG,EAAE,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,EAAE,IAAI,CAAC,GAAG,EAAE,CAAC,CAAC;gBAC/D,CAAC;YACH,CAAC;QACH,CAAC;QAAC,OAAO,CAAC,EAAE,CAAC;YACX,OAAO,CAAC,IAAI,CAAC,oCAAoC,EAAE,CAAC,CAAC,CAAC;QACxD,CAAC;IACH,CAAC;IAED;;OAEG;IACK,KAAK,CAAC,YAAY,CACxB,EAAU,EACV,SAAmB,EACnB,QAAiC;QAEjC,IAAI,CAAC,IAAI,CAAC,YAAY;YAAE,OAAO;QAE/B,IAAI,CAAC;YACH,iEAAiE;YACjE,MAAM,KAAK,GAAG,IAAI,CAAC,YAAY,CAAC,QAAQ,EAAE,EAAE,IAAI,IAAI,CAAC,YAAY,CAAC;YAClE,IAAI,KAAK,CAAC,GAAG,EAAE,CAAC;gBACd,MAAM,KAAK,CAAC,GAAG,CAAC,EAAE,EAAE,SAAS,EAAE,QAAQ,CAAC,CAAC;YAC3C,CAAC;QACH,CAAC;QAAC,OAAO,CAAC,EAAE,CAAC;YACX,+BAA+B;QACjC,CAAC;IACH,CAAC;IAED;;OAEG;IACK,KAAK,CAAC,UAAU,CACtB,SAAmB,EACnB,KAAa;QAEb,IAAI,CAAC,IAAI,CAAC,YAAY;YAAE,OAAO,EAAE,CAAC;QAElC,IAAI,CAAC;YACH,MAAM,KAAK,GAAG,IAAI,CAAC,YAAY,CAAC,QAAQ,EAAE,EAAE,IAAI,IAAI,CAAC,YAAY,CAAC;YAClE,IAAI,KAAK,CAAC,MAAM,EAAE,CAAC;gBACjB,OAAO,MAAM,KAAK,CAAC,MAAM,CAAC,SAAS,EAAE,KAAK,CAAC,CAAC;YAC9C,CAAC;QACH,CAAC;QAAC,OAAO,CAAC,EAAE,CAAC;YACX,wBAAwB;QAC1B,CAAC;QAED,OAAO,EAAE,CAAC;IACZ,CAAC;IAED;;OAEG;IACK,KAAK,CAAC,iBAAiB,CAAC,IAAY;QAC1C,kEAAkE;QAClE,IAAI,IAAI,CAAC,cAAc,EAAE,CAAC;YACxB,IAAI,CAAC;gBACH,MAAM,SAAS,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,KAAK,EAAE,CAAC,IAAI,CAAC;uBACpD,MAAM,IAAI,CAAC,cAAc,CAAC,MAAM,EAAE,CAAC,IAAI,CAAC;uBACxC,MAAM,IAAI,CAAC,cAAc,CAAC,QAAQ,EAAE,CAAC,IAAI,CAAC,CAAC;gBAChD,IAAI,SAAS,IAAI,SAAS,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;oBACtC,OAAO,KAAK,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,KAAK,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;gBACtE,CAAC;YACH,CAAC;YAAC,OAAO,CAAC,EAAE,CAAC;gBACX,oBAAoB;YACtB,CAAC;QACH,CAAC;QAED,uDAAuD;QACvD,IAAI,IAAI,CAAC,YAAY,EAAE,KAAK,EAAE,CAAC;YAC7B,IAAI,CAAC;gBACH,MAAM,SAAS,GAAG,MAAM,IAAI,CAAC,YAAY,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;gBACtD,IAAI,SAAS;oBAAE,OAAO,KAAK,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;YAC9C,CAAC;YAAC,OAAO,CAAC,EAAE,CAAC;gBACX,WAAW;YACb,CAAC;QACH,CAAC;QAED,kDAAkD;QAClD,IAAI,IAAI,CAAC,iBAAiB,EAAE,KAAK,EAAE,CAAC;YAClC,IAAI,CAAC;gBACH,OAAO,MAAM,IAAI,CAAC,iBAAiB,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;YAClD,CAAC;YAAC,OAAO,CAAC,EAAE,CAAC;gBACX,WAAW;YACb,CAAC;QACH,CAAC;QAED,0CAA0C;QAC1C,IAAI,IAAI,CAAC,aAAa,EAAE,gBAAgB,EAAE,CAAC;YACzC,IAAI,CAAC;gBACH,OAAO,MAAM,IAAI,CAAC,aAAa,CAAC,gBAAgB,CAAC,IAAI,CAAC,CAAC;YACzD,CAAC;YAAC,OAAO,CAAC,EAAE,CAAC;gBACX,WAAW;YACb,CAAC;QACH,CAAC;QAED,iDAAiD;QACjD,OAAO,IAAI,CAAC,eAAe,CAAC,IAAI,CAAC,CAAC;IACpC,CAAC;IAED;;OAEG;IACK,eAAe,CAAC,IAAY;QAClC,MAAM,GAAG,GAAG,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC;QACrC,MAAM,SAAS,GAAG,IAAI,KAAK,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;QAEzC,MAAM,KAAK,GAAG,IAAI,CAAC,WAAW,EAAE,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;QAC9C,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,KAAK,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE,CAAC;YACtC,MAAM,IAAI,GAAG,KAAK,CAAC,CAAC,CAAC,CAAC;YACtB,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,IAAI,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE,CAAC;gBACrC,MAAM,GAAG,GAAG,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC,GAAG,CAAC,GAAG,EAAE,GAAG,CAAC,GAAG,EAAE,CAAC,GAAG,GAAG,CAAC;gBACzD,SAAS,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,GAAG,IAAI,CAAC,IAAI,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;YAC/C,CAAC;QACH,CAAC;QAED,YAAY;QACZ,MAAM,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC,CAAC,GAAG,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC;QACtE,OAAO,SAAS,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,GAAG,IAAI,CAAC,CAAC;IACtC,CAAC;IAED;;OAEG;IACK,mBAAmB,CAAC,KAAa,EAAE,OAAgC;QACzE,MAAM,GAAG,GAAG,EAAE,CAAC,CAAC,oCAAoC;QACpD,MAAM,WAAW,GAAG,IAAI,KAAK,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;QAE3C,oBAAoB;QACpB,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,KAAK,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE,CAAC;YACtC,MAAM,GAAG,GAAG,KAAK,CAAC,UAAU,CAAC,CAAC,CAAC,GAAG,GAAG,CAAC;YACtC,WAAW,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,KAAK,CAAC,MAAM,CAAC;QACvC,CAAC;QAED,sBAAsB;QACtB,WAAW,CAAC,CAAC,CAAC,GAAG,OAAO,CAAC,WAAW,CAAC;QACrC,WAAW,CAAC,GAAG,GAAG,CAAC,CAAC,GAAG,CAAC,GAAG,OAAO,CAAC,WAAW,CAAC;QAE/C,OAAO,WAAW,CAAC;IACrB,CAAC;IAED;;OAEG;IACK,qBAAqB,CAC3B,UAAsD,EACtD,OAAsB;QAEtB,IAAI,OAAO,CAAC,MAAM,KAAK,UAAU;YAAE,OAAO,CAAC,CAAC;QAE5C,MAAM,eAAe,GAAG,OAAO,CAAC,eAAe,IAAI,CAAC,CAAC;QACrD,MAAM,WAAW,GAAG,OAAO,CAAC,WAAW,IAAI,CAAC,CAAC;QAC7C,MAAM,UAAU,GAAG,eAAe,GAAG,WAAW,CAAC;QAEjD,oCAAoC;QACpC,MAAM,cAAc,GAAG,UAAU,CAAC,KAAK,CAAC,MAAM,GAAG,CAAC;YAChD,CAAC,CAAC,UAAU,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,IAAI,EAAE,EAAE,CAAC,CAAC,GAAG,IAAI,CAAC,WAAW,EAAE,CAAC,CAAC,GAAG,UAAU,CAAC,KAAK,CAAC,MAAM;YACzF,CAAC,CAAC,GAAG,CAAC;QAER,2DAA2D;QAC3D,MAAM,QAAQ,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,UAAU,CAAC,SAAS,CAAC;QACnD,MAAM,gBAAgB,GAAG,KAAK,CAAC,CAAC,sBAAsB;QACtD,MAAM,aAAa,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,QAAQ,GAAG,gBAAgB,CAAC,CAAC,CAAC,CAAC;QAEjF,uBAAuB;QACvB,OAAO,UAAU,GAAG,GAAG,GAAG,cAAc,GAAG,GAAG,GAAG,aAAa,GAAG,GAAG,CAAC;IACvE,CAAC;IAED;;OAEG;IACH,QAAQ;QAMN,OAAO;YACL,WAAW,EAAE,IAAI,CAAC,WAAW;YAC7B,OAAO,EAAE;gBACP,IAAI,EAAE,CAAC,CAAC,IAAI,CAAC,WAAW;gBACxB,aAAa,EAAE,CAAC,CAAC,IAAI,CAAC,aAAa;gBACnC,IAAI,EAAE,CAAC,CAAC,IAAI,CAAC,YAAY;gBACzB,YAAY,EAAE,CAAC,CAAC,IAAI,CAAC,iBAAiB;gBACtC,cAAc,EAAE,CAAC,CAAC,IAAI,CAAC,cAAc;aACtC;YACD,kBAAkB,EAAE,IAAI,CAAC,kBAAkB,CAAC,IAAI;YAChD,MAAM,EAAE,IAAI,CAAC,MAAM;SACpB,CAAC;IACJ,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,OAAO;QACX,sCAAsC;QACtC,KAAK,MAAM,CAAC,YAAY,EAAE,UAAU,CAAC,IAAI,IAAI,CAAC,kBAAkB,EAAE,CAAC;YACjE,MAAM,IAAI,CAAC,kBAAkB,CAAC,YAAY,EAAE;gBAC1C,MAAM,EAAE,WAAW;gBACnB,IAAI,EAAE,IAAI;gBACV,eAAe,EAAE,UAAU,CAAC,KAAK,CAAC,MAAM;gBACxC,WAAW,EAAE,UAAU,CAAC,KAAK,CAAC,MAAM;gBACpC,UAAU,EAAE,EAAE;gBACd,QAAQ,EAAE,IAAI,CAAC,GAAG,EAAE,GAAG,UAAU,CAAC,SAAS;aAC5C,CAAC,CAAC;QACL,CAAC;QAED,IAAI,CAAC,kBAAkB,CAAC,KAAK,EAAE,CAAC;QAChC,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;IACvB,CAAC;CACF;AAED,qBAAqB;AACrB,IAAI,QAAQ,GAAqC,IAAI,CAAC;AAEtD,MAAM,UAAU,4BAA4B,CAC1C,MAAsC;IAEtC,IAAI,CAAC,QAAQ,EAAE,CAAC;QACd,QAAQ,GAAG,IAAI,yBAAyB,CAAC,MAAM,CAAC,CAAC;IACnD,CAAC;IACD,OAAO,QAAQ,CAAC;AAClB,CAAC;AAED;;GAEG;AACH,MAAM,CAAC,KAAK,UAAU,2BAA2B,CAC/C,OAAsB;IAOtB,MAAM,WAAW,GAAG,4BAA4B,EAAE,CAAC;IACnD,MAAM,YAAY,GAAG,MAAM,WAAW,CAAC,eAAe,CACpD,OAAO,CAAC,QAAQ,EAChB,OAAO,CAAC,OAAO,EACf,OAAO,CAAC,KAAK,CACd,CAAC;IAEF,OAAO;QACL,YAAY;QACZ,UAAU,EAAE,CAAC,KAAK,EAAE,OAAO,EAAE,EAAE,CAAC,WAAW,CAAC,UAAU,CAAC,YAAY,EAAE,KAAK,EAAE,OAAO,CAAC;QACpF,QAAQ,EAAE,CAAC,OAAO,EAAE,EAAE,CAAC,WAAW,CAAC,kBAAkB,CAAC,YAAY,EAAE,OAAO,CAAC;QAC5E,YAAY,EAAE,CAAC,KAAK,GAAG,CAAC,EAAE,EAAE,CAAC,WAAW,CAAC,oBAAoB,CAAC,OAAO,CAAC,OAAO,EAAE,OAAO,CAAC,KAAK,EAAE,KAAK,CAAC;KACrG,CAAC;AACJ,CAAC","sourcesContent":["/**\n * RuVector Integration for Background Workers\n *\n * Connects workers to the full RuVector ecosystem:\n * - SONA: Self-learning trajectory tracking\n * - ReasoningBank: Pattern storage and memory retrieval\n * - HNSW: Vector indexing for fast semantic search\n * - Intelligence Layer: Unified pattern recognition\n */\n\nimport { EventEmitter } from 'events';\nimport { WorkerContext, WorkerResults, WorkerTrigger } from './types.js';\n\n// Types for lazy-loaded modules\ntype SONAService = any;\ntype ReasoningBankModule = any;\ntype RuVectorCore = any;\ntype IntelligenceStore = any;\ntype OnnxEmbeddings = any;\n\n/**\n * RuVector integration configuration\n */\nexport interface RuVectorWorkerConfig {\n  /** Enable SONA trajectory tracking (default: true) */\n  enableSona: boolean;\n\n  /** Enable ReasoningBank pattern storage (default: true) */\n  enableReasoningBank: boolean;\n\n  /** Enable HNSW vector indexing (default: true) */\n  enableHnsw: boolean;\n\n  /** SONA learning profile */\n  sonaProfile: 'real-time' | 'batch' | 'balanced';\n\n  /** Embedding dimension (default: 384) */\n  embeddingDim: number;\n\n  /** HNSW parameters */\n  hnswM: number;\n  hnswEfConstruction: number;\n\n  /** Quality threshold for pattern storage (0-1) */\n  qualityThreshold: number;\n}\n\nconst DEFAULT_CONFIG: RuVectorWorkerConfig = {\n  enableSona: true,\n  enableReasoningBank: true,\n  enableHnsw: true,\n  sonaProfile: 'batch',\n  embeddingDim: 384,\n  hnswM: 16,\n  hnswEfConstruction: 200,\n  qualityThreshold: 0.6\n};\n\n/**\n * Worker trajectory step\n */\nexport interface WorkerStep {\n  phase: string;\n  activations: number[];\n  duration: number;\n  memoryDeposits: number;\n  successRate: number;\n}\n\n/**\n * Worker learning result\n */\nexport interface WorkerLearningResult {\n  trajectoryId: string;\n  qualityScore: number;\n  patternsLearned: number;\n  memoryDeposits: string[];\n  sonaAdaptation: boolean;\n}\n\n/**\n * RuVector Worker Integration Service\n * Provides unified access to RuVector capabilities for background workers\n */\nexport class RuVectorWorkerIntegration extends EventEmitter {\n  private config: RuVectorWorkerConfig;\n  private sonaService: SONAService | null = null;\n  private reasoningBank: ReasoningBankModule | null = null;\n  private ruvectorCore: RuVectorCore | null = null;\n  private intelligenceStore: IntelligenceStore | null = null;\n  private onnxEmbeddings: OnnxEmbeddings | null = null;\n  private initialized = false;\n  private activeTrajectories: Map<string, {\n    workerId: string;\n    trigger: WorkerTrigger;\n    steps: WorkerStep[];\n    startTime: number;\n    embedding?: number[];\n  }> = new Map();\n\n  constructor(config: Partial<RuVectorWorkerConfig> = {}) {\n    super();\n    this.config = { ...DEFAULT_CONFIG, ...config };\n  }\n\n  /**\n   * Initialize RuVector services lazily\n   * Uses unified 'ruvector' package which includes SONA, VectorDB, embeddings\n   * Falls back gracefully if native modules aren't available\n   */\n  async initialize(): Promise<boolean> {\n    if (this.initialized) return true;\n\n    try {\n      // Try to load ruvector - may fail if native bindings not available\n      try {\n        const ruvector = await import('ruvector');\n        this.ruvectorCore = ruvector;\n\n        // Initialize SONA engine if available\n        if (this.config.enableSona && ruvector.SonaEngine) {\n          try {\n            // SonaEngine constructor signature varies by version - use any for compatibility\n            this.sonaService = new (ruvector.SonaEngine as any)(this.config.embeddingDim);\n            this.emit('module:loaded', { module: 'sona' });\n          } catch (e) {\n            // SONA is optional\n          }\n        }\n\n        // Initialize VectorDB if available (may require native bindings)\n        if (this.config.enableReasoningBank && ruvector.VectorDb) {\n          try {\n            // VectorDb constructor signature varies by version - use any for compatibility\n            this.reasoningBank = new (ruvector.VectorDb as any)({\n              dimensions: this.config.embeddingDim,\n              storagePath: '.agentic-flow/vectors.db',\n              hnswConfig: {\n                efConstruction: this.config.hnswEfConstruction,\n                M: this.config.hnswM\n              }\n            });\n            this.emit('module:loaded', { module: 'reasoningbank' });\n          } catch (e) {\n            // VectorDB is optional - continue without pattern storage\n          }\n        }\n\n        // HNSW is part of VectorDb\n        if (this.config.enableHnsw && this.reasoningBank) {\n          this.emit('module:loaded', { module: 'hnsw' });\n        }\n      } catch (e) {\n        // RuVector package not available - workers still function without learning\n        // This is expected in environments without native bindings\n      }\n\n      // Lazy load IntelligenceStore (optional fallback for local learning)\n      try {\n        const intModule = await import('../intelligence/IntelligenceStore.js');\n        this.intelligenceStore = intModule.getIntelligenceStore?.();\n        this.emit('module:loaded', { module: 'intelligence' });\n      } catch (e) {\n        // Intelligence store is optional\n      }\n\n      // Load ONNX WASM embeddings (uses global cache for performance)\n      try {\n        const { getCachedOnnxEmbedder } = await import('../utils/model-cache.js');\n        this.onnxEmbeddings = await getCachedOnnxEmbedder();\n        if (this.onnxEmbeddings) {\n          this.emit('module:loaded', { module: 'onnx-embeddings', cached: true });\n        }\n      } catch (e) {\n        // ONNX embeddings optional - will use fallback\n      }\n\n      this.initialized = true;\n      this.emit('initialized', {\n        sona: !!this.sonaService,\n        reasoningBank: !!this.reasoningBank,\n        hnsw: !!this.ruvectorCore,\n        intelligence: !!this.intelligenceStore,\n        onnxEmbeddings: !!this.onnxEmbeddings\n      });\n\n      return true;\n    } catch (error) {\n      // Even on error, mark as initialized so workers can continue\n      this.initialized = true;\n      this.emit('initialized', {\n        sona: false,\n        reasoningBank: false,\n        hnsw: false,\n        intelligence: false,\n        onnxEmbeddings: false\n      });\n      return true; // Return true so workers continue without learning\n    }\n  }\n\n  /**\n   * Start tracking a worker trajectory\n   */\n  async startTrajectory(\n    workerId: string,\n    trigger: WorkerTrigger,\n    topic: string | null\n  ): Promise<string> {\n    await this.initialize();\n\n    const trajectoryId = `traj_${workerId}_${Date.now()}`;\n\n    // Create initial embedding from topic/trigger\n    let embedding: number[] | undefined;\n    if (this.ruvectorCore && topic) {\n      try {\n        // Generate embedding for semantic similarity later\n        embedding = await this.generateEmbedding(`${trigger} ${topic}`);\n      } catch (e) {\n        // Embedding is optional\n      }\n    }\n\n    this.activeTrajectories.set(trajectoryId, {\n      workerId,\n      trigger,\n      steps: [],\n      startTime: Date.now(),\n      embedding\n    });\n\n    // Start SONA trajectory if available\n    if (this.sonaService) {\n      try {\n        await this.sonaService.startTrajectory?.(trajectoryId, {\n          route: `worker/${trigger}`,\n          contexts: [workerId, topic || 'general'],\n          embedding\n        });\n      } catch (e) {\n        // SONA tracking is best-effort\n      }\n    }\n\n    this.emit('trajectory:started', { trajectoryId, workerId, trigger });\n    return trajectoryId;\n  }\n\n  /**\n   * Record a worker phase step\n   */\n  async recordStep(\n    trajectoryId: string,\n    phase: string,\n    metrics: {\n      duration: number;\n      memoryDeposits: number;\n      successRate: number;\n      data?: Record<string, unknown>;\n    }\n  ): Promise<void> {\n    const trajectory = this.activeTrajectories.get(trajectoryId);\n    if (!trajectory) return;\n\n    // Generate activations (simplified - would be actual neural activations in production)\n    const activations = this.generateActivations(phase, metrics);\n\n    const step: WorkerStep = {\n      phase,\n      activations,\n      duration: metrics.duration,\n      memoryDeposits: metrics.memoryDeposits,\n      successRate: metrics.successRate\n    };\n\n    trajectory.steps.push(step);\n\n    // Record SONA step if available\n    if (this.sonaService) {\n      try {\n        await this.sonaService.recordStep?.(trajectoryId, {\n          activations,\n          attentionWeights: activations.map(a => Math.abs(a)),\n          reward: metrics.successRate,\n          timestamp: Date.now()\n        });\n      } catch (e) {\n        // Best effort\n      }\n    }\n\n    this.emit('step:recorded', { trajectoryId, phase, step });\n  }\n\n  /**\n   * Complete trajectory and trigger learning\n   */\n  async completeTrajectory(\n    trajectoryId: string,\n    results: WorkerResults\n  ): Promise<WorkerLearningResult> {\n    const trajectory = this.activeTrajectories.get(trajectoryId);\n    if (!trajectory) {\n      return {\n        trajectoryId,\n        qualityScore: 0,\n        patternsLearned: 0,\n        memoryDeposits: [],\n        sonaAdaptation: false\n      };\n    }\n\n    const duration = Date.now() - trajectory.startTime;\n    const qualityScore = this.calculateQualityScore(trajectory, results);\n    let patternsLearned = 0;\n    const memoryDeposits: string[] = [];\n    let sonaAdaptation = false;\n\n    // Store in ReasoningBank if quality meets threshold\n    if (this.reasoningBank && qualityScore >= this.config.qualityThreshold) {\n      try {\n        const memoryKey = `worker/${trajectory.trigger}/${trajectoryId}`;\n\n        // Store trajectory pattern\n        await this.storePattern(memoryKey, {\n          trigger: trajectory.trigger,\n          steps: trajectory.steps.map(s => s.phase),\n          duration,\n          qualityScore,\n          results: results.data\n        });\n\n        memoryDeposits.push(memoryKey);\n        patternsLearned++;\n      } catch (e) {\n        console.warn('[RuVector] Failed to store pattern:', e);\n      }\n    }\n\n    // Complete SONA trajectory and trigger learning\n    if (this.sonaService) {\n      try {\n        await this.sonaService.endTrajectory?.(trajectoryId, qualityScore);\n\n        // Force learn if quality is high\n        if (qualityScore >= 0.8) {\n          await this.sonaService.forceLearn?.();\n          sonaAdaptation = true;\n        }\n      } catch (e) {\n        // Best effort\n      }\n    }\n\n    // Index in HNSW for semantic search\n    if (this.ruvectorCore && trajectory.embedding) {\n      try {\n        await this.indexPattern(trajectoryId, trajectory.embedding, {\n          trigger: trajectory.trigger,\n          qualityScore,\n          timestamp: Date.now()\n        });\n      } catch (e) {\n        // Best effort\n      }\n    }\n\n    // Cleanup\n    this.activeTrajectories.delete(trajectoryId);\n\n    const result: WorkerLearningResult = {\n      trajectoryId,\n      qualityScore,\n      patternsLearned,\n      memoryDeposits,\n      sonaAdaptation\n    };\n\n    this.emit('trajectory:completed', result);\n    return result;\n  }\n\n  /**\n   * Find relevant patterns for a worker task\n   */\n  async findRelevantPatterns(\n    trigger: WorkerTrigger,\n    topic: string | null,\n    limit: number = 5\n  ): Promise<Array<{\n    key: string;\n    similarity: number;\n    pattern: Record<string, unknown>;\n  }>> {\n    await this.initialize();\n\n    const patterns: Array<{\n      key: string;\n      similarity: number;\n      pattern: Record<string, unknown>;\n    }> = [];\n\n    // Search HNSW if available\n    if (this.ruvectorCore && topic) {\n      try {\n        const embedding = await this.generateEmbedding(`${trigger} ${topic}`);\n        const results = await this.searchHnsw(embedding, limit);\n\n        for (const result of results) {\n          patterns.push({\n            key: result.id,\n            similarity: result.similarity,\n            pattern: result.metadata || {}\n          });\n        }\n      } catch (e) {\n        // Fallback to ReasoningBank\n      }\n    }\n\n    // Also query ReasoningBank\n    if (this.reasoningBank && patterns.length < limit) {\n      try {\n        const rbPatterns = await this.reasoningBank.retrieveMemories?.(\n          `${trigger} ${topic || ''}`,\n          { domain: 'workers', limit: limit - patterns.length }\n        );\n\n        if (rbPatterns) {\n          for (const p of rbPatterns) {\n            patterns.push({\n              key: p.id || p.key,\n              similarity: p.score || 0.5,\n              pattern: p.content || p\n            });\n          }\n        }\n      } catch (e) {\n        // Best effort\n      }\n    }\n\n    return patterns;\n  }\n\n  /**\n   * Store pattern in ReasoningBank with distillation\n   */\n  private async storePattern(\n    key: string,\n    data: Record<string, unknown>\n  ): Promise<void> {\n    if (!this.reasoningBank) return;\n\n    try {\n      // Use distillMemories if available for intelligent storage\n      if (this.reasoningBank.distillMemories) {\n        await this.reasoningBank.distillMemories(\n          data,\n          { label: 'success', confidence: data.qualityScore as number },\n          `Worker task: ${key}`,\n          { taskId: key, domain: 'workers' }\n        );\n      } else {\n        // Fallback to direct db storage\n        const db = this.reasoningBank.db;\n        if (db?.storePattern) {\n          await db.storePattern(key, JSON.stringify(data), Date.now());\n        }\n      }\n    } catch (e) {\n      console.warn('[RuVector] Pattern storage failed:', e);\n    }\n  }\n\n  /**\n   * Index pattern in HNSW for semantic search\n   */\n  private async indexPattern(\n    id: string,\n    embedding: number[],\n    metadata: Record<string, unknown>\n  ): Promise<void> {\n    if (!this.ruvectorCore) return;\n\n    try {\n      // Access HNSW index (implementation depends on ruvector version)\n      const index = this.ruvectorCore.getIndex?.() || this.ruvectorCore;\n      if (index.add) {\n        await index.add(id, embedding, metadata);\n      }\n    } catch (e) {\n      // HNSW indexing is best-effort\n    }\n  }\n\n  /**\n   * Search HNSW index\n   */\n  private async searchHnsw(\n    embedding: number[],\n    limit: number\n  ): Promise<Array<{ id: string; similarity: number; metadata?: Record<string, unknown> }>> {\n    if (!this.ruvectorCore) return [];\n\n    try {\n      const index = this.ruvectorCore.getIndex?.() || this.ruvectorCore;\n      if (index.search) {\n        return await index.search(embedding, limit);\n      }\n    } catch (e) {\n      // Search is best-effort\n    }\n\n    return [];\n  }\n\n  /**\n   * Generate embedding for text using ONNX WASM (real semantic embeddings)\n   */\n  private async generateEmbedding(text: string): Promise<number[]> {\n    // Priority 1: Use ONNX WASM embeddings (real semantic embeddings)\n    if (this.onnxEmbeddings) {\n      try {\n        const embedding = await this.onnxEmbeddings.embed?.(text)\n          || await this.onnxEmbeddings.encode?.(text)\n          || await this.onnxEmbeddings.generate?.(text);\n        if (embedding && embedding.length > 0) {\n          return Array.isArray(embedding) ? embedding : Array.from(embedding);\n        }\n      } catch (e) {\n        // Try other methods\n      }\n    }\n\n    // Priority 2: Use ruvector core embedding if available\n    if (this.ruvectorCore?.embed) {\n      try {\n        const embedding = await this.ruvectorCore.embed(text);\n        if (embedding) return Array.from(embedding);\n      } catch (e) {\n        // Fallback\n      }\n    }\n\n    // Priority 3: Use intelligence store if available\n    if (this.intelligenceStore?.embed) {\n      try {\n        return await this.intelligenceStore.embed(text);\n      } catch (e) {\n        // Fallback\n      }\n    }\n\n    // Priority 4: Use ReasoningBank embedding\n    if (this.reasoningBank?.computeEmbedding) {\n      try {\n        return await this.reasoningBank.computeEmbedding(text);\n      } catch (e) {\n        // Fallback\n      }\n    }\n\n    // Fallback: Generate simple hash-based embedding\n    return this.simpleEmbedding(text);\n  }\n\n  /**\n   * Simple hash-based embedding fallback\n   */\n  private simpleEmbedding(text: string): number[] {\n    const dim = this.config.embeddingDim;\n    const embedding = new Array(dim).fill(0);\n\n    const words = text.toLowerCase().split(/\\s+/);\n    for (let i = 0; i < words.length; i++) {\n      const word = words[i];\n      for (let j = 0; j < word.length; j++) {\n        const idx = (word.charCodeAt(j) + i * 31 + j * 17) % dim;\n        embedding[idx] += 1 / (1 + Math.sqrt(i + j));\n      }\n    }\n\n    // Normalize\n    const norm = Math.sqrt(embedding.reduce((s, v) => s + v * v, 0)) || 1;\n    return embedding.map(v => v / norm);\n  }\n\n  /**\n   * Generate activations for a phase\n   */\n  private generateActivations(phase: string, metrics: { successRate: number }): number[] {\n    const dim = 64; // Reduced dimension for activations\n    const activations = new Array(dim).fill(0);\n\n    // Encode phase name\n    for (let i = 0; i < phase.length; i++) {\n      const idx = phase.charCodeAt(i) % dim;\n      activations[idx] += 1 / phase.length;\n    }\n\n    // Encode success rate\n    activations[0] = metrics.successRate;\n    activations[dim - 1] = 1 - metrics.successRate;\n\n    return activations;\n  }\n\n  /**\n   * Calculate quality score for a trajectory\n   */\n  private calculateQualityScore(\n    trajectory: { steps: WorkerStep[]; startTime: number },\n    results: WorkerResults\n  ): number {\n    if (results.status !== 'complete') return 0;\n\n    const completedPhases = results.completedPhases || 0;\n    const totalPhases = results.totalPhases || 1;\n    const phaseScore = completedPhases / totalPhases;\n\n    // Average success rate across steps\n    const avgSuccessRate = trajectory.steps.length > 0\n      ? trajectory.steps.reduce((s, step) => s + step.successRate, 0) / trajectory.steps.length\n      : 0.5;\n\n    // Duration penalty (penalize very long or very short runs)\n    const duration = Date.now() - trajectory.startTime;\n    const expectedDuration = 30000; // 30 seconds expected\n    const durationScore = Math.exp(-Math.abs(Math.log(duration / expectedDuration)));\n\n    // Weighted combination\n    return phaseScore * 0.4 + avgSuccessRate * 0.4 + durationScore * 0.2;\n  }\n\n  /**\n   * Get integration stats\n   */\n  getStats(): {\n    initialized: boolean;\n    modules: { sona: boolean; reasoningBank: boolean; hnsw: boolean; intelligence: boolean; onnxEmbeddings: boolean };\n    activeTrajectories: number;\n    config: RuVectorWorkerConfig;\n  } {\n    return {\n      initialized: this.initialized,\n      modules: {\n        sona: !!this.sonaService,\n        reasoningBank: !!this.reasoningBank,\n        hnsw: !!this.ruvectorCore,\n        intelligence: !!this.intelligenceStore,\n        onnxEmbeddings: !!this.onnxEmbeddings\n      },\n      activeTrajectories: this.activeTrajectories.size,\n      config: this.config\n    };\n  }\n\n  /**\n   * Cleanup resources\n   */\n  async cleanup(): Promise<void> {\n    // Complete any remaining trajectories\n    for (const [trajectoryId, trajectory] of this.activeTrajectories) {\n      await this.completeTrajectory(trajectoryId, {\n        status: 'cancelled',\n        data: null,\n        completedPhases: trajectory.steps.length,\n        totalPhases: trajectory.steps.length,\n        memoryKeys: [],\n        duration: Date.now() - trajectory.startTime\n      });\n    }\n\n    this.activeTrajectories.clear();\n    this.emit('cleanup');\n  }\n}\n\n// Singleton instance\nlet instance: RuVectorWorkerIntegration | null = null;\n\nexport function getRuVectorWorkerIntegration(\n  config?: Partial<RuVectorWorkerConfig>\n): RuVectorWorkerIntegration {\n  if (!instance) {\n    instance = new RuVectorWorkerIntegration(config);\n  }\n  return instance;\n}\n\n/**\n * Create worker context with RuVector integration\n */\nexport async function createRuVectorWorkerContext(\n  context: WorkerContext\n): Promise<{\n  trajectoryId: string;\n  recordStep: (phase: string, metrics: { duration: number; memoryDeposits: number; successRate: number }) => Promise<void>;\n  complete: (results: WorkerResults) => Promise<WorkerLearningResult>;\n  findPatterns: (limit?: number) => Promise<Array<{ key: string; similarity: number; pattern: Record<string, unknown> }>>;\n}> {\n  const integration = getRuVectorWorkerIntegration();\n  const trajectoryId = await integration.startTrajectory(\n    context.workerId,\n    context.trigger,\n    context.topic\n  );\n\n  return {\n    trajectoryId,\n    recordStep: (phase, metrics) => integration.recordStep(trajectoryId, phase, metrics),\n    complete: (results) => integration.completeTrajectory(trajectoryId, results),\n    findPatterns: (limit = 5) => integration.findRelevantPatterns(context.trigger, context.topic, limit)\n  };\n}\n"]}
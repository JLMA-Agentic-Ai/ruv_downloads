{"version":3,"file":"model-cache.js","sourceRoot":"","sources":["../../src/utils/model-cache.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Global Model Cache\n *\n * Caches loaded models in memory to avoid repeated initialization overhead.\n * Supports ONNX embeddings, transformers.js pipelines, and other heavy models.\n */\n\ninterface CachedModel {\n  model: any;\n  loadedAt: number;\n  lastUsed: number;\n  useCount: number;\n  sizeEstimate: number; // bytes\n}\n\ninterface CacheStats {\n  models: number;\n  totalSize: number;\n  size?: number;\n  totalHits: number;\n  totalMisses: number;\n  hits: number;\n  misses: number;\n  hitRate: number;\n}\n\nclass ModelCache {\n  private cache = new Map<string, CachedModel>();\n  private maxSize: number; // Max cache size in bytes\n  private totalHits = 0;\n  private totalMisses = 0;\n\n  constructor(maxSizeMB: number = 512) {\n    this.maxSize = maxSizeMB * 1024 * 1024;\n  }\n\n  /**\n   * Get a cached model or load it\n   */\n  async getOrLoad<T>(\n    key: string,\n    loader: () => Promise<T>,\n    sizeEstimate: number = 50 * 1024 * 1024 // Default 50MB estimate\n  ): Promise<T> {\n    const cached = this.cache.get(key);\n    if (cached) {\n      cached.lastUsed = Date.now();\n      cached.useCount++;\n      this.totalHits++;\n      return cached.model as T;\n    }\n\n    this.totalMisses++;\n\n    // Evict if needed\n    this.evictIfNeeded(sizeEstimate);\n\n    // Load model\n    const model = await loader();\n\n    this.cache.set(key, {\n      model,\n      loadedAt: Date.now(),\n      lastUsed: Date.now(),\n      useCount: 1,\n      sizeEstimate\n    });\n\n    return model;\n  }\n\n  /**\n   * Check if model is cached\n   */\n  has(key: string): boolean {\n    return this.cache.has(key);\n  }\n\n  /**\n   * Get cached model without loading\n   */\n  get<T>(key: string): T | undefined {\n    const cached = this.cache.get(key);\n    if (cached) {\n      cached.lastUsed = Date.now();\n      cached.useCount++;\n      return cached.model as T;\n    }\n    return undefined;\n  }\n\n  /**\n   * Manually cache a model\n   */\n  set(key: string, model: any, sizeEstimate: number = 50 * 1024 * 1024): void {\n    this.evictIfNeeded(sizeEstimate);\n    this.cache.set(key, {\n      model,\n      loadedAt: Date.now(),\n      lastUsed: Date.now(),\n      useCount: 1,\n      sizeEstimate\n    });\n  }\n\n  /**\n   * Remove a model from cache\n   */\n  delete(key: string): boolean {\n    return this.cache.delete(key);\n  }\n\n  /**\n   * Clear all cached models\n   */\n  clear(): void {\n    this.cache.clear();\n  }\n\n  /**\n   * Get cache statistics\n   */\n  getStats(): CacheStats {\n    let totalSize = 0;\n    for (const cached of this.cache.values()) {\n      totalSize += cached.sizeEstimate;\n    }\n    const hits = this.totalHits;\n    const misses = this.totalMisses;\n    const total = hits + misses;\n    return {\n      models: this.cache.size,\n      totalSize,\n      size: this.cache.size,\n      totalHits: hits,\n      totalMisses: misses,\n      hits,\n      misses,\n      hitRate: total > 0 ? hits / total : 0\n    };\n  }\n\n  /**\n   * Evict least recently used models if cache is full\n   */\n  private evictIfNeeded(newSize: number): void {\n    let currentSize = 0;\n    for (const cached of this.cache.values()) {\n      currentSize += cached.sizeEstimate;\n    }\n\n    if (currentSize + newSize <= this.maxSize) {\n      return;\n    }\n\n    // Sort by last used time (LRU)\n    const entries = Array.from(this.cache.entries())\n      .sort((a, b) => a[1].lastUsed - b[1].lastUsed);\n\n    // Evict until we have space\n    for (const [key, cached] of entries) {\n      if (currentSize + newSize <= this.maxSize) {\n        break;\n      }\n      this.cache.delete(key);\n      currentSize -= cached.sizeEstimate;\n    }\n  }\n}\n\n// Global singleton\nexport const modelCache = new ModelCache();\n\n// Convenience functions\nexport async function getCachedOnnxEmbedder(): Promise<any> {\n  return modelCache.getOrLoad(\n    'onnx-embeddings',\n    async () => {\n      // Suppress experimental warning for WASM\n      const originalEmit = process.emit;\n      // @ts-ignore\n      process.emit = function (name, data, ...args) {\n        if (name === 'warning' && typeof data === 'object' &&\n            (data as any).name === 'ExperimentalWarning' &&\n            (data as any).message?.includes('Import')) {\n          return false;\n        }\n        // @ts-ignore\n        return originalEmit.apply(process, [name, data, ...args]);\n      };\n\n      try {\n        const onnxModule = await import('ruvector-onnx-embeddings-wasm') as any;\n        const EmbedderClass = onnxModule.OnnxEmbeddings || onnxModule.default;\n        if (EmbedderClass) {\n          const embedder = new EmbedderClass();\n          await embedder.initialize?.();\n          return embedder;\n        }\n      } finally {\n        process.emit = originalEmit;\n      }\n      return null;\n    },\n    100 * 1024 * 1024 // 100MB estimate for ONNX model\n  );\n}\n\nexport async function getCachedTransformersPipeline(\n  task: string = 'feature-extraction',\n  model: string = 'Xenova/all-MiniLM-L6-v2'\n): Promise<any> {\n  return modelCache.getOrLoad(\n    `transformers:${task}:${model}`,\n    async () => {\n      const { pipeline } = await import('@xenova/transformers');\n      return pipeline(task as any, model);\n    },\n    200 * 1024 * 1024 // 200MB estimate for transformers model\n  );\n}\n\nexport async function getCachedRuvectorCore(): Promise<any> {\n  return modelCache.getOrLoad(\n    'ruvector-core',\n    async () => {\n      const ruvector = await import('ruvector');\n      return ruvector;\n    },\n    50 * 1024 * 1024\n  );\n}\n"]}
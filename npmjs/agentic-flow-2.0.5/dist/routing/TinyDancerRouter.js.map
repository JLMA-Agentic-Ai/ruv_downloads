{"version":3,"file":"TinyDancerRouter.js","sourceRoot":"","sources":["../../src/routing/TinyDancerRouter.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * TinyDancer Router - FastGRNN-based Neural Agent Routing\n *\n * Integrates @ruvector/tiny-dancer for production-grade AI agent orchestration.\n *\n * Features:\n * - FastGRNN Neural Routing: Efficient gated recurrent network for fast inference\n * - Uncertainty Estimation: Know when the router is confident vs. uncertain\n * - Circuit Breaker: Automatic fallback when routing fails repeatedly\n * - Hot-Reload: Update models without restarting the application\n * - SIMD Optimized: Native Rust performance with SIMD acceleration\n *\n * Performance:\n * - <5ms routing decisions\n * - 99.9% uptime with circuit breaker\n * - Adaptive learning from routing outcomes\n */\n\nimport { logger } from '../utils/logger.js';\n\n// TinyDancer module state\nlet tinyDancerModule: TinyDancerModule | null = null;\nlet initialized = false;\n\n/**\n * TinyDancer module interface (from @ruvector/tiny-dancer)\n */\ninterface TinyDancerModule {\n  // Router class\n  Router: new (config?: RouterConfig) => TinyDancerRouterInstance;\n  // Utility functions\n  isAvailable: () => boolean;\n  getVersion: () => string;\n  // Circuit breaker\n  CircuitBreaker: new (config?: CircuitBreakerConfig) => CircuitBreakerInstance;\n}\n\ninterface RouterConfig {\n  modelPath?: string;\n  embeddingDim?: number;\n  hiddenSize?: number;\n  numAgents?: number;\n  temperature?: number;\n  enableUncertainty?: boolean;\n}\n\ninterface TinyDancerRouterInstance {\n  route(embedding: Float32Array): Promise<RouteResult>;\n  routeBatch(embeddings: Float32Array[]): Promise<RouteResult[]>;\n  getUncertainty(embedding: Float32Array): Promise<number>;\n  updateWeights(agentId: string, reward: number): void;\n  hotReload(modelPath: string): Promise<void>;\n  getMetrics(): RouterMetrics;\n  shutdown(): Promise<void>;\n}\n\ninterface CircuitBreakerConfig {\n  failureThreshold?: number;\n  successThreshold?: number;\n  timeout?: number;\n  halfOpenRequests?: number;\n}\n\ninterface CircuitBreakerInstance {\n  execute<T>(fn: () => Promise<T>, fallback?: () => T): Promise<T>;\n  getState(): 'closed' | 'open' | 'half-open';\n  reset(): void;\n  getMetrics(): { failures: number; successes: number; state: string };\n}\n\nexport interface RouteResult {\n  agentId: string;\n  confidence: number;\n  uncertainty?: number;\n  alternatives?: Array<{ agentId: string; confidence: number }>;\n  latencyMs: number;\n}\n\nexport interface RouterMetrics {\n  totalRoutes: number;\n  avgLatencyMs: number;\n  uncertaintyDistribution: { low: number; medium: number; high: number };\n  agentDistribution: Map<string, number>;\n}\n\nexport interface TinyDancerConfig {\n  /** Embedding dimension (default: 384 for all-MiniLM-L6-v2) */\n  embeddingDim?: number;\n  /** Number of agents to route to */\n  numAgents?: number;\n  /** Temperature for softmax (lower = more confident) */\n  temperature?: number;\n  /** Enable uncertainty estimation */\n  enableUncertainty?: boolean;\n  /** Circuit breaker failure threshold */\n  circuitBreakerThreshold?: number;\n  /** Fallback agent when circuit opens */\n  fallbackAgent?: string;\n}\n\n/**\n * Initialize TinyDancer module\n */\nexport async function initTinyDancer(): Promise<boolean> {\n  if (initialized) return tinyDancerModule !== null;\n\n  try {\n    const mod = await import('@ruvector/tiny-dancer');\n    tinyDancerModule = mod as unknown as TinyDancerModule;\n    initialized = true;\n\n    if (tinyDancerModule.isAvailable?.()) {\n      logger.info('TinyDancer initialized', {\n        version: tinyDancerModule.getVersion?.() || 'unknown',\n        features: ['FastGRNN', 'CircuitBreaker', 'Uncertainty'],\n      });\n      return true;\n    }\n\n    logger.debug('TinyDancer available but not fully functional');\n    return true;\n  } catch (error) {\n    logger.debug('TinyDancer not available, using fallback routing', { error });\n    initialized = true;\n    return false;\n  }\n}\n\n/**\n * Check if TinyDancer is available\n */\nexport function isTinyDancerAvailable(): boolean {\n  return tinyDancerModule !== null && (tinyDancerModule.isAvailable?.() ?? false);\n}\n\n/**\n * TinyDancer Router - Neural agent routing with circuit breaker\n */\nexport class TinyDancerRouter {\n  private config: Required<TinyDancerConfig>;\n  private nativeRouter: TinyDancerRouterInstance | null = null;\n  private circuitBreaker: CircuitBreakerInstance | null = null;\n\n  // Fallback state (when TinyDancer unavailable)\n  private agentWeights: Map<string, number> = new Map();\n  private routingHistory: Array<{ agentId: string; success: boolean; timestamp: number }> = [];\n\n  // Metrics\n  private totalRoutes = 0;\n  private totalLatencyMs = 0;\n  private uncertaintyCounts = { low: 0, medium: 0, high: 0 };\n\n  // Agent registry\n  private agents: Map<string, { embedding: Float32Array; capabilities: string[] }> = new Map();\n\n  constructor(config?: TinyDancerConfig) {\n    this.config = {\n      embeddingDim: config?.embeddingDim ?? 384,\n      numAgents: config?.numAgents ?? 10,\n      temperature: config?.temperature ?? 1.0,\n      enableUncertainty: config?.enableUncertainty ?? true,\n      circuitBreakerThreshold: config?.circuitBreakerThreshold ?? 5,\n      fallbackAgent: config?.fallbackAgent ?? 'general',\n    };\n\n    this.initializeNative();\n  }\n\n  /**\n   * Initialize native TinyDancer router\n   */\n  private async initializeNative(): Promise<void> {\n    if (!initialized) {\n      await initTinyDancer();\n    }\n\n    if (tinyDancerModule) {\n      try {\n        // Create native router\n        this.nativeRouter = new tinyDancerModule.Router({\n          embeddingDim: this.config.embeddingDim,\n          numAgents: this.config.numAgents,\n          temperature: this.config.temperature,\n          enableUncertainty: this.config.enableUncertainty,\n        });\n\n        // Create circuit breaker\n        this.circuitBreaker = new tinyDancerModule.CircuitBreaker({\n          failureThreshold: this.config.circuitBreakerThreshold,\n          successThreshold: 3,\n          timeout: 30000,\n          halfOpenRequests: 1,\n        });\n\n        logger.debug('TinyDancer native router initialized');\n      } catch (error) {\n        logger.warn('Failed to create native TinyDancer router', { error });\n      }\n    }\n  }\n\n  /**\n   * Register an agent for routing\n   */\n  registerAgent(agentId: string, embedding: Float32Array | number[], capabilities: string[]): void {\n    const vec = embedding instanceof Float32Array ? embedding : new Float32Array(embedding);\n    this.agents.set(agentId, { embedding: vec, capabilities });\n    this.agentWeights.set(agentId, 1.0);\n  }\n\n  /**\n   * Route task to best agent\n   *\n   * Uses FastGRNN neural routing if available, falls back to\n   * cosine similarity matching otherwise.\n   *\n   * @param taskEmbedding - Embedding of the task description\n   * @returns Route result with selected agent and confidence\n   */\n  async route(taskEmbedding: Float32Array | number[]): Promise<RouteResult> {\n    const startTime = performance.now();\n    const vec = taskEmbedding instanceof Float32Array ? taskEmbedding : new Float32Array(taskEmbedding);\n\n    let result: RouteResult;\n\n    // Try native router with circuit breaker\n    if (this.nativeRouter && this.circuitBreaker) {\n      try {\n        result = await this.circuitBreaker.execute(\n          async () => this.nativeRouter!.route(vec),\n          () => this.fallbackRoute(vec) // Fallback when circuit opens\n        );\n      } catch (error) {\n        logger.warn('Native routing failed, using fallback', { error });\n        result = this.fallbackRoute(vec);\n      }\n    } else {\n      result = this.fallbackRoute(vec);\n    }\n\n    // Update metrics\n    this.totalRoutes++;\n    const latency = performance.now() - startTime;\n    this.totalLatencyMs += latency;\n    result.latencyMs = latency;\n\n    // Track uncertainty distribution\n    if (result.uncertainty !== undefined) {\n      if (result.uncertainty < 0.3) this.uncertaintyCounts.low++;\n      else if (result.uncertainty < 0.7) this.uncertaintyCounts.medium++;\n      else this.uncertaintyCounts.high++;\n    }\n\n    return result;\n  }\n\n  /**\n   * Route multiple tasks in batch (parallel processing)\n   */\n  async routeBatch(taskEmbeddings: Float32Array[]): Promise<RouteResult[]> {\n    if (this.nativeRouter) {\n      try {\n        return await this.nativeRouter.routeBatch(taskEmbeddings);\n      } catch (error) {\n        logger.warn('Batch routing failed, falling back to sequential', { error });\n      }\n    }\n\n    // Sequential fallback\n    return Promise.all(taskEmbeddings.map((e) => this.route(e)));\n  }\n\n  /**\n   * Get uncertainty estimate for a task\n   */\n  async getUncertainty(taskEmbedding: Float32Array): Promise<number> {\n    if (this.nativeRouter) {\n      try {\n        return await this.nativeRouter.getUncertainty(taskEmbedding);\n      } catch {\n        // Fall through to fallback\n      }\n    }\n\n    // Fallback: estimate uncertainty from agent similarity spread\n    const similarities = this.computeSimilarities(taskEmbedding);\n    if (similarities.length < 2) return 0.5;\n\n    // High variance in similarities = low uncertainty\n    const mean = similarities.reduce((a, b) => a + b, 0) / similarities.length;\n    const variance = similarities.reduce((a, s) => a + Math.pow(s - mean, 2), 0) / similarities.length;\n\n    // Convert variance to uncertainty (low variance = high uncertainty)\n    return Math.max(0, Math.min(1, 1 - Math.sqrt(variance) * 2));\n  }\n\n  /**\n   * Record routing outcome for learning\n   */\n  recordOutcome(agentId: string, success: boolean, reward: number = success ? 1 : -1): void {\n    // Update native router weights\n    if (this.nativeRouter) {\n      try {\n        this.nativeRouter.updateWeights(agentId, reward);\n      } catch {\n        // Fall through to fallback\n      }\n    }\n\n    // Update fallback weights\n    const currentWeight = this.agentWeights.get(agentId) ?? 1.0;\n    const learningRate = 0.1;\n    const newWeight = currentWeight + learningRate * reward;\n    this.agentWeights.set(agentId, Math.max(0.1, Math.min(10, newWeight)));\n\n    // Track history (keep last 100)\n    this.routingHistory.push({ agentId, success, timestamp: Date.now() });\n    if (this.routingHistory.length > 100) {\n      this.routingHistory.shift();\n    }\n  }\n\n  /**\n   * Hot-reload model without restart\n   */\n  async hotReload(modelPath: string): Promise<void> {\n    if (this.nativeRouter) {\n      await this.nativeRouter.hotReload(modelPath);\n      logger.info('TinyDancer model hot-reloaded', { modelPath });\n    }\n  }\n\n  /**\n   * Get routing metrics\n   */\n  getMetrics(): RouterMetrics {\n    if (this.nativeRouter) {\n      try {\n        return this.nativeRouter.getMetrics();\n      } catch {\n        // Fall through to computed metrics\n      }\n    }\n\n    // Compute agent distribution from history\n    const agentDistribution = new Map<string, number>();\n    for (const entry of this.routingHistory) {\n      agentDistribution.set(entry.agentId, (agentDistribution.get(entry.agentId) ?? 0) + 1);\n    }\n\n    return {\n      totalRoutes: this.totalRoutes,\n      avgLatencyMs: this.totalRoutes > 0 ? this.totalLatencyMs / this.totalRoutes : 0,\n      uncertaintyDistribution: { ...this.uncertaintyCounts },\n      agentDistribution,\n    };\n  }\n\n  /**\n   * Get circuit breaker state\n   */\n  getCircuitState(): 'closed' | 'open' | 'half-open' | 'unknown' {\n    if (this.circuitBreaker) {\n      return this.circuitBreaker.getState();\n    }\n    return 'unknown';\n  }\n\n  /**\n   * Reset circuit breaker\n   */\n  resetCircuit(): void {\n    if (this.circuitBreaker) {\n      this.circuitBreaker.reset();\n    }\n  }\n\n  /**\n   * Check if using native TinyDancer\n   */\n  isNative(): boolean {\n    return this.nativeRouter !== null;\n  }\n\n  /**\n   * Cleanup resources\n   */\n  async shutdown(): Promise<void> {\n    if (this.nativeRouter) {\n      await this.nativeRouter.shutdown();\n    }\n    this.agents.clear();\n    this.agentWeights.clear();\n    this.routingHistory = [];\n  }\n\n  // ========================================================================\n  // Private Helper Methods\n  // ========================================================================\n\n  /**\n   * Fallback routing using cosine similarity\n   */\n  private fallbackRoute(taskEmbedding: Float32Array): RouteResult {\n    if (this.agents.size === 0) {\n      return {\n        agentId: this.config.fallbackAgent,\n        confidence: 0.5,\n        uncertainty: 0.5,\n        latencyMs: 0,\n      };\n    }\n\n    // Compute weighted similarities\n    const scores: Array<{ agentId: string; score: number }> = [];\n\n    for (const [agentId, data] of this.agents) {\n      const similarity = this.cosineSimilarity(taskEmbedding, data.embedding);\n      const weight = this.agentWeights.get(agentId) ?? 1.0;\n      scores.push({\n        agentId,\n        score: similarity * weight,\n      });\n    }\n\n    // Sort by score\n    scores.sort((a, b) => b.score - a.score);\n\n    // Apply temperature for softmax-like selection\n    const topScore = scores[0].score;\n    const temperature = this.config.temperature;\n\n    // Compute softmax probabilities\n    const expScores = scores.map((s) => Math.exp((s.score - topScore) / temperature));\n    const sumExp = expScores.reduce((a, b) => a + b, 0);\n    const probs = expScores.map((e) => e / sumExp);\n\n    // Select based on probability (deterministic for top-1)\n    const selected = scores[0];\n    const confidence = probs[0];\n\n    // Estimate uncertainty from score distribution\n    const uncertainty = this.estimateUncertaintyFromScores(scores.map((s) => s.score));\n\n    return {\n      agentId: selected.agentId,\n      confidence,\n      uncertainty,\n      alternatives: scores.slice(1, 4).map((s, i) => ({\n        agentId: s.agentId,\n        confidence: probs[i + 1],\n      })),\n      latencyMs: 0,\n    };\n  }\n\n  /**\n   * Compute similarities to all agents\n   */\n  private computeSimilarities(taskEmbedding: Float32Array): number[] {\n    const similarities: number[] = [];\n    for (const [, data] of this.agents) {\n      similarities.push(this.cosineSimilarity(taskEmbedding, data.embedding));\n    }\n    return similarities;\n  }\n\n  /**\n   * Estimate uncertainty from score distribution\n   */\n  private estimateUncertaintyFromScores(scores: number[]): number {\n    if (scores.length < 2) return 0.5;\n\n    // Uncertainty is high when scores are similar\n    const maxScore = Math.max(...scores);\n    const secondMaxScore = scores.filter((s) => s !== maxScore).reduce((a, b) => Math.max(a, b), 0);\n\n    // Large gap = low uncertainty\n    const gap = maxScore - secondMaxScore;\n    return Math.max(0, Math.min(1, 1 - gap * 2));\n  }\n\n  /**\n   * Cosine similarity between two vectors\n   */\n  private cosineSimilarity(a: Float32Array, b: Float32Array): number {\n    let dot = 0;\n    let normA = 0;\n    let normB = 0;\n\n    for (let i = 0; i < a.length; i++) {\n      dot += a[i] * b[i];\n      normA += a[i] * a[i];\n      normB += b[i] * b[i];\n    }\n\n    const denominator = Math.sqrt(normA) * Math.sqrt(normB);\n    return denominator === 0 ? 0 : dot / denominator;\n  }\n}\n\n/**\n * Singleton instance for global access\n */\nlet globalRouter: TinyDancerRouter | null = null;\n\n/**\n * Get global TinyDancer router instance\n */\nexport function getTinyDancerRouter(config?: TinyDancerConfig): TinyDancerRouter {\n  if (!globalRouter) {\n    globalRouter = new TinyDancerRouter(config);\n  }\n  return globalRouter;\n}\n\n/**\n * Reset global router (for testing)\n */\nexport async function resetTinyDancerRouter(): Promise<void> {\n  if (globalRouter) {\n    await globalRouter.shutdown();\n    globalRouter = null;\n  }\n}\n\nexport default {\n  TinyDancerRouter,\n  getTinyDancerRouter,\n  resetTinyDancerRouter,\n  initTinyDancer,\n  isTinyDancerAvailable,\n};\n"]}
{"version":3,"file":"CircuitBreakerRouter.js","sourceRoot":"","sources":["../../src/routing/CircuitBreakerRouter.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Circuit Breaker Router - Fault-Tolerant Agent Routing\n *\n * Integrates @ruvector/tiny-dancer circuit breaker pattern for 99.9% uptime.\n *\n * Features:\n * - Circuit breaker states: CLOSED, OPEN, HALF_OPEN\n * - Automatic failure detection and recovery\n * - Fallback chains for degraded service\n * - Hot-reload capability for configuration updates\n * - Uncertainty estimation for routing decisions\n * - Rate limiting for request protection\n *\n * Performance:\n * - <5ms routing overhead\n * - 99.9% uptime guarantee\n * - Automatic failover in <100ms\n */\n\n// Import security utilities\nimport { InputValidator } from '../utils/input-validator.js';\nimport { RateLimiter } from '../utils/rate-limiter.js';\n\nexport interface CircuitBreakerConfig {\n  /** Failure threshold before opening circuit (default: 5) */\n  failureThreshold?: number;\n  /** Success threshold to close circuit from half-open (default: 3) */\n  successThreshold?: number;\n  /** Timeout before attempting recovery (ms, default: 30000) */\n  resetTimeout?: number;\n  /** Request timeout (ms, default: 5000) */\n  requestTimeout?: number;\n  /** Enable uncertainty estimation (default: true) */\n  enableUncertaintyEstimation?: boolean;\n}\n\nexport enum CircuitState {\n  CLOSED = 'CLOSED',     // Normal operation\n  OPEN = 'OPEN',         // Failures detected, routing blocked\n  HALF_OPEN = 'HALF_OPEN' // Testing recovery\n}\n\nexport interface RouteRequest {\n  taskDescription: string;\n  preferredAgent?: string;\n  fallbackAgents?: string[];\n  timeout?: number;\n}\n\nexport interface RouteResult {\n  selectedAgent: string;\n  confidence: number;\n  circuitState: CircuitState;\n  fallbackUsed: boolean;\n  uncertainty?: number;\n  metrics: {\n    routingTimeMs: number;\n    failureCount: number;\n    successCount: number;\n  };\n}\n\nexport interface AgentHealth {\n  agent: string;\n  state: CircuitState;\n  failureCount: number;\n  successCount: number;\n  lastFailureTime?: number;\n  lastSuccessTime?: number;\n  availability: number; // 0-1\n}\n\n/**\n * Circuit Breaker Router\n *\n * Provides fault-tolerant routing with:\n * 1. Circuit breaker pattern for each agent\n * 2. Automatic fallback chains\n * 3. Health monitoring and recovery\n * 4. Uncertainty-aware decision making\n */\nexport class CircuitBreakerRouter {\n  private config: Required<CircuitBreakerConfig>;\n\n  // Circuit breaker state per agent\n  private circuitStates: Map<string, CircuitState>;\n  private failureCounts: Map<string, number>;\n  private successCounts: Map<string, number>;\n  private lastFailureTimes: Map<string, number>;\n  private lastSuccessTimes: Map<string, number>;\n  private resetTimers: Map<string, NodeJS.Timeout>;\n\n  // Security: Rate limiter to prevent request spam\n  private rateLimiter: RateLimiter;\n\n  // Performance tracking\n  private routingMetrics: {\n    totalRequests: number;\n    successfulRoutes: number;\n    fallbackRoutes: number;\n    failedRoutes: number;\n    avgRoutingTimeMs: number;\n  };\n\n  constructor(config?: CircuitBreakerConfig) {\n    // Security: Validate configuration\n    if (config) {\n      const validatedConfig = InputValidator.validateConfig<CircuitBreakerConfig>(config, {\n        failureThreshold: {\n          type: 'number',\n          required: false,\n          min: 1,\n          max: 100,\n        },\n        successThreshold: {\n          type: 'number',\n          required: false,\n          min: 1,\n          max: 100,\n        },\n        resetTimeout: {\n          type: 'number',\n          required: false,\n          min: 1000,\n          max: 300000,\n        },\n        requestTimeout: {\n          type: 'number',\n          required: false,\n          min: 100,\n          max: 60000,\n        },\n        enableUncertaintyEstimation: {\n          type: 'boolean',\n          required: false,\n        },\n      });\n      config = validatedConfig;\n    }\n\n    this.config = {\n      failureThreshold: config?.failureThreshold ?? 5,\n      successThreshold: config?.successThreshold ?? 3,\n      resetTimeout: config?.resetTimeout ?? 30000,\n      requestTimeout: config?.requestTimeout ?? 5000,\n      enableUncertaintyEstimation: config?.enableUncertaintyEstimation ?? true,\n    };\n\n    // Security: Initialize rate limiter (100 requests per minute per client)\n    this.rateLimiter = new RateLimiter({\n      points: 100,\n      duration: 60,\n      blockDuration: 300, // Block for 5 minutes if exceeded\n    });\n\n    this.circuitStates = new Map();\n    this.failureCounts = new Map();\n    this.successCounts = new Map();\n    this.lastFailureTimes = new Map();\n    this.lastSuccessTimes = new Map();\n    this.resetTimers = new Map();\n\n    this.routingMetrics = {\n      totalRequests: 0,\n      successfulRoutes: 0,\n      fallbackRoutes: 0,\n      failedRoutes: 0,\n      avgRoutingTimeMs: 0,\n    };\n  }\n\n  /**\n   * Route request to agent with circuit breaker protection\n   *\n   * Process:\n   * 1. Check circuit state for preferred agent\n   * 2. If circuit OPEN, try fallback chain\n   * 3. If circuit HALF_OPEN, allow test request\n   * 4. Estimate uncertainty if enabled\n   *\n   * @param request - Route request with task and agent preferences\n   * @returns Route result with selected agent and metrics\n   */\n  async route(request: RouteRequest): Promise<RouteResult> {\n    const startTime = performance.now();\n\n    // Security: Validate task description\n    const sanitizedTask = InputValidator.validateTaskDescription(request.taskDescription, {\n      maxLength: 10000,\n      minLength: 1,\n      sanitize: true,\n    });\n\n    // Security: Validate timeout if provided\n    const timeout = request.timeout\n      ? InputValidator.validateTimeout(request.timeout, 100, 60000)\n      : this.config.requestTimeout;\n\n    // Security: Rate limiting (use task description hash as key)\n    const rateLimitKey = this.hashString(sanitizedTask);\n    try {\n      await this.rateLimiter.consume(rateLimitKey);\n    } catch (error) {\n      throw new Error(`Rate limit exceeded: ${error instanceof Error ? error.message : 'Too many requests'}`);\n    }\n\n    this.routingMetrics.totalRequests++;\n\n    // Security: Validate agent names\n    const validatedAgents: string[] = [];\n    if (request.preferredAgent) {\n      validatedAgents.push(InputValidator.validateAgentName(request.preferredAgent));\n    }\n    if (request.fallbackAgents) {\n      const validated = InputValidator.validateStringArray(\n        request.fallbackAgents,\n        'fallbackAgents',\n        10,\n        100\n      );\n      validatedAgents.push(...validated.map(a => InputValidator.validateAgentName(a)));\n    }\n\n    // Determine agent chain: preferred -> fallbacks\n    const agentChain = validatedAgents;\n\n    if (agentChain.length === 0) {\n      throw new Error('No agents specified in route request');\n    }\n\n    let selectedAgent: string | null = null;\n    let fallbackUsed = false;\n    let circuitState = CircuitState.CLOSED;\n\n    // Try each agent in chain\n    for (let i = 0; i < agentChain.length; i++) {\n      const agent = agentChain[i];\n      const state = this.getCircuitState(agent);\n\n      if (state === CircuitState.CLOSED) {\n        // Circuit closed: use this agent\n        selectedAgent = agent;\n        circuitState = state;\n        if (i > 0) fallbackUsed = true;\n        break;\n      } else if (state === CircuitState.HALF_OPEN) {\n        // Circuit half-open: allow test request\n        selectedAgent = agent;\n        circuitState = state;\n        if (i > 0) fallbackUsed = true;\n        break;\n      }\n      // Circuit OPEN: try next agent in chain\n    }\n\n    if (!selectedAgent) {\n      // All circuits open: force use last agent with degraded service warning\n      selectedAgent = agentChain[agentChain.length - 1];\n      circuitState = CircuitState.OPEN;\n      fallbackUsed = true;\n      this.routingMetrics.failedRoutes++;\n    }\n\n    // Calculate confidence based on circuit state and failure history\n    const confidence = this.calculateConfidence(selectedAgent, circuitState);\n\n    // Estimate uncertainty if enabled\n    const uncertainty = this.config.enableUncertaintyEstimation\n      ? this.estimateUncertainty(selectedAgent)\n      : undefined;\n\n    const routingTimeMs = performance.now() - startTime;\n\n    // Update metrics\n    if (fallbackUsed) {\n      this.routingMetrics.fallbackRoutes++;\n    } else {\n      this.routingMetrics.successfulRoutes++;\n    }\n\n    this.updateAvgRoutingTime(routingTimeMs);\n\n    return {\n      selectedAgent,\n      confidence,\n      circuitState,\n      fallbackUsed,\n      uncertainty,\n      metrics: {\n        routingTimeMs,\n        failureCount: this.failureCounts.get(selectedAgent) ?? 0,\n        successCount: this.successCounts.get(selectedAgent) ?? 0,\n      },\n    };\n  }\n\n  /**\n   * Record successful agent execution\n   *\n   * Updates circuit breaker state:\n   * - Increment success count\n   * - Reset failure count if threshold reached\n   * - Transition HALF_OPEN -> CLOSED if successful\n   *\n   * @param agent - Agent that succeeded\n   */\n  recordSuccess(agent: string): void {\n    const currentState = this.getCircuitState(agent);\n    const successCount = (this.successCounts.get(agent) ?? 0) + 1;\n\n    this.successCounts.set(agent, successCount);\n    this.lastSuccessTimes.set(agent, Date.now());\n\n    // Reset failure count on success\n    this.failureCounts.set(agent, 0);\n\n    // Transition HALF_OPEN -> CLOSED if enough successes\n    if (currentState === CircuitState.HALF_OPEN) {\n      if (successCount >= this.config.successThreshold) {\n        this.circuitStates.set(agent, CircuitState.CLOSED);\n        this.successCounts.set(agent, 0); // Reset counter\n      }\n    }\n  }\n\n  /**\n   * Record failed agent execution\n   *\n   * Updates circuit breaker state:\n   * - Increment failure count\n   * - Transition CLOSED -> OPEN if threshold exceeded\n   * - Transition HALF_OPEN -> OPEN on failure\n   * - Schedule automatic reset\n   *\n   * @param agent - Agent that failed\n   */\n  recordFailure(agent: string): void {\n    const currentState = this.getCircuitState(agent);\n    const failureCount = (this.failureCounts.get(agent) ?? 0) + 1;\n\n    this.failureCounts.set(agent, failureCount);\n    this.lastFailureTimes.set(agent, Date.now());\n\n    // Transition CLOSED -> OPEN if threshold exceeded\n    if (currentState === CircuitState.CLOSED) {\n      if (failureCount >= this.config.failureThreshold) {\n        this.openCircuit(agent);\n      }\n    }\n\n    // Transition HALF_OPEN -> OPEN on any failure\n    if (currentState === CircuitState.HALF_OPEN) {\n      this.openCircuit(agent);\n    }\n  }\n\n  /**\n   * Get circuit state for agent\n   *\n   * @param agent - Agent name\n   * @returns Current circuit state\n   */\n  getCircuitState(agent: string): CircuitState {\n    return this.circuitStates.get(agent) ?? CircuitState.CLOSED;\n  }\n\n  /**\n   * Get health status for all agents\n   *\n   * @returns Array of agent health metrics\n   */\n  getAgentHealth(): AgentHealth[] {\n    const agents = new Set([\n      ...Array.from(this.circuitStates.keys()),\n      ...Array.from(this.failureCounts.keys()),\n      ...Array.from(this.successCounts.keys()),\n    ]);\n\n    return Array.from(agents).map(agent => {\n      const state = this.getCircuitState(agent);\n      const failureCount = this.failureCounts.get(agent) ?? 0;\n      const successCount = this.successCounts.get(agent) ?? 0;\n      const total = failureCount + successCount;\n      const availability = total > 0 ? successCount / total : 1.0;\n\n      return {\n        agent,\n        state,\n        failureCount,\n        successCount,\n        lastFailureTime: this.lastFailureTimes.get(agent),\n        lastSuccessTime: this.lastSuccessTimes.get(agent),\n        availability,\n      };\n    });\n  }\n\n  /**\n   * Get routing metrics\n   *\n   * @returns Cumulative routing statistics\n   */\n  getMetrics(): typeof this.routingMetrics {\n    return { ...this.routingMetrics };\n  }\n\n  /**\n   * Manually reset circuit for agent\n   *\n   * @param agent - Agent to reset\n   */\n  resetCircuit(agent: string): void {\n    this.circuitStates.set(agent, CircuitState.CLOSED);\n    this.failureCounts.set(agent, 0);\n    this.successCounts.set(agent, 0);\n\n    // Clear reset timer if exists\n    const timer = this.resetTimers.get(agent);\n    if (timer) {\n      clearTimeout(timer);\n      this.resetTimers.delete(agent);\n    }\n  }\n\n  /**\n   * Hot-reload configuration\n   *\n   * Allows updating circuit breaker parameters without restart.\n   *\n   * @param config - New configuration\n   */\n  updateConfig(config: Partial<CircuitBreakerConfig>): void {\n    Object.assign(this.config, config);\n  }\n\n  // ========================================================================\n  // Private Helper Methods\n  // ========================================================================\n\n  /**\n   * Open circuit and schedule automatic reset\n   */\n  private openCircuit(agent: string): void {\n    this.circuitStates.set(agent, CircuitState.OPEN);\n\n    // Clear existing timer\n    const existingTimer = this.resetTimers.get(agent);\n    if (existingTimer) {\n      clearTimeout(existingTimer);\n    }\n\n    // Schedule automatic transition to HALF_OPEN\n    const timer = setTimeout(() => {\n      this.circuitStates.set(agent, CircuitState.HALF_OPEN);\n      this.successCounts.set(agent, 0); // Reset success counter for half-open test\n      this.resetTimers.delete(agent);\n    }, this.config.resetTimeout);\n\n    this.resetTimers.set(agent, timer);\n  }\n\n  /**\n   * Calculate confidence score\n   */\n  private calculateConfidence(agent: string, circuitState: CircuitState): number {\n    const successCount = this.successCounts.get(agent) ?? 0;\n    const failureCount = this.failureCounts.get(agent) ?? 0;\n    const total = successCount + failureCount;\n\n    if (total === 0) {\n      return 0.8; // Default confidence for new agents\n    }\n\n    const successRate = successCount / total;\n\n    // Adjust confidence based on circuit state\n    let stateMultiplier: number;\n    switch (circuitState) {\n      case CircuitState.CLOSED:\n        stateMultiplier = 1.0;\n        break;\n      case CircuitState.HALF_OPEN:\n        stateMultiplier = 0.7;\n        break;\n      case CircuitState.OPEN:\n        stateMultiplier = 0.3;\n        break;\n    }\n\n    return successRate * stateMultiplier;\n  }\n\n  /**\n   * Estimate uncertainty for routing decision\n   *\n   * Uses failure history and circuit state to estimate decision uncertainty.\n   * Higher uncertainty indicates less reliable routing.\n   *\n   * @param agent - Agent to estimate uncertainty for\n   * @returns Uncertainty score (0-1, lower is better)\n   */\n  private estimateUncertainty(agent: string): number {\n    const failureCount = this.failureCounts.get(agent) ?? 0;\n    const successCount = this.successCounts.get(agent) ?? 0;\n    const total = failureCount + successCount;\n\n    if (total === 0) {\n      return 0.5; // High uncertainty for untested agents\n    }\n\n    // Uncertainty based on:\n    // 1. Failure rate\n    // 2. Sample size (low samples = high uncertainty)\n    // 3. Recent failures\n\n    const failureRate = failureCount / total;\n    const sampleSizeUncertainty = Math.exp(-total / 10); // Decreases with more samples\n    const recencyFactor = this.getRecencyFactor(agent);\n\n    return (failureRate * 0.5 + sampleSizeUncertainty * 0.3 + recencyFactor * 0.2);\n  }\n\n  /**\n   * Calculate recency factor based on time since last failure\n   */\n  private getRecencyFactor(agent: string): number {\n    const lastFailure = this.lastFailureTimes.get(agent);\n    if (!lastFailure) {\n      return 0; // No recent failures\n    }\n\n    const timeSinceFailure = Date.now() - lastFailure;\n    const halfLife = this.config.resetTimeout / 2;\n\n    // Exponential decay: recent failures have higher weight\n    return Math.exp(-timeSinceFailure / halfLife);\n  }\n\n  /**\n   * Update average routing time (exponential moving average)\n   */\n  private updateAvgRoutingTime(newTime: number): void {\n    const alpha = 0.1; // EMA smoothing factor\n    this.routingMetrics.avgRoutingTimeMs =\n      this.routingMetrics.avgRoutingTimeMs * (1 - alpha) + newTime * alpha;\n  }\n\n  /**\n   * Simple string hash function for rate limiting\n   */\n  private hashString(str: string): string {\n    let hash = 0;\n    for (let i = 0; i < str.length; i++) {\n      const char = str.charCodeAt(i);\n      hash = ((hash << 5) - hash) + char;\n      hash = hash & hash; // Convert to 32-bit integer\n    }\n    return `route-${Math.abs(hash)}`;\n  }\n\n  /**\n   * Cleanup resources on shutdown\n   */\n  destroy(): void {\n    // Clear all reset timers\n    this.resetTimers.forEach((timer) => {\n      clearTimeout(timer);\n    });\n    this.resetTimers.clear();\n\n    // Destroy rate limiter\n    this.rateLimiter.destroy();\n  }\n}\n"]}
{"version":3,"file":"IntelligenceStore.js","sourceRoot":"","sources":["../../src/intelligence/IntelligenceStore.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * IntelligenceStore - SQLite persistence for RuVector intelligence layer\n *\n * Cross-platform (Linux, macOS, Windows) persistent storage for:\n * - Learning trajectories\n * - Routing patterns\n * - SONA adaptations\n * - HNSW vectors\n */\n\nimport Database from 'better-sqlite3';\nimport { existsSync, mkdirSync } from 'fs';\nimport { dirname, join } from 'path';\nimport { homedir } from 'os';\n\nexport interface StoredTrajectory {\n  id: number;\n  taskDescription: string;\n  agent: string;\n  steps: number;\n  outcome: 'success' | 'failure' | 'partial';\n  startTime: number;\n  endTime: number;\n  metadata?: string; // JSON\n}\n\nexport interface StoredPattern {\n  id: number;\n  taskType: string;\n  approach: string;\n  embedding: Buffer; // Float32Array as Buffer\n  similarity: number;\n  usageCount: number;\n  successRate: number;\n  createdAt: number;\n  updatedAt: number;\n}\n\nexport interface StoredRouting {\n  id: number;\n  task: string;\n  recommendedAgent: string;\n  confidence: number;\n  latencyMs: number;\n  wasSuccessful: boolean;\n  timestamp: number;\n}\n\nexport interface LearningStats {\n  totalTrajectories: number;\n  successfulTrajectories: number;\n  totalRoutings: number;\n  successfulRoutings: number;\n  totalPatterns: number;\n  sonaAdaptations: number;\n  hnswQueries: number;\n  lastUpdated: number;\n}\n\nexport class IntelligenceStore {\n  private db: Database.Database;\n  private static instance: IntelligenceStore | null = null;\n\n  private constructor(dbPath: string) {\n    // Ensure directory exists\n    const dir = dirname(dbPath);\n    if (!existsSync(dir)) {\n      mkdirSync(dir, { recursive: true });\n    }\n\n    this.db = new Database(dbPath);\n    this.db.pragma('journal_mode = WAL'); // Better concurrent access\n    this.db.pragma('synchronous = NORMAL'); // Good balance of speed/safety\n\n    this.initSchema();\n  }\n\n  /**\n   * Get singleton instance\n   */\n  static getInstance(dbPath?: string): IntelligenceStore {\n    if (!IntelligenceStore.instance) {\n      const path = dbPath || IntelligenceStore.getDefaultPath();\n      IntelligenceStore.instance = new IntelligenceStore(path);\n    }\n    return IntelligenceStore.instance;\n  }\n\n  /**\n   * Get default database path (cross-platform)\n   */\n  static getDefaultPath(): string {\n    // Check for project-local .agentic-flow directory first\n    const localPath = join(process.cwd(), '.agentic-flow', 'intelligence.db');\n    const localDir = dirname(localPath);\n\n    if (existsSync(localDir)) {\n      return localPath;\n    }\n\n    // Fall back to home directory\n    const homeDir = homedir();\n    return join(homeDir, '.agentic-flow', 'intelligence.db');\n  }\n\n  /**\n   * Initialize database schema\n   */\n  private initSchema(): void {\n    this.db.exec(`\n      -- Trajectories table\n      CREATE TABLE IF NOT EXISTS trajectories (\n        id INTEGER PRIMARY KEY AUTOINCREMENT,\n        task_description TEXT NOT NULL,\n        agent TEXT NOT NULL,\n        steps INTEGER DEFAULT 0,\n        outcome TEXT DEFAULT 'partial',\n        start_time INTEGER NOT NULL,\n        end_time INTEGER,\n        metadata TEXT,\n        created_at INTEGER DEFAULT (strftime('%s', 'now'))\n      );\n\n      -- Patterns table (for ReasoningBank)\n      CREATE TABLE IF NOT EXISTS patterns (\n        id INTEGER PRIMARY KEY AUTOINCREMENT,\n        task_type TEXT NOT NULL,\n        approach TEXT NOT NULL,\n        embedding BLOB,\n        similarity REAL DEFAULT 0,\n        usage_count INTEGER DEFAULT 0,\n        success_rate REAL DEFAULT 0,\n        created_at INTEGER DEFAULT (strftime('%s', 'now')),\n        updated_at INTEGER DEFAULT (strftime('%s', 'now'))\n      );\n\n      -- Routings table\n      CREATE TABLE IF NOT EXISTS routings (\n        id INTEGER PRIMARY KEY AUTOINCREMENT,\n        task TEXT NOT NULL,\n        recommended_agent TEXT NOT NULL,\n        confidence REAL NOT NULL,\n        latency_ms INTEGER NOT NULL,\n        was_successful INTEGER DEFAULT 0,\n        timestamp INTEGER DEFAULT (strftime('%s', 'now'))\n      );\n\n      -- Stats table (single row)\n      CREATE TABLE IF NOT EXISTS stats (\n        id INTEGER PRIMARY KEY CHECK (id = 1),\n        total_trajectories INTEGER DEFAULT 0,\n        successful_trajectories INTEGER DEFAULT 0,\n        total_routings INTEGER DEFAULT 0,\n        successful_routings INTEGER DEFAULT 0,\n        total_patterns INTEGER DEFAULT 0,\n        sona_adaptations INTEGER DEFAULT 0,\n        hnsw_queries INTEGER DEFAULT 0,\n        last_updated INTEGER DEFAULT (strftime('%s', 'now'))\n      );\n\n      -- Initialize stats row if not exists\n      INSERT OR IGNORE INTO stats (id) VALUES (1);\n\n      -- Indexes for faster queries\n      CREATE INDEX IF NOT EXISTS idx_trajectories_agent ON trajectories(agent);\n      CREATE INDEX IF NOT EXISTS idx_trajectories_outcome ON trajectories(outcome);\n      CREATE INDEX IF NOT EXISTS idx_patterns_task_type ON patterns(task_type);\n      CREATE INDEX IF NOT EXISTS idx_routings_agent ON routings(recommended_agent);\n      CREATE INDEX IF NOT EXISTS idx_routings_timestamp ON routings(timestamp);\n    `);\n  }\n\n  // ============ Trajectory Methods ============\n\n  /**\n   * Start a new trajectory\n   */\n  startTrajectory(taskDescription: string, agent: string): number {\n    const stmt = this.db.prepare(`\n      INSERT INTO trajectories (task_description, agent, start_time)\n      VALUES (?, ?, ?)\n    `);\n    const result = stmt.run(taskDescription, agent, Date.now());\n\n    this.incrementStat('total_trajectories');\n\n    return result.lastInsertRowid as number;\n  }\n\n  /**\n   * Add step to trajectory\n   */\n  addTrajectoryStep(trajectoryId: number): void {\n    const stmt = this.db.prepare(`\n      UPDATE trajectories SET steps = steps + 1 WHERE id = ?\n    `);\n    stmt.run(trajectoryId);\n  }\n\n  /**\n   * End trajectory with outcome\n   */\n  endTrajectory(trajectoryId: number, outcome: 'success' | 'failure' | 'partial', metadata?: Record<string, any>): void {\n    const stmt = this.db.prepare(`\n      UPDATE trajectories\n      SET outcome = ?, end_time = ?, metadata = ?\n      WHERE id = ?\n    `);\n    stmt.run(outcome, Date.now(), metadata ? JSON.stringify(metadata) : null, trajectoryId);\n\n    if (outcome === 'success') {\n      this.incrementStat('successful_trajectories');\n    }\n  }\n\n  /**\n   * Get active trajectories (no end_time)\n   */\n  getActiveTrajectories(): StoredTrajectory[] {\n    const stmt = this.db.prepare(`\n      SELECT * FROM trajectories WHERE end_time IS NULL\n    `);\n    return stmt.all() as StoredTrajectory[];\n  }\n\n  /**\n   * Get recent trajectories\n   */\n  getRecentTrajectories(limit: number = 10): StoredTrajectory[] {\n    const stmt = this.db.prepare(`\n      SELECT * FROM trajectories ORDER BY start_time DESC LIMIT ?\n    `);\n    return stmt.all(limit) as StoredTrajectory[];\n  }\n\n  // ============ Pattern Methods ============\n\n  /**\n   * Store a pattern\n   */\n  storePattern(taskType: string, approach: string, embedding?: Float32Array): number {\n    const stmt = this.db.prepare(`\n      INSERT INTO patterns (task_type, approach, embedding)\n      VALUES (?, ?, ?)\n    `);\n    const embeddingBuffer = embedding ? Buffer.from(embedding.buffer) : null;\n    const result = stmt.run(taskType, approach, embeddingBuffer);\n\n    this.incrementStat('total_patterns');\n\n    return result.lastInsertRowid as number;\n  }\n\n  /**\n   * Update pattern usage\n   */\n  updatePatternUsage(patternId: number, wasSuccessful: boolean): void {\n    const stmt = this.db.prepare(`\n      UPDATE patterns\n      SET usage_count = usage_count + 1,\n          success_rate = (success_rate * usage_count + ?) / (usage_count + 1),\n          updated_at = strftime('%s', 'now')\n      WHERE id = ?\n    `);\n    stmt.run(wasSuccessful ? 1 : 0, patternId);\n  }\n\n  /**\n   * Find patterns by task type\n   */\n  findPatterns(taskType: string, limit: number = 5): StoredPattern[] {\n    const stmt = this.db.prepare(`\n      SELECT * FROM patterns\n      WHERE task_type LIKE ?\n      ORDER BY success_rate DESC, usage_count DESC\n      LIMIT ?\n    `);\n    return stmt.all(`%${taskType}%`, limit) as StoredPattern[];\n  }\n\n  // ============ Routing Methods ============\n\n  /**\n   * Record a routing decision\n   */\n  recordRouting(task: string, recommendedAgent: string, confidence: number, latencyMs: number): number {\n    const stmt = this.db.prepare(`\n      INSERT INTO routings (task, recommended_agent, confidence, latency_ms)\n      VALUES (?, ?, ?, ?)\n    `);\n    const result = stmt.run(task, recommendedAgent, confidence, latencyMs);\n\n    this.incrementStat('total_routings');\n\n    return result.lastInsertRowid as number;\n  }\n\n  /**\n   * Update routing outcome\n   */\n  updateRoutingOutcome(routingId: number, wasSuccessful: boolean): void {\n    const stmt = this.db.prepare(`\n      UPDATE routings SET was_successful = ? WHERE id = ?\n    `);\n    stmt.run(wasSuccessful ? 1 : 0, routingId);\n\n    if (wasSuccessful) {\n      this.incrementStat('successful_routings');\n    }\n  }\n\n  /**\n   * Get routing accuracy for an agent\n   */\n  getAgentAccuracy(agent: string): { total: number; successful: number; accuracy: number } {\n    const stmt = this.db.prepare(`\n      SELECT\n        COUNT(*) as total,\n        SUM(was_successful) as successful\n      FROM routings\n      WHERE recommended_agent = ?\n    `);\n    const result = stmt.get(agent) as { total: number; successful: number };\n    return {\n      total: result.total || 0,\n      successful: result.successful || 0,\n      accuracy: result.total > 0 ? (result.successful || 0) / result.total : 0,\n    };\n  }\n\n  // ============ Stats Methods ============\n\n  /**\n   * Get all stats\n   */\n  getStats(): LearningStats {\n    const stmt = this.db.prepare(`SELECT * FROM stats WHERE id = 1`);\n    const row = stmt.get() as any;\n\n    return {\n      totalTrajectories: row?.total_trajectories || 0,\n      successfulTrajectories: row?.successful_trajectories || 0,\n      totalRoutings: row?.total_routings || 0,\n      successfulRoutings: row?.successful_routings || 0,\n      totalPatterns: row?.total_patterns || 0,\n      sonaAdaptations: row?.sona_adaptations || 0,\n      hnswQueries: row?.hnsw_queries || 0,\n      lastUpdated: row?.last_updated || Date.now(),\n    };\n  }\n\n  /**\n   * Increment a stat counter\n   */\n  incrementStat(statName: string, amount: number = 1): void {\n    const stmt = this.db.prepare(`\n      UPDATE stats SET ${statName} = ${statName} + ?, last_updated = strftime('%s', 'now')\n      WHERE id = 1\n    `);\n    stmt.run(amount);\n  }\n\n  /**\n   * Record SONA adaptation\n   */\n  recordSonaAdaptation(): void {\n    this.incrementStat('sona_adaptations');\n  }\n\n  /**\n   * Record HNSW query\n   */\n  recordHnswQuery(): void {\n    this.incrementStat('hnsw_queries');\n  }\n\n  // ============ Utility Methods ============\n\n  /**\n   * Get summary for display (simplified for UI)\n   */\n  getSummary(): {\n    trajectories: number;\n    routings: number;\n    patterns: number;\n    operations: number;\n  } {\n    const stats = this.getStats();\n\n    return {\n      trajectories: stats.totalTrajectories,\n      routings: stats.totalRoutings,\n      patterns: stats.totalPatterns,\n      operations: stats.sonaAdaptations + stats.hnswQueries,\n    };\n  }\n\n  /**\n   * Get detailed summary for reports\n   */\n  getDetailedSummary(): {\n    trajectories: { total: number; active: number; successful: number };\n    routings: { total: number; accuracy: number };\n    patterns: number;\n    operations: { sona: number; hnsw: number };\n  } {\n    const stats = this.getStats();\n    const activeCount = this.getActiveTrajectories().length;\n\n    return {\n      trajectories: {\n        total: stats.totalTrajectories,\n        active: activeCount,\n        successful: stats.successfulTrajectories,\n      },\n      routings: {\n        total: stats.totalRoutings,\n        accuracy: stats.totalRoutings > 0\n          ? stats.successfulRoutings / stats.totalRoutings\n          : 0,\n      },\n      patterns: stats.totalPatterns,\n      operations: {\n        sona: stats.sonaAdaptations,\n        hnsw: stats.hnswQueries,\n      },\n    };\n  }\n\n  /**\n   * Close database connection\n   */\n  close(): void {\n    this.db.close();\n    IntelligenceStore.instance = null;\n  }\n\n  /**\n   * Reset all data (for testing)\n   */\n  reset(): void {\n    this.db.exec(`\n      DELETE FROM trajectories;\n      DELETE FROM patterns;\n      DELETE FROM routings;\n      UPDATE stats SET\n        total_trajectories = 0,\n        successful_trajectories = 0,\n        total_routings = 0,\n        successful_routings = 0,\n        total_patterns = 0,\n        sona_adaptations = 0,\n        hnsw_queries = 0,\n        last_updated = strftime('%s', 'now')\n      WHERE id = 1;\n    `);\n  }\n}\n\n// Export singleton getter\nexport function getIntelligenceStore(dbPath?: string): IntelligenceStore {\n  return IntelligenceStore.getInstance(dbPath);\n}\n"]}
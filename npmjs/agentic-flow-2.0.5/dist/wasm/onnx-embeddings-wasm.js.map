{"version":3,"file":"onnx-embeddings-wasm.js","sourceRoot":"","sources":["../../src/wasm/onnx-embeddings-wasm.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * ONNX Embeddings WASM Integration\n *\n * Provides browser-compatible embeddings using ruvector-onnx-embeddings-wasm.\n *\n * Features:\n * - Pure WASM: No native dependencies, runs in browser\n * - all-MiniLM-L6-v2: 384-dimensional semantic embeddings\n * - SIMD Acceleration: Uses WebAssembly SIMD when available\n * - Small Bundle: Optimized WASM binary size\n *\n * Use Cases:\n * - Browser-based semantic search\n * - Client-side RAG applications\n * - Edge computing (Cloudflare Workers, Deno Deploy)\n * - Offline-first applications\n *\n * Performance:\n * - ~50ms per embedding (SIMD enabled)\n * - ~200ms per embedding (SIMD disabled)\n * - Batch processing: ~30ms per embedding\n */\n\nimport { logger } from '../utils/logger.js';\n\n// Module state\nlet wasmModule: OnnxEmbeddingsModule | null = null;\nlet initialized = false;\nlet initPromise: Promise<boolean> | null = null;\n\n/**\n * ONNX Embeddings WASM module interface\n */\ninterface OnnxEmbeddingsModule {\n  // Core functions\n  embed: (text: string) => Promise<Float32Array>;\n  embedBatch: (texts: string[]) => Promise<Float32Array[]>;\n  similarity: (text1: string, text2: string) => Promise<number>;\n  cosineSimilarity: (a: Float32Array, b: Float32Array) => number;\n\n  // Model management\n  loadModel: (modelPath?: string) => Promise<void>;\n  isModelLoaded: () => boolean;\n  getModelInfo: () => ModelInfo;\n\n  // Utilities\n  isAvailable: () => boolean;\n  isSIMDEnabled: () => boolean;\n  getVersion: () => string;\n\n  // Lifecycle\n  initialize: () => Promise<void>;\n  shutdown: () => Promise<void>;\n}\n\ninterface ModelInfo {\n  name: string;\n  dimension: number;\n  vocabSize: number;\n  maxSequenceLength: number;\n}\n\nexport interface OnnxEmbeddingResult {\n  embedding: Float32Array;\n  timeMs: number;\n  source: 'wasm' | 'fallback';\n}\n\nexport interface OnnxBatchResult {\n  embeddings: Float32Array[];\n  totalTimeMs: number;\n  avgTimeMs: number;\n  source: 'wasm' | 'fallback';\n}\n\nexport interface OnnxEmbeddingsStats {\n  available: boolean;\n  simdEnabled: boolean;\n  modelLoaded: boolean;\n  modelInfo?: ModelInfo;\n  totalEmbeddings: number;\n  totalLatencyMs: number;\n  avgLatencyMs: number;\n}\n\n// Stats tracking\nlet stats = {\n  totalEmbeddings: 0,\n  totalLatencyMs: 0,\n};\n\n/**\n * Initialize ONNX Embeddings WASM module\n */\nexport async function initOnnxEmbeddingsWasm(): Promise<boolean> {\n  if (initialized) return wasmModule !== null;\n  if (initPromise) return initPromise;\n\n  initPromise = (async () => {\n    try {\n      const mod = await import('ruvector-onnx-embeddings-wasm');\n      wasmModule = mod as unknown as OnnxEmbeddingsModule;\n\n      // Initialize WASM runtime\n      if (wasmModule.initialize) {\n        await wasmModule.initialize();\n      }\n\n      // Load default model\n      if (wasmModule.loadModel && !wasmModule.isModelLoaded?.()) {\n        await wasmModule.loadModel();\n      }\n\n      initialized = true;\n\n      logger.info('ONNX Embeddings WASM initialized', {\n        version: wasmModule.getVersion?.() || 'unknown',\n        simd: wasmModule.isSIMDEnabled?.() ?? false,\n        modelLoaded: wasmModule.isModelLoaded?.() ?? false,\n      });\n\n      return true;\n    } catch (error) {\n      logger.debug('ONNX Embeddings WASM not available', { error });\n      initialized = true;\n      return false;\n    }\n  })();\n\n  return initPromise;\n}\n\n/**\n * Check if ONNX WASM embeddings are available\n */\nexport function isOnnxWasmAvailable(): boolean {\n  return wasmModule !== null && (wasmModule.isAvailable?.() ?? false);\n}\n\n/**\n * Check if SIMD acceleration is enabled\n */\nexport function isSIMDEnabled(): boolean {\n  return wasmModule?.isSIMDEnabled?.() ?? false;\n}\n\n/**\n * Generate embedding for text using WASM\n */\nexport async function embed(text: string): Promise<OnnxEmbeddingResult> {\n  if (!initialized) {\n    await initOnnxEmbeddingsWasm();\n  }\n\n  const startTime = performance.now();\n\n  if (wasmModule && wasmModule.isModelLoaded?.()) {\n    try {\n      const embedding = await wasmModule.embed(text);\n      const timeMs = performance.now() - startTime;\n\n      stats.totalEmbeddings++;\n      stats.totalLatencyMs += timeMs;\n\n      return {\n        embedding,\n        timeMs,\n        source: 'wasm',\n      };\n    } catch (error) {\n      logger.warn('WASM embedding failed, using fallback', { error });\n    }\n  }\n\n  // Fallback to simple hash-based embedding\n  const embedding = simpleEmbed(text);\n  const timeMs = performance.now() - startTime;\n\n  stats.totalEmbeddings++;\n  stats.totalLatencyMs += timeMs;\n\n  return {\n    embedding,\n    timeMs,\n    source: 'fallback',\n  };\n}\n\n/**\n * Generate embeddings for multiple texts (batch processing)\n */\nexport async function embedBatch(texts: string[]): Promise<OnnxBatchResult> {\n  if (!initialized) {\n    await initOnnxEmbeddingsWasm();\n  }\n\n  const startTime = performance.now();\n\n  if (wasmModule && wasmModule.embedBatch && wasmModule.isModelLoaded?.()) {\n    try {\n      const embeddings = await wasmModule.embedBatch(texts);\n      const totalTimeMs = performance.now() - startTime;\n\n      stats.totalEmbeddings += texts.length;\n      stats.totalLatencyMs += totalTimeMs;\n\n      return {\n        embeddings,\n        totalTimeMs,\n        avgTimeMs: totalTimeMs / texts.length,\n        source: 'wasm',\n      };\n    } catch (error) {\n      logger.warn('WASM batch embedding failed, using fallback', { error });\n    }\n  }\n\n  // Fallback to sequential simple embeddings\n  const embeddings = texts.map((text) => simpleEmbed(text));\n  const totalTimeMs = performance.now() - startTime;\n\n  stats.totalEmbeddings += texts.length;\n  stats.totalLatencyMs += totalTimeMs;\n\n  return {\n    embeddings,\n    totalTimeMs,\n    avgTimeMs: totalTimeMs / texts.length,\n    source: 'fallback',\n  };\n}\n\n/**\n * Compute similarity between two texts\n */\nexport async function similarity(text1: string, text2: string): Promise<number> {\n  if (wasmModule && wasmModule.similarity) {\n    try {\n      return await wasmModule.similarity(text1, text2);\n    } catch {\n      // Fall through to fallback\n    }\n  }\n\n  // Fallback\n  const [result1, result2] = await Promise.all([embed(text1), embed(text2)]);\n  return cosineSimilarity(result1.embedding, result2.embedding);\n}\n\n/**\n * Compute cosine similarity between two embeddings\n */\nexport function cosineSimilarity(a: Float32Array, b: Float32Array): number {\n  if (wasmModule?.cosineSimilarity) {\n    return wasmModule.cosineSimilarity(a, b);\n  }\n\n  // JS fallback\n  let dot = 0;\n  let normA = 0;\n  let normB = 0;\n\n  for (let i = 0; i < a.length; i++) {\n    dot += a[i] * b[i];\n    normA += a[i] * a[i];\n    normB += b[i] * b[i];\n  }\n\n  const denominator = Math.sqrt(normA) * Math.sqrt(normB);\n  return denominator === 0 ? 0 : dot / denominator;\n}\n\n/**\n * Get embedding statistics\n */\nexport function getStats(): OnnxEmbeddingsStats {\n  const modelInfo = wasmModule?.getModelInfo?.();\n\n  return {\n    available: isOnnxWasmAvailable(),\n    simdEnabled: isSIMDEnabled(),\n    modelLoaded: wasmModule?.isModelLoaded?.() ?? false,\n    modelInfo,\n    totalEmbeddings: stats.totalEmbeddings,\n    totalLatencyMs: stats.totalLatencyMs,\n    avgLatencyMs: stats.totalEmbeddings > 0 ? stats.totalLatencyMs / stats.totalEmbeddings : 0,\n  };\n}\n\n/**\n * Shutdown WASM module\n */\nexport async function shutdown(): Promise<void> {\n  if (wasmModule?.shutdown) {\n    await wasmModule.shutdown();\n  }\n  wasmModule = null;\n  initialized = false;\n  initPromise = null;\n}\n\n/**\n * Reset stats (for testing)\n */\nexport function resetStats(): void {\n  stats = { totalEmbeddings: 0, totalLatencyMs: 0 };\n}\n\n/**\n * Simple hash-based embedding fallback\n * Not semantic, but provides consistent embeddings for testing\n */\nfunction simpleEmbed(text: string, dim: number = 384): Float32Array {\n  const embedding = new Float32Array(dim);\n\n  // Multi-pass hash for better distribution\n  for (let i = 0; i < text.length; i++) {\n    const code = text.charCodeAt(i);\n    embedding[i % dim] += code / 255;\n    embedding[(i * 7) % dim] += (code * 0.3) / 255;\n    embedding[(i * 13) % dim] += (code * 0.2) / 255;\n  }\n\n  // Normalize\n  let norm = 0;\n  for (let i = 0; i < dim; i++) {\n    norm += embedding[i] * embedding[i];\n  }\n  norm = Math.sqrt(norm) || 1;\n  for (let i = 0; i < dim; i++) {\n    embedding[i] /= norm;\n  }\n\n  return embedding;\n}\n\n/**\n * OnnxEmbeddingsWasm class for object-oriented usage\n */\nexport class OnnxEmbeddingsWasm {\n  private initialized = false;\n\n  async init(): Promise<boolean> {\n    this.initialized = await initOnnxEmbeddingsWasm();\n    return this.initialized;\n  }\n\n  async embed(text: string): Promise<OnnxEmbeddingResult> {\n    if (!this.initialized) await this.init();\n    return embed(text);\n  }\n\n  async embedBatch(texts: string[]): Promise<OnnxBatchResult> {\n    if (!this.initialized) await this.init();\n    return embedBatch(texts);\n  }\n\n  async similarity(text1: string, text2: string): Promise<number> {\n    if (!this.initialized) await this.init();\n    return similarity(text1, text2);\n  }\n\n  cosineSimilarity(a: Float32Array, b: Float32Array): number {\n    return cosineSimilarity(a, b);\n  }\n\n  isAvailable(): boolean {\n    return isOnnxWasmAvailable();\n  }\n\n  isSIMDEnabled(): boolean {\n    return isSIMDEnabled();\n  }\n\n  getStats(): OnnxEmbeddingsStats {\n    return getStats();\n  }\n\n  async shutdown(): Promise<void> {\n    await shutdown();\n    this.initialized = false;\n  }\n}\n\n// Singleton instance\nlet instance: OnnxEmbeddingsWasm | null = null;\n\n/**\n * Get singleton OnnxEmbeddingsWasm instance\n */\nexport function getOnnxEmbeddingsWasm(): OnnxEmbeddingsWasm {\n  if (!instance) {\n    instance = new OnnxEmbeddingsWasm();\n  }\n  return instance;\n}\n\nexport default {\n  OnnxEmbeddingsWasm,\n  getOnnxEmbeddingsWasm,\n  initOnnxEmbeddingsWasm,\n  isOnnxWasmAvailable,\n  isSIMDEnabled,\n  embed,\n  embedBatch,\n  similarity,\n  cosineSimilarity,\n  getStats,\n  shutdown,\n  resetStats,\n};\n"]}
{"version":3,"file":"pre-edit.js","sourceRoot":"","sources":["../../../../../src/mcp/fastmcp/tools/hooks/pre-edit.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Pre-Edit Hook - Context retrieval and agent routing before file edit\n * Latency target: <20ms\n *\n * NOW WITH RUVECTOR INTELLIGENCE:\n * - Trajectory tracking for learning from edit sequences\n * - HNSW-powered similar file retrieval\n * - SONA pattern matching for agent selection\n */\n\nimport { z } from 'zod';\nimport * as path from 'path';\nimport type { ToolDefinition } from '../../types/index.js';\nimport {\n  loadIntelligence,\n  getAgentForFile,\n  simpleEmbed,\n  cosineSimilarity\n} from './shared.js';\nimport {\n  beginTaskTrajectory,\n  findSimilarPatterns,\n  getIntelligenceStats\n} from './intelligence-bridge.js';\n\n// Store active trajectory IDs for continuation in post-edit\nconst activeEditTrajectories = new Map<string, number>();\n\n// Export for post-edit to access\nexport { activeEditTrajectories };\n\nexport const hookPreEditTool: ToolDefinition = {\n  name: 'hook_pre_edit',\n  description: 'Pre-edit intelligence: retrieve context, suggest agent, find related files',\n  parameters: z.object({\n    filePath: z.string().describe('Path to file being edited'),\n    task: z.string().optional().describe('Optional task description')\n  }),\n  execute: async ({ filePath, task }, { onProgress }) => {\n    const startTime = Date.now();\n    const intel = loadIntelligence();\n    const ext = path.extname(filePath);\n    const dir = path.dirname(filePath);\n\n    // START TRAJECTORY TRACKING (RuVector Intelligence)\n    let trajectoryId: number | null = null;\n    let intelligenceEnabled = false;\n    let similarPatterns: Array<{ task: string; resolution: string; similarity: number }> = [];\n\n    try {\n      // Begin trajectory for this edit\n      const taskDesc = task || `Edit ${path.basename(filePath)}`;\n      const trajectoryResult = await beginTaskTrajectory(taskDesc, getAgentForFile(filePath));\n\n      if (trajectoryResult.success && trajectoryResult.trajectoryId >= 0) {\n        trajectoryId = trajectoryResult.trajectoryId;\n        activeEditTrajectories.set(filePath, trajectoryId);\n        intelligenceEnabled = true;\n      }\n\n      // Find similar past edits using HNSW (150x faster)\n      similarPatterns = await findSimilarPatterns(taskDesc, 3);\n    } catch (error) {\n      // Continue without trajectory if intelligence not available\n      console.debug('[PreEdit] Intelligence not available:', error);\n    }\n\n    // 1. Determine suggested agent from patterns\n    const state = `edit:${ext}`;\n    let suggestedAgent = getAgentForFile(filePath);\n    let confidence = 0.5;\n\n    // Check learned patterns\n    if (intel.patterns[state]) {\n      const agents = intel.patterns[state];\n      let bestAgent = suggestedAgent;\n      let bestScore = 0;\n\n      for (const [agent, score] of Object.entries(agents)) {\n        if (score > bestScore) {\n          bestScore = score;\n          bestAgent = agent;\n        }\n      }\n\n      if (bestScore > 0) {\n        suggestedAgent = bestAgent;\n        confidence = Math.min(0.9, 0.5 + bestScore / 10);\n      }\n    }\n\n    // Check directory patterns\n    if (intel.dirPatterns[dir]) {\n      suggestedAgent = intel.dirPatterns[dir];\n      confidence = Math.max(confidence, 0.6);\n    }\n\n    // 2. Find related files from co-edit sequences\n    const relatedFiles: Array<{ file: string; score: number }> = [];\n    if (intel.sequences[filePath]) {\n      relatedFiles.push(\n        ...intel.sequences[filePath]\n          .sort((a, b) => b.score - a.score)\n          .slice(0, 5)\n      );\n    }\n\n    // 3. Retrieve relevant memories\n    const memories: Array<{ content: string; score: number }> = [];\n    if (task && intel.memories.length > 0) {\n      const taskEmbed = simpleEmbed(task);\n\n      for (const mem of intel.memories) {\n        if (mem.embedding) {\n          const score = cosineSimilarity(taskEmbed, mem.embedding);\n          if (score > 0.3) {\n            memories.push({ content: mem.content.slice(0, 200), score });\n          }\n        }\n      }\n\n      memories.sort((a, b) => b.score - a.score);\n      memories.splice(3); // Keep top 3\n    }\n\n    // 4. Check for relevant error patterns\n    const errorHints: string[] = [];\n    for (const ep of intel.errorPatterns) {\n      if (ep.context.includes(ext) || ep.context.includes(path.basename(filePath))) {\n        errorHints.push(ep.resolution);\n      }\n    }\n\n    const latency = Date.now() - startTime;\n\n    return {\n      success: true,\n      suggestedAgent,\n      confidence,\n      relatedFiles,\n      memories,\n      errorHints: errorHints.slice(0, 2),\n      // RuVector Intelligence additions\n      trajectoryId,\n      intelligenceEnabled,\n      similarPatterns: similarPatterns.slice(0, 3),\n      latencyMs: latency,\n      timestamp: new Date().toISOString()\n    };\n  }\n};\n"]}
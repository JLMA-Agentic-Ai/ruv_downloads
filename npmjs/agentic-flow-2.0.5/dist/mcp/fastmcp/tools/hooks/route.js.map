{"version":3,"file":"route.js","sourceRoot":"","sources":["../../../../../src/mcp/fastmcp/tools/hooks/route.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Route Hook - Intelligent agent selection with SONA-style routing\n * Uses learned patterns, context, and exploration/exploitation balance\n *\n * NOW WITH FULL RUVECTOR INTELLIGENCE:\n * - @ruvector/sona: Micro-LoRA (~0.05ms), trajectories\n * - @ruvector/attention: MoE attention-based ranking\n * - ruvector: HNSW indexing (150x faster search)\n */\n\nimport { z } from 'zod';\nimport * as path from 'path';\nimport type { ToolDefinition } from '../../types/index.js';\nimport {\n  loadIntelligence,\n  getAgentForFile,\n  simpleEmbed,\n  cosineSimilarity,\n  agentMapping\n} from './shared.js';\nimport {\n  routeTaskIntelligent,\n  findSimilarPatterns,\n  getIntelligenceStats\n} from './intelligence-bridge.js';\n\n// Exploration rate for epsilon-greedy selection\nconst EXPLORATION_RATE = 0.1;\n\n// Flag to use RuVector intelligence (can be toggled)\nconst USE_RUVECTOR_INTELLIGENCE = process.env.RUVECTOR_INTELLIGENCE_ENABLED !== 'false';\n\n// Available agent types\nconst availableAgents = [\n  'coder',\n  'researcher',\n  'analyst',\n  'optimizer',\n  'coordinator',\n  'typescript-developer',\n  'rust-developer',\n  'python-developer',\n  'go-developer',\n  'react-developer',\n  'test-engineer',\n  'documentation-specialist',\n  'database-specialist',\n  'devops-engineer',\n  'cicd-engineer',\n  'security-specialist',\n  'frontend-developer',\n  'backend-developer'\n];\n\nexport const hookRouteTool: ToolDefinition = {\n  name: 'hook_route',\n  description: 'Route task to optimal agent using learned patterns and context',\n  parameters: z.object({\n    task: z.string().describe('Task description'),\n    context: z.object({\n      file: z.string().optional(),\n      recentFiles: z.array(z.string()).optional(),\n      errorContext: z.string().optional()\n    }).optional().describe('Optional context'),\n    explore: z.boolean().optional().default(false).describe('Force exploration')\n  }),\n  execute: async ({ task, context, explore }, { onProgress }) => {\n    const startTime = Date.now();\n\n    // TRY RUVECTOR INTELLIGENCE FIRST (Micro-LoRA + HNSW + MoE)\n    if (USE_RUVECTOR_INTELLIGENCE && !explore) {\n      try {\n        const intelligentResult = await routeTaskIntelligent(task, context);\n\n        // Also check for similar patterns from ReasoningBank\n        const similarPatterns = await findSimilarPatterns(task, 3);\n\n        // Get stats for monitoring\n        const stats = await getIntelligenceStats();\n\n        return {\n          success: true,\n          agent: intelligentResult.agent,\n          confidence: intelligentResult.confidence,\n          score: intelligentResult.routingResults[0]?.confidence || 0,\n          factors: [\n            {\n              name: 'ruvector_intelligence',\n              weight: 3.0,\n              agent: intelligentResult.agent,\n              evidence: `SONA + MoE routing in ${intelligentResult.latencyMs.toFixed(2)}ms`\n            },\n            ...intelligentResult.usedFeatures.map(f => ({\n              name: f,\n              weight: 1.0,\n              agent: intelligentResult.agent,\n              evidence: `Used ${f} for routing`\n            }))\n          ],\n          alternatives: intelligentResult.routingResults.slice(1, 4).map(r => ({\n            agent: r.agentId,\n            score: r.confidence,\n            whyNot: `Score ${r.confidence.toFixed(2)} < best`\n          })),\n          similarPatterns: similarPatterns.slice(0, 2),\n          explored: false,\n          latencyMs: Date.now() - startTime,\n          timestamp: new Date().toISOString(),\n          intelligenceStats: stats,\n          engine: 'ruvector' // Mark that we used RuVector\n        };\n      } catch (error) {\n        // Fall back to simple routing if intelligence fails\n        console.warn('[Route] RuVector intelligence failed, using fallback:', error);\n      }\n    }\n\n    // FALLBACK: Simple Q-learning routing (original implementation)\n    const intel = loadIntelligence();\n\n    // Track scoring factors\n    const factors: Array<{\n      name: string;\n      weight: number;\n      agent: string;\n      evidence: string;\n    }> = [];\n\n    // Agent scores\n    const scores: Record<string, number> = {};\n    for (const agent of availableAgents) {\n      scores[agent] = 0;\n    }\n\n    // 1. Score based on file context\n    if (context?.file) {\n      const ext = path.extname(context.file);\n      const fileAgent = getAgentForFile(context.file);\n      scores[fileAgent] = (scores[fileAgent] || 0) + 2.0;\n\n      factors.push({\n        name: 'file_pattern',\n        weight: 2.0,\n        agent: fileAgent,\n        evidence: `File ${context.file} matches ${fileAgent}`\n      });\n\n      // Check learned patterns for this extension\n      const state = `edit:${ext}`;\n      if (intel.patterns[state]) {\n        for (const [agent, value] of Object.entries(intel.patterns[state])) {\n          if (typeof value === 'number') {\n            scores[agent] = (scores[agent] || 0) + value;\n            if (value > 0.5) {\n              factors.push({\n                name: 'learned_pattern',\n                weight: value,\n                agent,\n                evidence: `Q-value ${value.toFixed(2)} for ${ext} edits`\n              });\n            }\n          }\n        }\n      }\n    }\n\n    // 2. Score based on task keywords\n    const taskLower = task.toLowerCase();\n    const keywordScores: Record<string, string[]> = {\n      'test-engineer': ['test', 'spec', 'coverage', 'mock', 'assert'],\n      'documentation-specialist': ['document', 'readme', 'docs', 'explain', 'comment'],\n      'security-specialist': ['security', 'auth', 'encrypt', 'vulnerability', 'owasp'],\n      'database-specialist': ['database', 'sql', 'query', 'migration', 'schema'],\n      'devops-engineer': ['docker', 'deploy', 'ci', 'cd', 'kubernetes', 'container'],\n      'frontend-developer': ['ui', 'component', 'style', 'css', 'layout'],\n      'backend-developer': ['api', 'endpoint', 'server', 'route', 'middleware'],\n      'optimizer': ['optimize', 'performance', 'speed', 'cache', 'memory'],\n      'researcher': ['research', 'find', 'search', 'explore', 'understand'],\n      'analyst': ['analyze', 'review', 'audit', 'check', 'evaluate']\n    };\n\n    for (const [agent, keywords] of Object.entries(keywordScores)) {\n      for (const keyword of keywords) {\n        if (taskLower.includes(keyword)) {\n          scores[agent] = (scores[agent] || 0) + 1.5;\n          factors.push({\n            name: 'keyword_match',\n            weight: 1.5,\n            agent,\n            evidence: `Task contains \"${keyword}\"`\n          });\n          break; // Only count once per agent\n        }\n      }\n    }\n\n    // 3. Score based on memory similarity\n    if (intel.memories.length > 0) {\n      const taskEmbed = simpleEmbed(task);\n\n      for (const mem of intel.memories) {\n        if (mem.embedding && mem.type === 'success') {\n          const similarity = cosineSimilarity(taskEmbed, mem.embedding);\n          if (similarity > 0.4) {\n            // Extract agent from memory content\n            const agentMatch = mem.content.match(/by (\\S+)/);\n            if (agentMatch && scores[agentMatch[1]] !== undefined) {\n              scores[agentMatch[1]] += similarity;\n              factors.push({\n                name: 'memory_match',\n                weight: similarity,\n                agent: agentMatch[1],\n                evidence: `Similar to: ${mem.content.slice(0, 50)}...`\n              });\n            }\n          }\n        }\n      }\n    }\n\n    // 4. Check for error context\n    if (context?.errorContext) {\n      for (const ep of intel.errorPatterns) {\n        if (context.errorContext.includes(ep.errorType)) {\n          // Find agent with best success rate for this error\n          let bestAgent = 'coder';\n          let bestScore = 0;\n\n          for (const [agent, score] of Object.entries(ep.agentSuccess)) {\n            if (score > bestScore) {\n              bestScore = score;\n              bestAgent = agent;\n            }\n          }\n\n          if (bestScore > 0) {\n            scores[bestAgent] = (scores[bestAgent] || 0) + 2.0;\n            factors.push({\n              name: 'error_specialist',\n              weight: 2.0,\n              agent: bestAgent,\n              evidence: `Best at fixing ${ep.errorType}`\n            });\n          }\n        }\n      }\n    }\n\n    // 5. Select best agent (with exploration)\n    let selectedAgent = 'coder';\n    let maxScore = 0;\n\n    // Epsilon-greedy: explore with probability EXPLORATION_RATE\n    if (explore || Math.random() < EXPLORATION_RATE) {\n      // Random selection for exploration\n      const agentsWithScores = Object.keys(scores).filter(a => scores[a] > 0);\n      if (agentsWithScores.length > 0) {\n        selectedAgent = agentsWithScores[Math.floor(Math.random() * agentsWithScores.length)];\n      } else {\n        selectedAgent = availableAgents[Math.floor(Math.random() * availableAgents.length)];\n      }\n      factors.push({\n        name: 'exploration',\n        weight: 0,\n        agent: selectedAgent,\n        evidence: 'Random exploration for learning'\n      });\n    } else {\n      // Exploitation: select best\n      for (const [agent, score] of Object.entries(scores)) {\n        if (score > maxScore) {\n          maxScore = score;\n          selectedAgent = agent;\n        }\n      }\n    }\n\n    // Calculate confidence\n    const totalScore = Object.values(scores).reduce((a, b) => a + b, 0);\n    const confidence = totalScore > 0 ? maxScore / totalScore : 0.5;\n\n    // Get alternatives\n    const alternatives = Object.entries(scores)\n      .filter(([agent]) => agent !== selectedAgent)\n      .sort((a, b) => b[1] - a[1])\n      .slice(0, 3)\n      .map(([agent, score]) => ({\n        agent,\n        score,\n        whyNot: score < maxScore ? `Score ${score.toFixed(2)} < ${maxScore.toFixed(2)}` : 'Not selected'\n      }));\n\n    const latency = Date.now() - startTime;\n\n    return {\n      success: true,\n      agent: selectedAgent,\n      confidence: Math.min(0.95, confidence),\n      score: maxScore,\n      factors: factors.slice(0, 5),\n      alternatives,\n      explored: explore || Math.random() < EXPLORATION_RATE,\n      latencyMs: latency,\n      timestamp: new Date().toISOString()\n    };\n  }\n};\n"]}
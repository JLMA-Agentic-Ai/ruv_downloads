{"version":3,"file":"adapters.js","sourceRoot":"","sources":["../../../src/billing/storage/adapters.ts"],"names":[],"mappings":"AAAA;;;GAGG;AAYH;;GAEG;AACH,MAAM,OAAO,oBAAoB;IACvB,aAAa,GAAG,IAAI,GAAG,EAAwB,CAAC;IAChD,YAAY,GAAG,IAAI,GAAG,EAAyB,CAAC;IAChD,OAAO,GAAG,IAAI,GAAG,EAAkB,CAAC;IACpC,QAAQ,GAAG,IAAI,GAAG,EAAmB,CAAC;IACtC,MAAM,GAAG,IAAI,GAAG,EAA0B,CAAC;IAEnD,gBAAgB;IAChB,KAAK,CAAC,gBAAgB,CAAC,YAA0B;QAC/C,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,YAAY,CAAC,EAAE,EAAE,EAAE,GAAG,YAAY,EAAE,CAAC,CAAC;IAC/D,CAAC;IAED,KAAK,CAAC,eAAe,CAAC,EAAU;QAC9B,OAAO,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,EAAE,CAAC,IAAI,IAAI,CAAC;IAC5C,CAAC;IAED,KAAK,CAAC,kBAAkB,CAAC,YAA0B;QACjD,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,YAAY,CAAC,EAAE,EAAE,EAAE,GAAG,YAAY,EAAE,CAAC,CAAC;IAC/D,CAAC;IAED,KAAK,CAAC,kBAAkB,CAAC,EAAU;QACjC,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC;IAChC,CAAC;IAED,KAAK,CAAC,iBAAiB,CAAC,MAAc;QACpC,OAAO,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,aAAa,CAAC,MAAM,EAAE,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,MAAM,KAAK,MAAM,CAAC,CAAC;IAClF,CAAC;IAED,QAAQ;IACR,KAAK,CAAC,eAAe,CAAC,MAAmB;QACvC,MAAM,OAAO,GAAG,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,MAAM,CAAC,cAAc,CAAC,IAAI,EAAE,CAAC;QACnE,OAAO,CAAC,IAAI,CAAC,EAAE,GAAG,MAAM,EAAE,CAAC,CAAC;QAC5B,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,MAAM,CAAC,cAAc,EAAE,OAAO,CAAC,CAAC;IACxD,CAAC;IAED,KAAK,CAAC,eAAe,CAAC,cAAsB,EAAE,MAAc;QAC1D,MAAM,OAAO,GAAG,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,cAAc,CAAC,IAAI,EAAE,CAAC;QAC5D,OAAO,OAAO,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,aAAa,KAAK,MAAM,CAAC,CAAC;IACzD,CAAC;IAED,UAAU;IACV,KAAK,CAAC,UAAU,CAAC,MAAc;QAC7B,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,MAAM,CAAC,IAAI,EAAE,EAAE,GAAG,MAAM,EAAE,CAAC,CAAC;IAC/C,CAAC;IAED,KAAK,CAAC,SAAS,CAAC,IAAY;QAC1B,OAAO,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,IAAI,IAAI,CAAC;IACxC,CAAC;IAED,KAAK,CAAC,YAAY,CAAC,MAAc;QAC/B,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,MAAM,CAAC,IAAI,EAAE,EAAE,GAAG,MAAM,EAAE,CAAC,CAAC;IAC/C,CAAC;IAED,KAAK,CAAC,WAAW;QACf,OAAO,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,MAAM,EAAE,CAAC,CAAC;IAC3C,CAAC;IAED,WAAW;IACX,KAAK,CAAC,WAAW,CAAC,OAAgB;QAChC,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,OAAO,CAAC,EAAE,EAAE,EAAE,GAAG,OAAO,EAAE,CAAC,CAAC;IAChD,CAAC;IAED,KAAK,CAAC,UAAU,CAAC,EAAU;QACzB,OAAO,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE,CAAC,IAAI,IAAI,CAAC;IACvC,CAAC;IAED,KAAK,CAAC,YAAY,CAAC,MAAc;QAC/B,OAAO,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,MAAM,EAAE,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,MAAM,KAAK,MAAM,CAAC,CAAC;IAC7E,CAAC;IAED,SAAS;IACT,KAAK,CAAC,SAAS,CAAC,KAAmB;QACjC,MAAM,MAAM,GAAG,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,KAAK,CAAC,MAAM,CAAC,IAAI,EAAE,CAAC;QACnD,MAAM,CAAC,IAAI,CAAC,EAAE,GAAG,KAAK,EAAE,CAAC,CAAC;QAC1B,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,KAAK,CAAC,MAAM,EAAE,MAAM,CAAC,CAAC;IACxC,CAAC;IAED,KAAK,CAAC,SAAS,CAAC,MAAc,EAAE,IAAuB;QACrD,MAAM,MAAM,GAAG,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,MAAM,CAAC,IAAI,EAAE,CAAC;QAC7C,IAAI,IAAI,EAAE,CAAC;YACT,OAAO,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,KAAK,IAAI,CAAC,CAAC;QAC7C,CAAC;QACD,OAAO,MAAM,CAAC;IAChB,CAAC;IAED,UAAU;IACV,KAAK;QACH,IAAI,CAAC,aAAa,CAAC,KAAK,EAAE,CAAC;QAC3B,IAAI,CAAC,YAAY,CAAC,KAAK,EAAE,CAAC;QAC1B,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,CAAC;QACrB,IAAI,CAAC,QAAQ,CAAC,KAAK,EAAE,CAAC;QACtB,IAAI,CAAC,MAAM,CAAC,KAAK,EAAE,CAAC;IACtB,CAAC;CACF;AAED;;GAEG;AACH,MAAM,OAAO,qBAAqB;IACxB,EAAE,CAAM,CAAC,mBAAmB;IAC5B,WAAW,GAAG;QACpB,aAAa,EAAE,uBAAuB;QACtC,KAAK,EAAE,eAAe;QACtB,OAAO,EAAE,iBAAiB;QAC1B,QAAQ,EAAE,kBAAkB;QAC5B,MAAM,EAAE,gBAAgB;KACzB,CAAC;IAEF,YAAY,OAAY;QACtB,IAAI,CAAC,EAAE,GAAG,OAAO,CAAC;IACpB,CAAC;IAED,KAAK,CAAC,UAAU;QACd,yCAAyC;QACzC,KAAK,MAAM,UAAU,IAAI,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,EAAE,CAAC;YACzD,IAAI,CAAC;gBACH,MAAM,IAAI,CAAC,EAAE,CAAC,gBAAgB,CAAC,UAAU,CAAC,CAAC;YAC7C,CAAC;YAAC,OAAO,KAAK,EAAE,CAAC;gBACf,iCAAiC;YACnC,CAAC;QACH,CAAC;IACH,CAAC;IAED,gBAAgB;IAChB,KAAK,CAAC,gBAAgB,CAAC,YAA0B;QAC/C,MAAM,IAAI,CAAC,EAAE,CAAC,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,aAAa,EAAE;YACnD,EAAE,EAAE,YAAY,CAAC,EAAE;YACnB,IAAI,EAAE,YAAY;YAClB,QAAQ,EAAE;gBACR,MAAM,EAAE,YAAY,CAAC,MAAM;gBAC3B,IAAI,EAAE,YAAY,CAAC,IAAI;gBACvB,MAAM,EAAE,YAAY,CAAC,MAAM;aAC5B;SACF,CAAC,CAAC;IACL,CAAC;IAED,KAAK,CAAC,eAAe,CAAC,EAAU;QAC9B,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,EAAE,CAAC,GAAG,CAAC,IAAI,CAAC,WAAW,CAAC,aAAa,EAAE,EAAE,CAAC,CAAC;QACrE,OAAO,MAAM,EAAE,IAAI,IAAI,IAAI,CAAC;IAC9B,CAAC;IAED,KAAK,CAAC,kBAAkB,CAAC,YAA0B;QACjD,MAAM,IAAI,CAAC,gBAAgB,CAAC,YAAY,CAAC,CAAC;IAC5C,CAAC;IAED,KAAK,CAAC,kBAAkB,CAAC,EAAU;QACjC,MAAM,IAAI,CAAC,EAAE,CAAC,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,aAAa,EAAE,EAAE,CAAC,CAAC;IAC3D,CAAC;IAED,KAAK,CAAC,iBAAiB,CAAC,MAAc;QACpC,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,EAAE,CAAC,KAAK,CAAC,IAAI,CAAC,WAAW,CAAC,aAAa,EAAE;YAClE,MAAM,EAAE,EAAE,MAAM,EAAE;SACnB,CAAC,CAAC;QACH,OAAO,OAAO,CAAC,GAAG,CAAC,CAAC,CAAM,EAAE,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC;IACzC,CAAC;IAED,QAAQ;IACR,KAAK,CAAC,eAAe,CAAC,MAAmB;QACvC,MAAM,IAAI,CAAC,EAAE,CAAC,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,KAAK,EAAE;YAC3C,EAAE,EAAE,MAAM,CAAC,EAAE;YACb,IAAI,EAAE,MAAM;YACZ,QAAQ,EAAE;gBACR,cAAc,EAAE,MAAM,CAAC,cAAc;gBACrC,MAAM,EAAE,MAAM,CAAC,MAAM;gBACrB,MAAM,EAAE,MAAM,CAAC,aAAa;aAC7B;SACF,CAAC,CAAC;IACL,CAAC;IAED,KAAK,CAAC,eAAe,CAAC,cAAsB,EAAE,MAAc;QAC1D,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,EAAE,CAAC,KAAK,CAAC,IAAI,CAAC,WAAW,CAAC,KAAK,EAAE;YAC1D,MAAM,EAAE;gBACN,cAAc;gBACd,iBAAiB,EAAE,MAAM;aAC1B;SACF,CAAC,CAAC;QACH,OAAO,OAAO,CAAC,GAAG,CAAC,CAAC,CAAM,EAAE,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC;IACzC,CAAC;IAED,UAAU;IACV,KAAK,CAAC,UAAU,CAAC,MAAc;QAC7B,MAAM,IAAI,CAAC,EAAE,CAAC,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,OAAO,EAAE;YAC7C,EAAE,EAAE,MAAM,CAAC,IAAI;YACf,IAAI,EAAE,MAAM;YACZ,QAAQ,EAAE;gBACR,IAAI,EAAE,MAAM,CAAC,IAAI;gBACjB,MAAM,EAAE,MAAM,CAAC,MAAM;aACtB;SACF,CAAC,CAAC;IACL,CAAC;IAED,KAAK,CAAC,SAAS,CAAC,IAAY;QAC1B,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,EAAE,CAAC,GAAG,CAAC,IAAI,CAAC,WAAW,CAAC,OAAO,EAAE,IAAI,CAAC,CAAC;QACjE,OAAO,MAAM,EAAE,IAAI,IAAI,IAAI,CAAC;IAC9B,CAAC;IAED,KAAK,CAAC,YAAY,CAAC,MAAc;QAC/B,MAAM,IAAI,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC;IAChC,CAAC;IAED,KAAK,CAAC,WAAW;QACf,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,EAAE,CAAC,KAAK,CAAC,IAAI,CAAC,WAAW,CAAC,OAAO,EAAE,EAAE,CAAC,CAAC;QAClE,OAAO,OAAO,CAAC,GAAG,CAAC,CAAC,CAAM,EAAE,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC;IACzC,CAAC;IAED,WAAW;IACX,KAAK,CAAC,WAAW,CAAC,OAAgB;QAChC,MAAM,IAAI,CAAC,EAAE,CAAC,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,QAAQ,EAAE;YAC9C,EAAE,EAAE,OAAO,CAAC,EAAE;YACd,IAAI,EAAE,OAAO;YACb,QAAQ,EAAE;gBACR,MAAM,EAAE,OAAO,CAAC,MAAM;gBACtB,MAAM,EAAE,OAAO,CAAC,MAAM;gBACtB,MAAM,EAAE,OAAO,CAAC,MAAM;aACvB;SACF,CAAC,CAAC;IACL,CAAC;IAED,KAAK,CAAC,UAAU,CAAC,EAAU;QACzB,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,EAAE,CAAC,GAAG,CAAC,IAAI,CAAC,WAAW,CAAC,QAAQ,EAAE,EAAE,CAAC,CAAC;QAChE,OAAO,MAAM,EAAE,IAAI,IAAI,IAAI,CAAC;IAC9B,CAAC;IAED,KAAK,CAAC,YAAY,CAAC,MAAc;QAC/B,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,EAAE,CAAC,KAAK,CAAC,IAAI,CAAC,WAAW,CAAC,QAAQ,EAAE;YAC7D,MAAM,EAAE,EAAE,MAAM,EAAE;SACnB,CAAC,CAAC;QACH,OAAO,OAAO,CAAC,GAAG,CAAC,CAAC,CAAM,EAAE,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC;IACzC,CAAC;IAED,SAAS;IACT,KAAK,CAAC,SAAS,CAAC,KAAmB;QACjC,MAAM,IAAI,CAAC,EAAE,CAAC,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,MAAM,EAAE;YAC5C,EAAE,EAAE,KAAK,CAAC,EAAE;YACZ,IAAI,EAAE,KAAK;YACX,QAAQ,EAAE;gBACR,MAAM,EAAE,KAAK,CAAC,MAAM;gBACpB,IAAI,EAAE,KAAK,CAAC,IAAI;gBAChB,SAAS,EAAE,KAAK,CAAC,SAAS;aAC3B;SACF,CAAC,CAAC;IACL,CAAC;IAED,KAAK,CAAC,SAAS,CAAC,MAAc,EAAE,IAAuB;QACrD,MAAM,MAAM,GAAQ,EAAE,MAAM,EAAE,CAAC;QAC/B,IAAI,IAAI,EAAE,CAAC;YACT,MAAM,CAAC,eAAe,CAAC,GAAG,IAAI,CAAC;QACjC,CAAC;QAED,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,EAAE,CAAC,KAAK,CAAC,IAAI,CAAC,WAAW,CAAC,MAAM,EAAE,EAAE,MAAM,EAAE,CAAC,CAAC;QACzE,OAAO,OAAO,CAAC,GAAG,CAAC,CAAC,CAAM,EAAE,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC;IACzC,CAAC;CACF;AAED;;GAEG;AACH,MAAM,OAAO,oBAAoB;IACvB,EAAE,CAAM,CAAC,0BAA0B;IAE3C,YAAY,MAAc;QACxB,2CAA2C;QAC3C,+BAA+B;IACjC,CAAC;IAED,KAAK,CAAC,UAAU;QACd,gBAAgB;QAChB,MAAM,MAAM,GAAG;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;KAmCd,CAAC;QAEF,+BAA+B;IACjC,CAAC;IAED,6CAA6C;IAC7C,yDAAyD;IAEzD,KAAK,CAAC,gBAAgB,CAAC,YAA0B;QAC/C,gDAAgD;IAClD,CAAC;IAED,KAAK,CAAC,eAAe,CAAC,EAAU;QAC9B,gDAAgD;QAChD,OAAO,IAAI,CAAC;IACd,CAAC;IAED,KAAK,CAAC,kBAAkB,CAAC,YAA0B;QACjD,MAAM,IAAI,CAAC,gBAAgB,CAAC,YAAY,CAAC,CAAC;IAC5C,CAAC;IAED,KAAK,CAAC,kBAAkB,CAAC,EAAU;QACjC,8CAA8C;IAChD,CAAC;IAED,KAAK,CAAC,iBAAiB,CAAC,MAAc;QACpC,qDAAqD;QACrD,OAAO,EAAE,CAAC;IACZ,CAAC;IAED,KAAK,CAAC,eAAe,CAAC,MAAmB;QACvC,qCAAqC;IACvC,CAAC;IAED,KAAK,CAAC,eAAe,CAAC,cAAsB,EAAE,MAAc;QAC1D,6DAA6D;QAC7D,OAAO,EAAE,CAAC;IACZ,CAAC;IAED,KAAK,CAAC,UAAU,CAAC,MAAc;QAC7B,0CAA0C;IAC5C,CAAC;IAED,KAAK,CAAC,SAAS,CAAC,IAAY;QAC1B,4CAA4C;QAC5C,OAAO,IAAI,CAAC;IACd,CAAC;IAED,KAAK,CAAC,YAAY,CAAC,MAAc;QAC/B,MAAM,IAAI,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC;IAChC,CAAC;IAED,KAAK,CAAC,WAAW;QACf,6BAA6B;QAC7B,OAAO,EAAE,CAAC;IACZ,CAAC;IAED,KAAK,CAAC,WAAW,CAAC,OAAgB;QAChC,gCAAgC;IAClC,CAAC;IAED,KAAK,CAAC,UAAU,CAAC,EAAU;QACzB,2CAA2C;QAC3C,OAAO,IAAI,CAAC;IACd,CAAC;IAED,KAAK,CAAC,YAAY,CAAC,MAAc;QAC/B,gDAAgD;QAChD,OAAO,EAAE,CAAC;IACZ,CAAC;IAED,KAAK,CAAC,SAAS,CAAC,KAAmB;QACjC,8BAA8B;IAChC,CAAC;IAED,KAAK,CAAC,SAAS,CAAC,MAAc,EAAE,IAAuB;QACrD,8CAA8C;QAC9C,OAAO,EAAE,CAAC;IACZ,CAAC;CACF;AAED;;GAEG;AACH,MAAM,OAAO,qBAAqB;IAChC,MAAM,CAAC,YAAY;QACjB,OAAO,IAAI,oBAAoB,EAAE,CAAC;IACpC,CAAC;IAED,MAAM,CAAC,aAAa,CAAC,OAAY;QAC/B,MAAM,OAAO,GAAG,IAAI,qBAAqB,CAAC,OAAO,CAAC,CAAC;QACnD,OAAO,CAAC,UAAU,EAAE,CAAC;QACrB,OAAO,OAAO,CAAC;IACjB,CAAC;IAED,MAAM,CAAC,YAAY,CAAC,MAAc;QAChC,MAAM,OAAO,GAAG,IAAI,oBAAoB,CAAC,MAAM,CAAC,CAAC;QACjD,OAAO,CAAC,UAAU,EAAE,CAAC;QACrB,OAAO,OAAO,CAAC;IACjB,CAAC;CACF","sourcesContent":["/**\n * Storage Adapters\n * Multiple backend options: Memory, AgentDB, SQLite, PostgreSQL\n */\n\nimport {\n  StorageAdapter,\n  Subscription,\n  UsageRecord,\n  Coupon,\n  Invoice,\n  BillingEvent,\n  BillingEventType\n} from '../types.js';\n\n/**\n * In-Memory Storage Adapter (for testing and development)\n */\nexport class MemoryStorageAdapter implements StorageAdapter {\n  private subscriptions = new Map<string, Subscription>();\n  private usageRecords = new Map<string, UsageRecord[]>();\n  private coupons = new Map<string, Coupon>();\n  private invoices = new Map<string, Invoice>();\n  private events = new Map<string, BillingEvent[]>();\n\n  // Subscriptions\n  async saveSubscription(subscription: Subscription): Promise<void> {\n    this.subscriptions.set(subscription.id, { ...subscription });\n  }\n\n  async getSubscription(id: string): Promise<Subscription | null> {\n    return this.subscriptions.get(id) || null;\n  }\n\n  async updateSubscription(subscription: Subscription): Promise<void> {\n    this.subscriptions.set(subscription.id, { ...subscription });\n  }\n\n  async deleteSubscription(id: string): Promise<void> {\n    this.subscriptions.delete(id);\n  }\n\n  async listSubscriptions(userId: string): Promise<Subscription[]> {\n    return Array.from(this.subscriptions.values()).filter(s => s.userId === userId);\n  }\n\n  // Usage\n  async saveUsageRecord(record: UsageRecord): Promise<void> {\n    const records = this.usageRecords.get(record.subscriptionId) || [];\n    records.push({ ...record });\n    this.usageRecords.set(record.subscriptionId, records);\n  }\n\n  async getUsageRecords(subscriptionId: string, period: string): Promise<UsageRecord[]> {\n    const records = this.usageRecords.get(subscriptionId) || [];\n    return records.filter(r => r.billingPeriod === period);\n  }\n\n  // Coupons\n  async saveCoupon(coupon: Coupon): Promise<void> {\n    this.coupons.set(coupon.code, { ...coupon });\n  }\n\n  async getCoupon(code: string): Promise<Coupon | null> {\n    return this.coupons.get(code) || null;\n  }\n\n  async updateCoupon(coupon: Coupon): Promise<void> {\n    this.coupons.set(coupon.code, { ...coupon });\n  }\n\n  async listCoupons(): Promise<Coupon[]> {\n    return Array.from(this.coupons.values());\n  }\n\n  // Invoices\n  async saveInvoice(invoice: Invoice): Promise<void> {\n    this.invoices.set(invoice.id, { ...invoice });\n  }\n\n  async getInvoice(id: string): Promise<Invoice | null> {\n    return this.invoices.get(id) || null;\n  }\n\n  async listInvoices(userId: string): Promise<Invoice[]> {\n    return Array.from(this.invoices.values()).filter(i => i.userId === userId);\n  }\n\n  // Events\n  async saveEvent(event: BillingEvent): Promise<void> {\n    const events = this.events.get(event.userId) || [];\n    events.push({ ...event });\n    this.events.set(event.userId, events);\n  }\n\n  async getEvents(userId: string, type?: BillingEventType): Promise<BillingEvent[]> {\n    const events = this.events.get(userId) || [];\n    if (type) {\n      return events.filter(e => e.type === type);\n    }\n    return events;\n  }\n\n  // Utility\n  clear(): void {\n    this.subscriptions.clear();\n    this.usageRecords.clear();\n    this.coupons.clear();\n    this.invoices.clear();\n    this.events.clear();\n  }\n}\n\n/**\n * AgentDB Storage Adapter (vector database with semantic search)\n */\nexport class AgentDBStorageAdapter implements StorageAdapter {\n  private db: any; // AgentDB instance\n  private collections = {\n    subscriptions: 'billing_subscriptions',\n    usage: 'billing_usage',\n    coupons: 'billing_coupons',\n    invoices: 'billing_invoices',\n    events: 'billing_events'\n  };\n\n  constructor(agentDB: any) {\n    this.db = agentDB;\n  }\n\n  async initialize(): Promise<void> {\n    // Create collections if they don't exist\n    for (const collection of Object.values(this.collections)) {\n      try {\n        await this.db.createCollection(collection);\n      } catch (error) {\n        // Collection might already exist\n      }\n    }\n  }\n\n  // Subscriptions\n  async saveSubscription(subscription: Subscription): Promise<void> {\n    await this.db.upsert(this.collections.subscriptions, {\n      id: subscription.id,\n      data: subscription,\n      metadata: {\n        userId: subscription.userId,\n        tier: subscription.tier,\n        status: subscription.status\n      }\n    });\n  }\n\n  async getSubscription(id: string): Promise<Subscription | null> {\n    const result = await this.db.get(this.collections.subscriptions, id);\n    return result?.data || null;\n  }\n\n  async updateSubscription(subscription: Subscription): Promise<void> {\n    await this.saveSubscription(subscription);\n  }\n\n  async deleteSubscription(id: string): Promise<void> {\n    await this.db.delete(this.collections.subscriptions, id);\n  }\n\n  async listSubscriptions(userId: string): Promise<Subscription[]> {\n    const results = await this.db.query(this.collections.subscriptions, {\n      filter: { userId }\n    });\n    return results.map((r: any) => r.data);\n  }\n\n  // Usage\n  async saveUsageRecord(record: UsageRecord): Promise<void> {\n    await this.db.insert(this.collections.usage, {\n      id: record.id,\n      data: record,\n      metadata: {\n        subscriptionId: record.subscriptionId,\n        metric: record.metric,\n        period: record.billingPeriod\n      }\n    });\n  }\n\n  async getUsageRecords(subscriptionId: string, period: string): Promise<UsageRecord[]> {\n    const results = await this.db.query(this.collections.usage, {\n      filter: {\n        subscriptionId,\n        'metadata.period': period\n      }\n    });\n    return results.map((r: any) => r.data);\n  }\n\n  // Coupons\n  async saveCoupon(coupon: Coupon): Promise<void> {\n    await this.db.upsert(this.collections.coupons, {\n      id: coupon.code,\n      data: coupon,\n      metadata: {\n        type: coupon.type,\n        active: coupon.active\n      }\n    });\n  }\n\n  async getCoupon(code: string): Promise<Coupon | null> {\n    const result = await this.db.get(this.collections.coupons, code);\n    return result?.data || null;\n  }\n\n  async updateCoupon(coupon: Coupon): Promise<void> {\n    await this.saveCoupon(coupon);\n  }\n\n  async listCoupons(): Promise<Coupon[]> {\n    const results = await this.db.query(this.collections.coupons, {});\n    return results.map((r: any) => r.data);\n  }\n\n  // Invoices\n  async saveInvoice(invoice: Invoice): Promise<void> {\n    await this.db.insert(this.collections.invoices, {\n      id: invoice.id,\n      data: invoice,\n      metadata: {\n        userId: invoice.userId,\n        status: invoice.status,\n        amount: invoice.amount\n      }\n    });\n  }\n\n  async getInvoice(id: string): Promise<Invoice | null> {\n    const result = await this.db.get(this.collections.invoices, id);\n    return result?.data || null;\n  }\n\n  async listInvoices(userId: string): Promise<Invoice[]> {\n    const results = await this.db.query(this.collections.invoices, {\n      filter: { userId }\n    });\n    return results.map((r: any) => r.data);\n  }\n\n  // Events\n  async saveEvent(event: BillingEvent): Promise<void> {\n    await this.db.insert(this.collections.events, {\n      id: event.id,\n      data: event,\n      metadata: {\n        userId: event.userId,\n        type: event.type,\n        timestamp: event.timestamp\n      }\n    });\n  }\n\n  async getEvents(userId: string, type?: BillingEventType): Promise<BillingEvent[]> {\n    const filter: any = { userId };\n    if (type) {\n      filter['metadata.type'] = type;\n    }\n\n    const results = await this.db.query(this.collections.events, { filter });\n    return results.map((r: any) => r.data);\n  }\n}\n\n/**\n * SQLite Storage Adapter\n */\nexport class SQLiteStorageAdapter implements StorageAdapter {\n  private db: any; // better-sqlite3 instance\n\n  constructor(dbPath: string) {\n    // In production, initialize better-sqlite3\n    // For now, stub implementation\n  }\n\n  async initialize(): Promise<void> {\n    // Create tables\n    const schema = `\n      CREATE TABLE IF NOT EXISTS subscriptions (\n        id TEXT PRIMARY KEY,\n        user_id TEXT NOT NULL,\n        data TEXT NOT NULL,\n        created_at DATETIME DEFAULT CURRENT_TIMESTAMP\n      );\n\n      CREATE TABLE IF NOT EXISTS usage_records (\n        id TEXT PRIMARY KEY,\n        subscription_id TEXT NOT NULL,\n        data TEXT NOT NULL,\n        created_at DATETIME DEFAULT CURRENT_TIMESTAMP\n      );\n\n      CREATE TABLE IF NOT EXISTS coupons (\n        code TEXT PRIMARY KEY,\n        data TEXT NOT NULL,\n        created_at DATETIME DEFAULT CURRENT_TIMESTAMP\n      );\n\n      CREATE TABLE IF NOT EXISTS invoices (\n        id TEXT PRIMARY KEY,\n        user_id TEXT NOT NULL,\n        data TEXT NOT NULL,\n        created_at DATETIME DEFAULT CURRENT_TIMESTAMP\n      );\n\n      CREATE TABLE IF NOT EXISTS events (\n        id TEXT PRIMARY KEY,\n        user_id TEXT NOT NULL,\n        type TEXT NOT NULL,\n        data TEXT NOT NULL,\n        created_at DATETIME DEFAULT CURRENT_TIMESTAMP\n      );\n    `;\n\n    // Execute schema in production\n  }\n\n  // Implement StorageAdapter interface methods\n  // (Similar to MemoryStorageAdapter but with SQL queries)\n\n  async saveSubscription(subscription: Subscription): Promise<void> {\n    // SQL: INSERT OR REPLACE INTO subscriptions ...\n  }\n\n  async getSubscription(id: string): Promise<Subscription | null> {\n    // SQL: SELECT * FROM subscriptions WHERE id = ?\n    return null;\n  }\n\n  async updateSubscription(subscription: Subscription): Promise<void> {\n    await this.saveSubscription(subscription);\n  }\n\n  async deleteSubscription(id: string): Promise<void> {\n    // SQL: DELETE FROM subscriptions WHERE id = ?\n  }\n\n  async listSubscriptions(userId: string): Promise<Subscription[]> {\n    // SQL: SELECT * FROM subscriptions WHERE user_id = ?\n    return [];\n  }\n\n  async saveUsageRecord(record: UsageRecord): Promise<void> {\n    // SQL: INSERT INTO usage_records ...\n  }\n\n  async getUsageRecords(subscriptionId: string, period: string): Promise<UsageRecord[]> {\n    // SQL: SELECT * FROM usage_records WHERE subscription_id = ?\n    return [];\n  }\n\n  async saveCoupon(coupon: Coupon): Promise<void> {\n    // SQL: INSERT OR REPLACE INTO coupons ...\n  }\n\n  async getCoupon(code: string): Promise<Coupon | null> {\n    // SQL: SELECT * FROM coupons WHERE code = ?\n    return null;\n  }\n\n  async updateCoupon(coupon: Coupon): Promise<void> {\n    await this.saveCoupon(coupon);\n  }\n\n  async listCoupons(): Promise<Coupon[]> {\n    // SQL: SELECT * FROM coupons\n    return [];\n  }\n\n  async saveInvoice(invoice: Invoice): Promise<void> {\n    // SQL: INSERT INTO invoices ...\n  }\n\n  async getInvoice(id: string): Promise<Invoice | null> {\n    // SQL: SELECT * FROM invoices WHERE id = ?\n    return null;\n  }\n\n  async listInvoices(userId: string): Promise<Invoice[]> {\n    // SQL: SELECT * FROM invoices WHERE user_id = ?\n    return [];\n  }\n\n  async saveEvent(event: BillingEvent): Promise<void> {\n    // SQL: INSERT INTO events ...\n  }\n\n  async getEvents(userId: string, type?: BillingEventType): Promise<BillingEvent[]> {\n    // SQL: SELECT * FROM events WHERE user_id = ?\n    return [];\n  }\n}\n\n/**\n * Storage Adapter Factory\n */\nexport class StorageAdapterFactory {\n  static createMemory(): MemoryStorageAdapter {\n    return new MemoryStorageAdapter();\n  }\n\n  static createAgentDB(agentDB: any): AgentDBStorageAdapter {\n    const adapter = new AgentDBStorageAdapter(agentDB);\n    adapter.initialize();\n    return adapter;\n  }\n\n  static createSQLite(dbPath: string): SQLiteStorageAdapter {\n    const adapter = new SQLiteStorageAdapter(dbPath);\n    adapter.initialize();\n    return adapter;\n  }\n}\n"]}
{"version":3,"file":"index.js","sourceRoot":"","sources":["../../src/billing/index.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Agentic-Jujutsu Billing System\n * Complete economic system for subscriptions, metering, and payments\n *\n * TypeScript implementation for npm package\n */\n\nimport { EventEmitter } from 'events';\nimport { PricingManager } from './pricing/tiers.js';\nimport { MeteringEngine } from './metering/engine.js';\nimport { SubscriptionManager } from './subscriptions/manager.js';\nimport { CouponManager } from './coupons/manager.js';\nimport { PaymentProcessor, PaymentProviderFactory } from './payments/processor.js';\nimport { StorageAdapterFactory, MemoryStorageAdapter } from './storage/adapters.js';\n\nimport type {\n  BillingConfig,\n  StorageAdapter,\n  SubscriptionTier,\n  BillingCycle,\n  UsageMetric\n} from './types.js';\nimport { PaymentProvider } from './types.js';\n\n// Re-export all types\nexport * from './types.js';\nexport { PricingManager, DEFAULT_TIERS } from './pricing/tiers.js';\nexport { MeteringEngine } from './metering/engine.js';\nexport { SubscriptionManager } from './subscriptions/manager.js';\nexport { CouponManager } from './coupons/manager.js';\nexport { PaymentProcessor, PaymentProviderFactory } from './payments/processor.js';\nexport { StorageAdapterFactory } from './storage/adapters.js';\n\n/**\n * Main Billing System Class\n * Orchestrates all billing components\n */\nexport class BillingSystem extends EventEmitter {\n  public pricing: PricingManager;\n  public metering: MeteringEngine;\n  public subscriptions: SubscriptionManager;\n  public coupons: CouponManager;\n  public payments: PaymentProcessor;\n  public storage: StorageAdapter;\n\n  private config: BillingConfig;\n\n  constructor(config?: Partial<BillingConfig>) {\n    super();\n\n    // Default configuration\n    this.config = {\n      currency: 'USD',\n      taxRate: 0,\n      gracePeriodDays: 3,\n      enableMetering: true,\n      enableCoupons: true,\n      enableOverages: true,\n      overageRate: 1.5,\n      softLimitPercent: 80,\n      hardLimitPercent: 100,\n      storageBackend: 'memory',\n      paymentProvider: PaymentProvider.Stripe,\n      ...config\n    };\n\n    // Initialize storage\n    this.storage = this.initializeStorage();\n\n    // Initialize components\n    this.pricing = new PricingManager();\n    this.metering = new MeteringEngine(this.storage, {\n      enabled: this.config.enableMetering,\n      softLimitPercent: this.config.softLimitPercent,\n      hardLimitPercent: this.config.hardLimitPercent\n    });\n    this.subscriptions = new SubscriptionManager(this.storage, this.pricing);\n    this.coupons = new CouponManager(this.storage);\n    this.payments = new PaymentProcessor({\n      provider: this.config.paymentProvider\n    }, this.storage);\n\n    // Forward events\n    this.setupEventForwarding();\n  }\n\n  /**\n   * Create a new subscription with payment\n   */\n  async subscribe(params: {\n    userId: string;\n    tier: SubscriptionTier;\n    billingCycle: BillingCycle;\n    paymentMethodId: string;\n    couponCode?: string;\n  }): Promise<{\n    subscription: any;\n    payment: any;\n  }> {\n    const { userId, tier, billingCycle, paymentMethodId, couponCode } = params;\n\n    // Calculate price\n    let price = this.pricing.calculatePrice(tier, billingCycle);\n\n    // Apply coupon if provided\n    let discount = 0;\n    if (couponCode && this.config.enableCoupons) {\n      const validation = await this.coupons.validateCoupon(couponCode, tier, price);\n      if (validation.valid) {\n        discount = validation.discountAmount;\n        price = validation.finalAmount;\n        await this.coupons.applyCoupon(couponCode);\n      }\n    }\n\n    // Create subscription\n    const subscription = await this.subscriptions.createSubscription({\n      userId,\n      tier,\n      billingCycle,\n      paymentMethodId,\n      couponCode\n    });\n\n    // Process payment\n    const payment = await this.payments.processPayment({\n      subscriptionId: subscription.id,\n      userId,\n      amount: price,\n      currency: this.config.currency,\n      paymentMethodId,\n      description: `${tier} subscription - ${billingCycle}`,\n      metadata: {\n        tier,\n        billingCycle,\n        discount\n      }\n    });\n\n    return { subscription, payment };\n  }\n\n  /**\n   * Record usage for a subscription\n   */\n  async recordUsage(params: {\n    subscriptionId: string;\n    userId: string;\n    metric: UsageMetric;\n    amount: number;\n    unit: string;\n  }): Promise<void> {\n    await this.metering.recordUsage(params);\n  }\n\n  /**\n   * Check quota before operation\n   */\n  async checkQuota(subscriptionId: string, metric: UsageMetric): Promise<boolean> {\n    const subscription = await this.subscriptions.getSubscription(subscriptionId);\n    if (!subscription) return false;\n\n    const result = await this.metering.checkQuota(\n      subscriptionId,\n      metric,\n      subscription.limits\n    );\n\n    return result.allowed;\n  }\n\n  /**\n   * Get usage summary\n   */\n  async getUsageSummary(subscriptionId: string): Promise<any> {\n    const subscription = await this.subscriptions.getSubscription(subscriptionId);\n    if (!subscription) {\n      throw new Error('Subscription not found');\n    }\n\n    return this.metering.getUsageSummary(subscriptionId, subscription.limits);\n  }\n\n  /**\n   * Upgrade subscription\n   */\n  async upgrade(subscriptionId: string, newTier: SubscriptionTier): Promise<any> {\n    const subscription = await this.subscriptions.upgradeSubscription(subscriptionId, newTier);\n\n    // Calculate and charge prorated amount\n    const pricingTier = this.pricing.getTier(newTier);\n    // Payment logic here\n\n    return subscription;\n  }\n\n  /**\n   * Cancel subscription\n   */\n  async cancel(subscriptionId: string, immediate: boolean = false): Promise<any> {\n    return this.subscriptions.cancelSubscription(subscriptionId, immediate);\n  }\n\n  /**\n   * Shutdown billing system\n   */\n  async shutdown(): Promise<void> {\n    await this.metering.stop();\n  }\n\n  private initializeStorage(): StorageAdapter {\n    switch (this.config.storageBackend) {\n      case 'memory':\n        return StorageAdapterFactory.createMemory();\n\n      case 'agentdb':\n        // In production, initialize with actual AgentDB instance\n        return StorageAdapterFactory.createMemory();\n\n      case 'sqlite':\n        // In production, initialize with SQLite path\n        return StorageAdapterFactory.createMemory();\n\n      default:\n        return StorageAdapterFactory.createMemory();\n    }\n  }\n\n  private setupEventForwarding(): void {\n    // Forward metering events\n    this.metering.on('usage.recorded', (data) => this.emit('usage.recorded', data));\n    this.metering.on('quota.warning', (data) => this.emit('quota.warning', data));\n    this.metering.on('quota.exceeded', (data) => this.emit('quota.exceeded', data));\n\n    // Forward subscription events\n    this.subscriptions.on('subscription.created', (data) => this.emit('subscription.created', data));\n    this.subscriptions.on('subscription.upgraded', (data) => this.emit('subscription.upgraded', data));\n    this.subscriptions.on('subscription.downgraded', (data) => this.emit('subscription.downgraded', data));\n    this.subscriptions.on('subscription.canceled', (data) => this.emit('subscription.canceled', data));\n    this.subscriptions.on('subscription.renewed', (data) => this.emit('subscription.renewed', data));\n  }\n}\n\n/**\n * Create a billing system instance\n */\nexport function createBillingSystem(config?: Partial<BillingConfig>): BillingSystem {\n  return new BillingSystem(config);\n}\n\n/**\n * Default export\n */\nexport default {\n  BillingSystem,\n  createBillingSystem,\n  PricingManager,\n  MeteringEngine,\n  SubscriptionManager,\n  CouponManager,\n  PaymentProcessor,\n  PaymentProviderFactory,\n  StorageAdapterFactory\n};\n"]}
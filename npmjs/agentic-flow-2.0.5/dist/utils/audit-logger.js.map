{"version":3,"file":"audit-logger.js","sourceRoot":"","sources":["../../src/utils/audit-logger.ts"],"names":[],"mappings":"AAAA;;;;;;;;GAQG;AA6BH;;;;;;;;;GASG;AACH,MAAM,OAAO,WAAW;IACd,MAAM,CAA8B;IACpC,SAAS,CAAe;IACxB,MAAM,CAAC,QAAQ,CAAc;IAErC,YAAY,MAA0B;QACpC,IAAI,CAAC,MAAM,GAAG;YACZ,aAAa,EAAE,MAAM,EAAE,aAAa,IAAI,IAAI;YAC5C,UAAU,EAAE,MAAM,EAAE,UAAU,IAAI,KAAK;YACvC,WAAW,EAAE,MAAM,EAAE,WAAW,IAAI,kBAAkB;YACtD,WAAW,EAAE,MAAM,EAAE,WAAW,IAAI,MAAM;YAC1C,gBAAgB,EAAE,MAAM,EAAE,gBAAgB,IAAI,IAAI;SACnD,CAAC;QAEF,IAAI,CAAC,SAAS,GAAG,EAAE,CAAC;IACtB,CAAC;IAED;;OAEG;IACH,MAAM,CAAC,WAAW,CAAC,MAA0B;QAC3C,IAAI,CAAC,WAAW,CAAC,QAAQ,EAAE,CAAC;YAC1B,WAAW,CAAC,QAAQ,GAAG,IAAI,WAAW,CAAC,MAAM,CAAC,CAAC;QACjD,CAAC;QACD,OAAO,WAAW,CAAC,QAAQ,CAAC;IAC9B,CAAC;IAED;;;;OAIG;IACH,GAAG,CAAC,KAAiB;QACnB,wBAAwB;QACxB,MAAM,UAAU,GAAG,CAAC,MAAM,EAAE,SAAS,EAAE,OAAO,EAAE,UAAU,CAAC,CAAC;QAC5D,MAAM,QAAQ,GAAG,UAAU,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC,CAAC;QAC7D,MAAM,UAAU,GAAG,UAAU,CAAC,OAAO,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAC;QAEtD,IAAI,UAAU,GAAG,QAAQ,EAAE,CAAC;YAC1B,OAAO;QACT,CAAC;QAED,oBAAoB;QACpB,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;QAC3B,IAAI,IAAI,CAAC,SAAS,CAAC,MAAM,GAAG,IAAI,CAAC,MAAM,CAAC,gBAAgB,EAAE,CAAC;YACzD,IAAI,CAAC,SAAS,CAAC,KAAK,EAAE,CAAC;QACzB,CAAC;QAED,kBAAkB;QAClB,IAAI,IAAI,CAAC,MAAM,CAAC,aAAa,EAAE,CAAC;YAC9B,IAAI,CAAC,YAAY,CAAC,KAAK,CAAC,CAAC;QAC3B,CAAC;QAED,oDAAoD;QACpD,IAAI,IAAI,CAAC,MAAM,CAAC,UAAU,EAAE,CAAC;YAC3B,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;QACxB,CAAC;IACH,CAAC;IAED;;OAEG;IACH,UAAU,CAAC,GAAQ,EAAE,GAAQ,EAAE,SAAiB;QAC9C,IAAI,CAAC,GAAG,CAAC;YACP,SAAS,EAAE,IAAI,CAAC,GAAG,EAAE;YACrB,SAAS,EAAE,SAAS;YACpB,QAAQ,EAAE,GAAG,CAAC,UAAU,IAAI,GAAG,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,GAAG,CAAC,UAAU,IAAI,GAAG,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,MAAM;YACtF,MAAM,EAAE,GAAG,CAAC,IAAI,EAAE,EAAE;YACpB,EAAE,EAAE,GAAG,CAAC,EAAE,IAAI,GAAG,CAAC,UAAU,CAAC,aAAa;YAC1C,MAAM,EAAE,GAAG,CAAC,MAAM;YAClB,IAAI,EAAE,GAAG,CAAC,IAAI;YACd,UAAU,EAAE,GAAG,CAAC,UAAU;YAC1B,SAAS;YACT,OAAO,EAAE,GAAG,GAAG,CAAC,MAAM,IAAI,GAAG,CAAC,IAAI,MAAM,GAAG,CAAC,UAAU,KAAK,SAAS,KAAK;YACzE,QAAQ,EAAE;gBACR,SAAS,EAAE,GAAG,CAAC,OAAO,CAAC,YAAY,CAAC;gBACpC,KAAK,EAAE,GAAG,CAAC,KAAK;aACjB;SACF,CAAC,CAAC;IACL,CAAC;IAED;;OAEG;IACH,OAAO,CAAC,OAAgB,EAAE,MAAe,EAAE,EAAW,EAAE,MAAe;QACrE,IAAI,CAAC,GAAG,CAAC;YACP,SAAS,EAAE,IAAI,CAAC,GAAG,EAAE;YACrB,SAAS,EAAE,MAAM;YACjB,QAAQ,EAAE,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,SAAS;YACtC,MAAM;YACN,EAAE;YACF,OAAO,EAAE,OAAO;gBACd,CAAC,CAAC,sCAAsC,MAAM,EAAE;gBAChD,CAAC,CAAC,0BAA0B,MAAM,EAAE;YACtC,QAAQ,EAAE,EAAE,OAAO,EAAE,MAAM,EAAE;SAC9B,CAAC,CAAC;IACL,CAAC;IAED;;OAEG;IACH,oBAAoB,CAClB,IAAgF,EAChF,MAAe,EACf,EAAW,EACX,OAAgB;QAEhB,IAAI,CAAC,GAAG,CAAC;YACP,SAAS,EAAE,IAAI,CAAC,GAAG,EAAE;YACrB,SAAS,EAAE,UAAU;YACrB,QAAQ,EAAE,SAAS;YACnB,MAAM;YACN,EAAE;YACF,OAAO,EAAE,uBAAuB,IAAI,EAAE;YACtC,QAAQ,EAAE,EAAE,IAAI,EAAE,OAAO,EAAE;SAC5B,CAAC,CAAC;IACL,CAAC;IAED;;OAEG;IACH,QAAQ,CAAC,KAAY,EAAE,MAAe,EAAE,EAAW,EAAE,OAA6B;QAChF,IAAI,CAAC,GAAG,CAAC;YACP,SAAS,EAAE,IAAI,CAAC,GAAG,EAAE;YACrB,SAAS,EAAE,OAAO;YAClB,QAAQ,EAAE,OAAO;YACjB,MAAM;YACN,EAAE;YACF,OAAO,EAAE,KAAK,CAAC,OAAO;YACtB,QAAQ,EAAE;gBACR,KAAK,EAAE,KAAK,CAAC,IAAI;gBACjB,KAAK,EAAE,KAAK,CAAC,KAAK;gBAClB,GAAG,OAAO;aACX;SACF,CAAC,CAAC;IACL,CAAC;IAED;;OAEG;IACH,aAAa,CAAC,QAAgB,GAAG;QAC/B,OAAO,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC,KAAK,CAAC,CAAC;IACtC,CAAC;IAED;;OAEG;IACH,aAAa,CAAC,MAAc,EAAE,QAAgB,GAAG;QAC/C,OAAO,IAAI,CAAC,SAAS;aAClB,MAAM,CAAC,KAAK,CAAC,EAAE,CAAC,KAAK,CAAC,MAAM,KAAK,MAAM,CAAC;aACxC,KAAK,CAAC,CAAC,KAAK,CAAC,CAAC;IACnB,CAAC;IAED;;OAEG;IACH,aAAa,CACX,SAAkC,EAClC,QAAgB,GAAG;QAEnB,OAAO,IAAI,CAAC,SAAS;aAClB,MAAM,CAAC,KAAK,CAAC,EAAE,CAAC,KAAK,CAAC,SAAS,KAAK,SAAS,CAAC;aAC9C,KAAK,CAAC,CAAC,KAAK,CAAC,CAAC;IACnB,CAAC;IAED;;OAEG;IACK,YAAY,CAAC,KAAiB;QACpC,MAAM,SAAS,GAAG,IAAI,IAAI,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC,WAAW,EAAE,CAAC;QAC1D,MAAM,MAAM,GAAG,IAAI,SAAS,MAAM,KAAK,CAAC,QAAQ,MAAM,KAAK,CAAC,SAAS,GAAG,CAAC;QAEzE,MAAM,KAAK,GAAG,KAAK,CAAC,QAAQ,KAAK,OAAO,IAAI,KAAK,CAAC,QAAQ,KAAK,UAAU;YACvE,CAAC,CAAC,OAAO,CAAC,KAAK;YACf,CAAC,CAAC,KAAK,CAAC,QAAQ,KAAK,SAAS;gBAC9B,CAAC,CAAC,OAAO,CAAC,IAAI;gBACd,CAAC,CAAC,OAAO,CAAC,GAAG,CAAC;QAEhB,KAAK,CAAC,GAAG,MAAM,IAAI,KAAK,CAAC,OAAO,EAAE,CAAC,CAAC;QAEpC,IAAI,KAAK,CAAC,QAAQ,EAAE,CAAC;YACnB,KAAK,CAAC,aAAa,EAAE,KAAK,CAAC,QAAQ,CAAC,CAAC;QACvC,CAAC;IACH,CAAC;IAED;;OAEG;IACK,SAAS,CAAC,KAAiB;QACjC,sDAAsD;QACtD,wBAAwB;QACxB,MAAM,IAAI,GAAG,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,GAAG,IAAI,CAAC;QAC1C,oDAAoD;IACtD,CAAC;IAED;;OAEG;IACH,KAAK;QACH,IAAI,CAAC,SAAS,GAAG,EAAE,CAAC;IACtB,CAAC;IAED;;OAEG;IACH,QAAQ;QAMN,MAAM,KAAK,GAAG;YACZ,WAAW,EAAE,IAAI,CAAC,SAAS,CAAC,MAAM;YAClC,MAAM,EAAE,EAA4B;YACpC,UAAU,EAAE,EAA4B;YACxC,SAAS,EAAE,CAAC;SACb,CAAC;QAEF,KAAK,MAAM,KAAK,IAAI,IAAI,CAAC,SAAS,EAAE,CAAC;YACnC,KAAK,CAAC,MAAM,CAAC,KAAK,CAAC,SAAS,CAAC,GAAG,CAAC,KAAK,CAAC,MAAM,CAAC,KAAK,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC,GAAG,CAAC,CAAC;YACzE,KAAK,CAAC,UAAU,CAAC,KAAK,CAAC,QAAQ,CAAC,GAAG,CAAC,KAAK,CAAC,UAAU,CAAC,KAAK,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC,GAAG,CAAC,CAAC;QACjF,CAAC;QAED,MAAM,UAAU,GAAG,CAAC,KAAK,CAAC,UAAU,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,GAAG,CAAC,KAAK,CAAC,UAAU,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC,CAAC;QAC1F,KAAK,CAAC,SAAS,GAAG,KAAK,CAAC,WAAW,GAAG,CAAC,CAAC,CAAC,CAAC,UAAU,GAAG,KAAK,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC,CAAC;QAE7E,OAAO,KAAK,CAAC;IACf,CAAC;CACF;AAED;;GAEG;AACH,MAAM,UAAU,qBAAqB,CAAC,MAAoB;IACxD,MAAM,WAAW,GAAG,MAAM,IAAI,WAAW,CAAC,WAAW,EAAE,CAAC;IAExD,OAAO,CAAC,GAAQ,EAAE,GAAQ,EAAE,IAAS,EAAE,EAAE;QACvC,MAAM,SAAS,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QAE7B,8BAA8B;QAC9B,GAAG,CAAC,EAAE,CAAC,QAAQ,EAAE,GAAG,EAAE;YACpB,MAAM,SAAS,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,SAAS,CAAC;YACzC,WAAW,CAAC,UAAU,CAAC,GAAG,EAAE,GAAG,EAAE,SAAS,CAAC,CAAC;QAC9C,CAAC,CAAC,CAAC;QAEH,IAAI,EAAE,CAAC;IACT,CAAC,CAAC;AACJ,CAAC;AAED,mBAAmB;AACnB,MAAM,CAAC,MAAM,WAAW,GAAG,WAAW,CAAC,WAAW,EAAE,CAAC","sourcesContent":["/**\n * Audit Logger\n *\n * Comprehensive audit logging for security and compliance:\n * - All API requests\n * - Authentication events\n * - Security violations\n * - Performance metrics\n */\n\nexport interface AuditEvent {\n  timestamp: number;\n  eventType: 'REQUEST' | 'AUTH' | 'ERROR' | 'SECURITY' | 'PERFORMANCE';\n  severity: 'INFO' | 'WARNING' | 'ERROR' | 'CRITICAL';\n  userId?: string;\n  ip?: string;\n  method?: string;\n  path?: string;\n  statusCode?: number;\n  latencyMs?: number;\n  message: string;\n  metadata?: Record<string, any>;\n}\n\nexport interface AuditLoggerConfig {\n  /** Enable console logging */\n  enableConsole?: boolean;\n  /** Enable file logging */\n  enableFile?: boolean;\n  /** Log file path */\n  logFilePath?: string;\n  /** Minimum severity to log */\n  minSeverity?: 'INFO' | 'WARNING' | 'ERROR' | 'CRITICAL';\n  /** Maximum log entries in memory */\n  maxMemoryEntries?: number;\n}\n\n/**\n * Audit Logger\n *\n * Logs all security-relevant events:\n * - API requests and responses\n * - Authentication attempts\n * - Rate limit violations\n * - Input validation failures\n * - Circuit breaker state changes\n */\nexport class AuditLogger {\n  private config: Required<AuditLoggerConfig>;\n  private memoryLog: AuditEvent[];\n  private static instance: AuditLogger;\n\n  constructor(config?: AuditLoggerConfig) {\n    this.config = {\n      enableConsole: config?.enableConsole ?? true,\n      enableFile: config?.enableFile ?? false,\n      logFilePath: config?.logFilePath ?? './logs/audit.log',\n      minSeverity: config?.minSeverity ?? 'INFO',\n      maxMemoryEntries: config?.maxMemoryEntries ?? 1000,\n    };\n\n    this.memoryLog = [];\n  }\n\n  /**\n   * Get singleton instance\n   */\n  static getInstance(config?: AuditLoggerConfig): AuditLogger {\n    if (!AuditLogger.instance) {\n      AuditLogger.instance = new AuditLogger(config);\n    }\n    return AuditLogger.instance;\n  }\n\n  /**\n   * Log event\n   *\n   * @param event - Audit event to log\n   */\n  log(event: AuditEvent): void {\n    // Check severity filter\n    const severities = ['INFO', 'WARNING', 'ERROR', 'CRITICAL'];\n    const minIndex = severities.indexOf(this.config.minSeverity);\n    const eventIndex = severities.indexOf(event.severity);\n\n    if (eventIndex < minIndex) {\n      return;\n    }\n\n    // Add to memory log\n    this.memoryLog.push(event);\n    if (this.memoryLog.length > this.config.maxMemoryEntries) {\n      this.memoryLog.shift();\n    }\n\n    // Console logging\n    if (this.config.enableConsole) {\n      this.logToConsole(event);\n    }\n\n    // File logging (in production, use Winston or Pino)\n    if (this.config.enableFile) {\n      this.logToFile(event);\n    }\n  }\n\n  /**\n   * Log API request\n   */\n  logRequest(req: any, res: any, latencyMs: number): void {\n    this.log({\n      timestamp: Date.now(),\n      eventType: 'REQUEST',\n      severity: res.statusCode >= 500 ? 'ERROR' : res.statusCode >= 400 ? 'WARNING' : 'INFO',\n      userId: req.user?.id,\n      ip: req.ip || req.connection.remoteAddress,\n      method: req.method,\n      path: req.path,\n      statusCode: res.statusCode,\n      latencyMs,\n      message: `${req.method} ${req.path} - ${res.statusCode} (${latencyMs}ms)`,\n      metadata: {\n        userAgent: req.headers['user-agent'],\n        query: req.query,\n      },\n    });\n  }\n\n  /**\n   * Log authentication event\n   */\n  logAuth(success: boolean, userId?: string, ip?: string, reason?: string): void {\n    this.log({\n      timestamp: Date.now(),\n      eventType: 'AUTH',\n      severity: success ? 'INFO' : 'WARNING',\n      userId,\n      ip,\n      message: success\n        ? `Authentication successful for user ${userId}`\n        : `Authentication failed: ${reason}`,\n      metadata: { success, reason },\n    });\n  }\n\n  /**\n   * Log security violation\n   */\n  logSecurityViolation(\n    type: 'RATE_LIMIT' | 'INPUT_VALIDATION' | 'AUTH_FAILURE' | 'SUSPICIOUS_ACTIVITY',\n    userId?: string,\n    ip?: string,\n    details?: string\n  ): void {\n    this.log({\n      timestamp: Date.now(),\n      eventType: 'SECURITY',\n      severity: 'WARNING',\n      userId,\n      ip,\n      message: `Security violation: ${type}`,\n      metadata: { type, details },\n    });\n  }\n\n  /**\n   * Log error\n   */\n  logError(error: Error, userId?: string, ip?: string, context?: Record<string, any>): void {\n    this.log({\n      timestamp: Date.now(),\n      eventType: 'ERROR',\n      severity: 'ERROR',\n      userId,\n      ip,\n      message: error.message,\n      metadata: {\n        error: error.name,\n        stack: error.stack,\n        ...context,\n      },\n    });\n  }\n\n  /**\n   * Get recent logs\n   */\n  getRecentLogs(limit: number = 100): AuditEvent[] {\n    return this.memoryLog.slice(-limit);\n  }\n\n  /**\n   * Get logs by user\n   */\n  getLogsByUser(userId: string, limit: number = 100): AuditEvent[] {\n    return this.memoryLog\n      .filter(event => event.userId === userId)\n      .slice(-limit);\n  }\n\n  /**\n   * Get logs by type\n   */\n  getLogsByType(\n    eventType: AuditEvent['eventType'],\n    limit: number = 100\n  ): AuditEvent[] {\n    return this.memoryLog\n      .filter(event => event.eventType === eventType)\n      .slice(-limit);\n  }\n\n  /**\n   * Log to console\n   */\n  private logToConsole(event: AuditEvent): void {\n    const timestamp = new Date(event.timestamp).toISOString();\n    const prefix = `[${timestamp}] [${event.severity}] [${event.eventType}]`;\n\n    const logFn = event.severity === 'ERROR' || event.severity === 'CRITICAL'\n      ? console.error\n      : event.severity === 'WARNING'\n      ? console.warn\n      : console.log;\n\n    logFn(`${prefix} ${event.message}`);\n\n    if (event.metadata) {\n      logFn('  Metadata:', event.metadata);\n    }\n  }\n\n  /**\n   * Log to file (placeholder - use Winston/Pino in production)\n   */\n  private logToFile(event: AuditEvent): void {\n    // In production, use Winston or Pino for file logging\n    // This is a placeholder\n    const line = JSON.stringify(event) + '\\n';\n    // fs.appendFileSync(this.config.logFilePath, line);\n  }\n\n  /**\n   * Clear memory logs\n   */\n  clear(): void {\n    this.memoryLog = [];\n  }\n\n  /**\n   * Get statistics\n   */\n  getStats(): {\n    totalEvents: number;\n    byType: Record<string, number>;\n    bySeverity: Record<string, number>;\n    errorRate: number;\n  } {\n    const stats = {\n      totalEvents: this.memoryLog.length,\n      byType: {} as Record<string, number>,\n      bySeverity: {} as Record<string, number>,\n      errorRate: 0,\n    };\n\n    for (const event of this.memoryLog) {\n      stats.byType[event.eventType] = (stats.byType[event.eventType] || 0) + 1;\n      stats.bySeverity[event.severity] = (stats.bySeverity[event.severity] || 0) + 1;\n    }\n\n    const errorCount = (stats.bySeverity['ERROR'] || 0) + (stats.bySeverity['CRITICAL'] || 0);\n    stats.errorRate = stats.totalEvents > 0 ? errorCount / stats.totalEvents : 0;\n\n    return stats;\n  }\n}\n\n/**\n * Create audit logging middleware\n */\nexport function createAuditMiddleware(logger?: AuditLogger) {\n  const auditLogger = logger || AuditLogger.getInstance();\n\n  return (req: any, res: any, next: any) => {\n    const startTime = Date.now();\n\n    // Log after response finishes\n    res.on('finish', () => {\n      const latencyMs = Date.now() - startTime;\n      auditLogger.logRequest(req, res, latencyMs);\n    });\n\n    next();\n  };\n}\n\n// Export singleton\nexport const auditLogger = AuditLogger.getInstance();\n"]}
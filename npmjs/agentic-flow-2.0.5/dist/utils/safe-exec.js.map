{"version":3,"file":"safe-exec.js","sourceRoot":"","sources":["../../src/utils/safe-exec.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Safe Command Execution Utility\n *\n * Prevents command injection by:\n * 1. Using execFileSync instead of execSync (no shell interpretation)\n * 2. Validating all inputs against strict patterns\n * 3. Never passing user input through shell\n */\n\nimport { execFileSync, ExecFileSyncOptions } from 'child_process';\n\n/**\n * Validation patterns for common input types\n */\nexport const VALIDATION_PATTERNS = {\n  // Alphanumeric with dashes, underscores, dots, colons\n  key: /^[a-zA-Z0-9_\\-.:]+$/,\n  // Namespace: alphanumeric with dashes and underscores only\n  namespace: /^[a-zA-Z0-9_-]+$/,\n  // Pattern: alphanumeric with wildcards\n  pattern: /^[a-zA-Z0-9_\\-.*?]+$/,\n  // Swarm ID: alphanumeric with dashes\n  swarmId: /^[a-zA-Z0-9_-]+$/,\n  // Agent name: kebab-case\n  agentName: /^[a-z0-9]+(?:-[a-z0-9]+)*$/,\n  // Task ID: UUID or simple ID\n  taskId: /^[a-zA-Z0-9_-]+$/,\n  // Category: alphanumeric with dashes and underscores\n  category: /^[a-zA-Z0-9_-]+$/,\n  // Topology: specific allowed values\n  topology: /^(hierarchical|mesh|ring|star)$/,\n  // Agent type: specific allowed values\n  agentType: /^(coordinator|analyst|optimizer|documenter|monitor|specialist|architect|task-orchestrator|code-analyzer|perf-analyzer|api-docs|performance-benchmarker|system-architect|researcher|coder|tester|reviewer)$/,\n  // Strategy: specific allowed values\n  strategy: /^(parallel|sequential|adaptive|balanced)$/,\n  // Priority: specific allowed values\n  priority: /^(low|medium|high|critical)$/,\n};\n\n/**\n * Validate a string against a pattern\n */\nexport function validateInput(\n  value: string,\n  pattern: RegExp,\n  fieldName: string\n): string {\n  if (!pattern.test(value)) {\n    throw new Error(\n      `Invalid ${fieldName}: contains disallowed characters. ` +\n      `Only alphanumeric characters and limited special characters are allowed.`\n    );\n  }\n  return value;\n}\n\n/**\n * Validate and sanitize a key parameter\n */\nexport function validateKey(key: string): string {\n  if (key.length > 256) {\n    throw new Error('Key too long (max 256 characters)');\n  }\n  return validateInput(key, VALIDATION_PATTERNS.key, 'key');\n}\n\n/**\n * Validate and sanitize a namespace parameter\n */\nexport function validateNamespace(namespace: string): string {\n  if (namespace.length > 64) {\n    throw new Error('Namespace too long (max 64 characters)');\n  }\n  return validateInput(namespace, VALIDATION_PATTERNS.namespace, 'namespace');\n}\n\n/**\n * Validate and sanitize a pattern parameter\n */\nexport function validatePattern(pattern: string): string {\n  if (pattern.length > 256) {\n    throw new Error('Pattern too long (max 256 characters)');\n  }\n  return validateInput(pattern, VALIDATION_PATTERNS.pattern, 'pattern');\n}\n\n/**\n * Validate a value - allow any content but limit size\n */\nexport function validateValue(value: string, maxLength: number = 1048576): string {\n  if (value.length > maxLength) {\n    throw new Error(`Value too long (max ${maxLength} characters)`);\n  }\n  // Values can contain any content - they're passed as array args, not shell-interpreted\n  return value;\n}\n\n/**\n * Safe execution of npx commands\n * Uses execFileSync with array arguments to prevent shell injection\n */\nexport function safeExecNpx(\n  pkg: string,\n  args: string[],\n  options?: ExecFileSyncOptions\n): string {\n  const defaultOptions: ExecFileSyncOptions = {\n    encoding: 'utf-8',\n    maxBuffer: 10 * 1024 * 1024,\n    timeout: 30000,\n    ...options,\n  };\n\n  try {\n    // Use npx with --yes to auto-confirm\n    const result = execFileSync('npx', ['--yes', pkg, ...args], defaultOptions);\n    return typeof result === 'string' ? result : result.toString();\n  } catch (error: any) {\n    // Sanitize error message to not leak system info\n    const message = error.message || 'Command execution failed';\n    throw new Error(`Execution failed: ${message.substring(0, 200)}`);\n  }\n}\n\n/**\n * Execute claude-flow memory commands safely\n */\nexport function execMemoryStore(\n  key: string,\n  value: string,\n  namespace: string = 'default',\n  ttl?: number\n): string {\n  // Validate inputs\n  const safeKey = validateKey(key);\n  const safeValue = validateValue(value);\n  const safeNamespace = validateNamespace(namespace);\n\n  const args = ['memory', 'store', safeKey, safeValue, '--namespace', safeNamespace];\n  if (ttl !== undefined && ttl > 0) {\n    args.push('--ttl', String(ttl));\n  }\n\n  return safeExecNpx('claude-flow@alpha', args);\n}\n\n/**\n * Execute claude-flow memory retrieve safely\n */\nexport function execMemoryRetrieve(\n  key: string,\n  namespace: string = 'default'\n): string {\n  const safeKey = validateKey(key);\n  const safeNamespace = validateNamespace(namespace);\n\n  return safeExecNpx('claude-flow@alpha', [\n    'memory', 'retrieve', safeKey, '--namespace', safeNamespace\n  ]);\n}\n\n/**\n * Execute claude-flow memory search safely\n */\nexport function execMemorySearch(\n  pattern: string,\n  namespace?: string,\n  limit: number = 10\n): string {\n  const safePattern = validatePattern(pattern);\n  const safeLimit = Math.min(Math.max(1, limit), 100);\n\n  const args = ['memory', 'search', safePattern, '--limit', String(safeLimit)];\n  if (namespace) {\n    args.push('--namespace', validateNamespace(namespace));\n  }\n\n  return safeExecNpx('claude-flow@alpha', args);\n}\n\n/**\n * Execute claude-flow swarm init safely\n */\nexport function execSwarmInit(\n  swarmId: string,\n  topology: string,\n  maxAgents: number = 8\n): string {\n  const safeSwarmId = validateInput(swarmId, VALIDATION_PATTERNS.swarmId, 'swarmId');\n  const safeTopology = validateInput(topology, VALIDATION_PATTERNS.topology, 'topology');\n  const safeMaxAgents = Math.min(Math.max(1, maxAgents), 100);\n\n  return safeExecNpx('claude-flow@alpha', [\n    'swarm', 'init',\n    '--id', safeSwarmId,\n    '--topology', safeTopology,\n    '--max-agents', String(safeMaxAgents)\n  ]);\n}\n\n/**\n * Execute claude-flow agent spawn safely\n */\nexport function execAgentSpawn(\n  name: string,\n  type: string,\n  swarmId?: string,\n  capabilities?: string[]\n): string {\n  const safeName = validateInput(name, VALIDATION_PATTERNS.agentName, 'name');\n  const safeType = validateInput(type, VALIDATION_PATTERNS.agentType, 'type');\n\n  const args = ['agent', 'spawn', '--name', safeName, '--type', safeType];\n\n  if (swarmId) {\n    args.push('--swarm', validateInput(swarmId, VALIDATION_PATTERNS.swarmId, 'swarmId'));\n  }\n\n  if (capabilities && capabilities.length > 0) {\n    // Validate each capability\n    const safeCapabilities = capabilities.map(cap =>\n      validateInput(cap, VALIDATION_PATTERNS.key, 'capability')\n    );\n    args.push('--capabilities', safeCapabilities.join(','));\n  }\n\n  return safeExecNpx('claude-flow@alpha', args);\n}\n\n/**\n * Execute claude-flow task orchestrate safely\n */\nexport function execTaskOrchestrate(\n  task: string,\n  strategy: string = 'auto',\n  priority: string = 'medium'\n): string {\n  // Task description can contain most text, but validate length\n  if (task.length > 10000) {\n    throw new Error('Task description too long (max 10000 characters)');\n  }\n\n  const safeStrategy = validateInput(strategy, VALIDATION_PATTERNS.strategy, 'strategy');\n  const safePriority = validateInput(priority, VALIDATION_PATTERNS.priority, 'priority');\n\n  return safeExecNpx('claude-flow@alpha', [\n    'task', 'orchestrate',\n    '--task', task,\n    '--strategy', safeStrategy,\n    '--priority', safePriority\n  ]);\n}\n\nexport default {\n  validateInput,\n  validateKey,\n  validateNamespace,\n  validatePattern,\n  validateValue,\n  safeExecNpx,\n  execMemoryStore,\n  execMemoryRetrieve,\n  execMemorySearch,\n  execSwarmInit,\n  execAgentSpawn,\n  execTaskOrchestrate,\n  VALIDATION_PATTERNS,\n};\n"]}
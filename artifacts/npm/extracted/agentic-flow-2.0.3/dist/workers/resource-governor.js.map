{"version":3,"file":"resource-governor.js","sourceRoot":"","sources":["../../src/workers/resource-governor.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * ResourceGovernor - Prevents resource exhaustion for background workers\n */\n\nimport { WorkerId, WorkerTrigger, WorkerInfo, ResourceLimits, ResourceStats } from './types.js';\nimport { getWorkerRegistry } from './worker-registry.js';\nimport { TRIGGER_CONFIGS } from './trigger-detector.js';\n\nconst DEFAULT_LIMITS: ResourceLimits = {\n  maxConcurrentWorkers: 10,\n  maxPerTrigger: 3,\n  maxHeapMB: 1024,\n  workerTimeout: 600000  // 10 minutes\n};\n\nexport class ResourceGovernor {\n  private limits: ResourceLimits;\n  private activeWorkers: Map<WorkerId, WorkerInfo> = new Map();\n  private timeouts: Map<WorkerId, NodeJS.Timeout> = new Map();\n\n  constructor(limits?: Partial<ResourceLimits>) {\n    this.limits = { ...DEFAULT_LIMITS, ...limits };\n  }\n\n  /**\n   * Check if a new worker can be spawned\n   */\n  canSpawn(trigger: WorkerTrigger): { allowed: boolean; reason?: string } {\n    // Check total worker count\n    if (this.activeWorkers.size >= this.limits.maxConcurrentWorkers) {\n      return {\n        allowed: false,\n        reason: `Max workers (${this.limits.maxConcurrentWorkers}) reached`\n      };\n    }\n\n    // Check workers of same type\n    const sameType = Array.from(this.activeWorkers.values())\n      .filter(w => w.trigger === trigger);\n\n    if (sameType.length >= this.limits.maxPerTrigger) {\n      return {\n        allowed: false,\n        reason: `Max ${trigger} workers (${this.limits.maxPerTrigger}) reached`\n      };\n    }\n\n    // Check memory usage\n    const memUsage = process.memoryUsage();\n    const heapUsedMB = memUsage.heapUsed / (1024 * 1024);\n    if (heapUsedMB > this.limits.maxHeapMB) {\n      return {\n        allowed: false,\n        reason: `Memory limit exceeded: ${heapUsedMB.toFixed(0)}MB > ${this.limits.maxHeapMB}MB`\n      };\n    }\n\n    return { allowed: true };\n  }\n\n  /**\n   * Register a new worker\n   */\n  register(worker: WorkerInfo): void {\n    this.activeWorkers.set(worker.id, worker);\n\n    // Get timeout from trigger config or use default\n    const config = TRIGGER_CONFIGS.get(worker.trigger);\n    const timeout = config?.timeout || this.limits.workerTimeout;\n\n    // Set timeout for cleanup\n    const timer = setTimeout(() => {\n      const w = this.activeWorkers.get(worker.id);\n      if (w && w.status !== 'complete' && w.status !== 'failed') {\n        // Mark as timeout in registry\n        const registry = getWorkerRegistry();\n        registry.updateStatus(worker.id, 'timeout', {\n          error: `Worker exceeded timeout of ${timeout}ms`\n        });\n        this.unregister(worker.id);\n      }\n    }, timeout);\n\n    this.timeouts.set(worker.id, timer);\n  }\n\n  /**\n   * Update worker in tracking\n   */\n  update(workerId: WorkerId, updates: Partial<WorkerInfo>): void {\n    const worker = this.activeWorkers.get(workerId);\n    if (worker) {\n      this.activeWorkers.set(workerId, { ...worker, ...updates });\n    }\n  }\n\n  /**\n   * Unregister a worker\n   */\n  unregister(workerId: WorkerId): void {\n    this.activeWorkers.delete(workerId);\n\n    const timer = this.timeouts.get(workerId);\n    if (timer) {\n      clearTimeout(timer);\n      this.timeouts.delete(workerId);\n    }\n  }\n\n  /**\n   * Get resource statistics\n   */\n  getStats(): ResourceStats {\n    const workersByType: Record<string, number> = {};\n\n    for (const worker of this.activeWorkers.values()) {\n      workersByType[worker.trigger] = (workersByType[worker.trigger] || 0) + 1;\n    }\n\n    return {\n      activeWorkers: this.activeWorkers.size,\n      workersByType,\n      memoryUsage: process.memoryUsage(),\n      uptime: process.uptime()\n    };\n  }\n\n  /**\n   * Get all active workers\n   */\n  getActiveWorkers(): WorkerInfo[] {\n    return Array.from(this.activeWorkers.values());\n  }\n\n  /**\n   * Get a specific active worker\n   */\n  getWorker(workerId: WorkerId): WorkerInfo | undefined {\n    return this.activeWorkers.get(workerId);\n  }\n\n  /**\n   * Check if a worker is active\n   */\n  isActive(workerId: WorkerId): boolean {\n    return this.activeWorkers.has(workerId);\n  }\n\n  /**\n   * Get current limits\n   */\n  getLimits(): ResourceLimits {\n    return { ...this.limits };\n  }\n\n  /**\n   * Update limits\n   */\n  setLimits(limits: Partial<ResourceLimits>): void {\n    this.limits = { ...this.limits, ...limits };\n  }\n\n  /**\n   * Force cleanup of a worker\n   */\n  forceCleanup(workerId: WorkerId): boolean {\n    if (!this.activeWorkers.has(workerId)) {\n      return false;\n    }\n\n    const registry = getWorkerRegistry();\n    registry.updateStatus(workerId, 'cancelled', {\n      error: 'Force cancelled by resource governor'\n    });\n    this.unregister(workerId);\n    return true;\n  }\n\n  /**\n   * Cleanup all workers (for shutdown)\n   */\n  cleanupAll(): void {\n    for (const workerId of this.activeWorkers.keys()) {\n      this.forceCleanup(workerId);\n    }\n  }\n\n  /**\n   * Get slot availability info\n   */\n  getAvailability(): {\n    totalSlots: number;\n    usedSlots: number;\n    availableSlots: number;\n    byTrigger: Record<string, { used: number; max: number }>;\n  } {\n    const stats = this.getStats();\n    const byTrigger: Record<string, { used: number; max: number }> = {};\n\n    for (const trigger of TRIGGER_CONFIGS.keys()) {\n      byTrigger[trigger] = {\n        used: stats.workersByType[trigger] || 0,\n        max: this.limits.maxPerTrigger\n      };\n    }\n\n    return {\n      totalSlots: this.limits.maxConcurrentWorkers,\n      usedSlots: stats.activeWorkers,\n      availableSlots: this.limits.maxConcurrentWorkers - stats.activeWorkers,\n      byTrigger\n    };\n  }\n}\n\n// Singleton instance\nlet instance: ResourceGovernor | null = null;\n\nexport function getResourceGovernor(): ResourceGovernor {\n  if (!instance) {\n    instance = new ResourceGovernor();\n  }\n  return instance;\n}\n"]}
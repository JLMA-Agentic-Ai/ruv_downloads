{"version":3,"file":"EmbeddingService.js","sourceRoot":"","sources":["../../src/intelligence/EmbeddingService.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * EmbeddingService - Unified embedding interface for agentic-flow\n *\n * Uses ruvector@0.1.61+ for ONNX embeddings with:\n * - SIMD128 acceleration (6x faster)\n * - Parallel worker threads (7 workers)\n * - all-MiniLM-L6-v2 model (384 dimensions)\n * - Persistent SQLite cache (0.1ms vs 400ms)\n *\n * Configure via:\n * - AGENTIC_FLOW_EMBEDDINGS=simple|onnx|auto (default: auto)\n * - AGENTIC_FLOW_EMBEDDING_MODEL=all-MiniLM-L6-v2 (default)\n * - AGENTIC_FLOW_EMBEDDING_CACHE=true|false (default: true)\n * - AGENTIC_FLOW_PERSISTENT_CACHE=true|false (default: true)\n */\n\nimport { getEmbeddingCache, type EmbeddingCache } from './EmbeddingCache.js';\n\nexport type EmbeddingBackend = 'simple' | 'onnx' | 'auto';\n\nexport interface EmbeddingStats {\n  backend: EmbeddingBackend;\n  effectiveBackend: EmbeddingBackend;\n  dimension: number;\n  totalEmbeddings: number;\n  totalLatencyMs: number;\n  avgLatencyMs: number;\n  cacheHits: number;\n  modelLoaded: boolean;\n  modelName?: string;\n  simdAvailable?: boolean;\n  parallelWorkers?: number;\n  // Persistent cache stats\n  persistentCache?: {\n    enabled: boolean;\n    entries: number;\n    hits: number;\n    misses: number;\n    hitRate: number;\n    dbSizeKB: number;\n  };\n}\n\nexport interface SimilarityResult {\n  similarity: number;\n  timeMs: number;\n}\n\nexport interface SearchResult {\n  text: string;\n  index: number;\n  similarity: number;\n}\n\nexport interface DuplicateGroup {\n  indices: number[];\n  texts: string[];\n  similarity: number;\n}\n\n// Ruvector embedding result types\ninterface EmbeddingResult {\n  embedding: Float32Array;\n  timeMs?: number;\n}\n\ninterface BatchEmbeddingResult {\n  embeddings: Float32Array[];\n  timeMs?: number;\n}\n\n// Ruvector module interface\ninterface RuvectorModule {\n  isOnnxAvailable: () => boolean;\n  getDefaultEmbeddingService: () => any;\n  embed: (text: string) => Promise<EmbeddingResult | null>;\n  embedBatch: (texts: string[]) => Promise<BatchEmbeddingResult | null>;\n  similarity: (text1: string, text2: string) => Promise<SimilarityResult>;\n  toFloat32Array: (arr: number[]) => Float32Array;\n  cosineSimilarity: (a: Float32Array, b: Float32Array) => number;\n  getStats: () => any;\n  shutdown: () => Promise<void>;\n}\n\n// ONNX availability cache\nlet onnxAvailable: boolean | null = null;\nlet ruvectorModule: RuvectorModule | null = null;\n\n/**\n * Detect ONNX/SIMD support by loading ruvector\n */\nasync function detectOnnx(): Promise<boolean> {\n  if (onnxAvailable !== null) {\n    return onnxAvailable;\n  }\n\n  try {\n    const mod = await import('ruvector') as unknown as RuvectorModule;\n    ruvectorModule = mod;\n    onnxAvailable = mod.isOnnxAvailable?.() ?? false;\n    return onnxAvailable;\n  } catch (error) {\n    // Ruvector loading failed - fall back to simple embeddings\n    onnxAvailable = false;\n    return false;\n  }\n}\n\n// Simple LRU cache for embeddings (in-memory, fast)\nclass LRUCache {\n  private cache: Map<string, Float32Array> = new Map();\n  private maxSize: number;\n\n  constructor(maxSize: number = 1000) {\n    this.maxSize = maxSize;\n  }\n\n  get(key: string): Float32Array | undefined {\n    const value = this.cache.get(key);\n    if (value) {\n      // Move to end (most recently used)\n      this.cache.delete(key);\n      this.cache.set(key, value);\n    }\n    return value;\n  }\n\n  set(key: string, value: Float32Array): void {\n    if (this.cache.size >= this.maxSize) {\n      // Delete oldest (first) entry\n      const firstKey = this.cache.keys().next().value;\n      if (firstKey) {\n        this.cache.delete(firstKey);\n      }\n    }\n    this.cache.set(key, value);\n  }\n\n  clear(): void {\n    this.cache.clear();\n  }\n\n  get size(): number {\n    return this.cache.size;\n  }\n}\n\nexport class EmbeddingService {\n  private static instance: EmbeddingService | null = null;\n\n  private backend: EmbeddingBackend;\n  private effectiveBackend: EmbeddingBackend | null = null;\n  private dimension: number;\n  private modelName: string;\n\n  // ONNX state\n  private modelLoaded: boolean = false;\n  private loadingPromise: Promise<void> | null = null;\n\n  // Stats\n  private totalEmbeddings: number = 0;\n  private totalLatencyMs: number = 0;\n  private cacheHits: number = 0;\n\n  // Cache (in-memory LRU)\n  private cache: LRUCache;\n  private cacheEnabled: boolean;\n\n  // Persistent cache (SQLite)\n  private persistentCache: EmbeddingCache | null = null;\n  private persistentCacheEnabled: boolean;\n\n  // Corpus for search operations\n  private corpus: { texts: string[]; embeddings: Float32Array[] } = { texts: [], embeddings: [] };\n\n  private constructor() {\n    // Default to 'auto' which will detect ONNX and use it if available\n    this.backend = (process.env.AGENTIC_FLOW_EMBEDDINGS as EmbeddingBackend) || 'auto';\n    this.modelName = process.env.AGENTIC_FLOW_EMBEDDING_MODEL || 'all-MiniLM-L6-v2';\n    this.dimension = 256; // Will be updated when ONNX loads (384)\n    this.cacheEnabled = process.env.AGENTIC_FLOW_EMBEDDING_CACHE !== 'false';\n    this.persistentCacheEnabled = process.env.AGENTIC_FLOW_PERSISTENT_CACHE !== 'false';\n    this.cache = new LRUCache(1000);\n\n    // Initialize persistent cache\n    if (this.persistentCacheEnabled) {\n      try {\n        this.persistentCache = getEmbeddingCache({ dimension: 384 });\n      } catch (error) {\n        console.warn('[EmbeddingService] Persistent cache unavailable:', error);\n        this.persistentCacheEnabled = false;\n      }\n    }\n  }\n\n  static getInstance(): EmbeddingService {\n    if (!EmbeddingService.instance) {\n      EmbeddingService.instance = new EmbeddingService();\n    }\n    return EmbeddingService.instance;\n  }\n\n  /**\n   * Resolve the effective backend based on ONNX detection\n   */\n  private async resolveBackend(): Promise<EmbeddingBackend> {\n    if (this.effectiveBackend) {\n      return this.effectiveBackend;\n    }\n\n    if (this.backend === 'auto') {\n      const hasOnnx = await detectOnnx();\n      this.effectiveBackend = hasOnnx ? 'onnx' : 'simple';\n      if (hasOnnx) {\n        this.dimension = 384; // all-MiniLM-L6-v2 dimension\n      }\n    } else {\n      this.effectiveBackend = this.backend;\n      if (this.backend === 'onnx') {\n        await detectOnnx(); // Ensure module is loaded\n        this.dimension = 384;\n      }\n    }\n\n    return this.effectiveBackend;\n  }\n\n  /**\n   * Get configured backend (may be 'auto')\n   */\n  getBackend(): EmbeddingBackend {\n    return this.backend;\n  }\n\n  /**\n   * Get effective backend after detection\n   */\n  getEffectiveBackend(): EmbeddingBackend {\n    return this.effectiveBackend || this.backend;\n  }\n\n  /**\n   * Get embedding dimension\n   */\n  getDimension(): number {\n    return this.dimension;\n  }\n\n  /**\n   * Check if ONNX model is loaded\n   */\n  isModelLoaded(): boolean {\n    return this.modelLoaded;\n  }\n\n  /**\n   * Generate embedding for text\n   * Auto-detects ONNX and uses it if available (default behavior)\n   */\n  async embed(text: string): Promise<Float32Array> {\n    const startTime = performance.now();\n\n    // Check in-memory cache first (fastest)\n    if (this.cacheEnabled) {\n      const cached = this.cache.get(text);\n      if (cached) {\n        this.cacheHits++;\n        return cached;\n      }\n    }\n\n    // Check persistent cache (SQLite, ~0.1ms)\n    if (this.persistentCache) {\n      const cached = this.persistentCache.get(text, this.modelName);\n      if (cached) {\n        this.cacheHits++;\n        // Also store in memory cache for faster subsequent access\n        if (this.cacheEnabled) {\n          this.cache.set(text, cached);\n        }\n        return cached;\n      }\n    }\n\n    // Resolve backend (handles 'auto' mode)\n    const effectiveBackend = await this.resolveBackend();\n    let embedding: Float32Array;\n\n    if (effectiveBackend === 'onnx' && ruvectorModule) {\n      const result = await ruvectorModule.embed(text);\n      if (result?.embedding) {\n        embedding = result.embedding;\n        this.modelLoaded = true;\n      } else {\n        embedding = this.simpleEmbed(text);\n      }\n    } else {\n      embedding = this.simpleEmbed(text);\n    }\n\n    // Update stats\n    this.totalEmbeddings++;\n    this.totalLatencyMs += performance.now() - startTime;\n\n    // Cache result in memory\n    if (this.cacheEnabled) {\n      this.cache.set(text, embedding);\n    }\n\n    // Cache result persistently (for cross-session)\n    if (this.persistentCache && effectiveBackend === 'onnx') {\n      this.persistentCache.set(text, embedding, this.modelName);\n    }\n\n    return embedding;\n  }\n\n  /**\n   * Generate embeddings for multiple texts (batch processing with parallel workers)\n   * Batch processing provides significant speedup with parallel ONNX workers\n   */\n  async embedBatch(texts: string[]): Promise<Float32Array[]> {\n    const startTime = performance.now();\n\n    // Check cache for all texts first\n    if (this.cacheEnabled) {\n      const cachedResults: (Float32Array | null)[] = texts.map(t => this.cache.get(t) || null);\n      const allCached = cachedResults.every(r => r !== null);\n      if (allCached) {\n        this.cacheHits += texts.length;\n        return cachedResults as Float32Array[];\n      }\n    }\n\n    // Resolve backend\n    const effectiveBackend = await this.resolveBackend();\n\n    if (effectiveBackend === 'onnx' && ruvectorModule) {\n      const result = await ruvectorModule.embedBatch(texts);\n      if (result?.embeddings && result.embeddings.length === texts.length) {\n        const embeddings = result.embeddings;\n\n        // Cache individual embeddings\n        if (this.cacheEnabled) {\n          for (let i = 0; i < texts.length; i++) {\n            this.cache.set(texts[i], embeddings[i]);\n          }\n        }\n\n        // Update stats\n        this.totalEmbeddings += texts.length;\n        this.totalLatencyMs += performance.now() - startTime;\n        this.modelLoaded = true;\n\n        return embeddings;\n      }\n    }\n\n    // Fall back to sequential for simple backend\n    return Promise.all(texts.map(t => this.embed(t)));\n  }\n\n  /**\n   * Compute similarity between two texts\n   */\n  async similarity(text1: string, text2: string): Promise<number> {\n    const effectiveBackend = await this.resolveBackend();\n\n    if (effectiveBackend === 'onnx' && ruvectorModule) {\n      const result = await ruvectorModule.similarity(text1, text2);\n      return result.similarity;\n    }\n\n    // Fall back to embedding + cosine\n    const [e1, e2] = await Promise.all([this.embed(text1), this.embed(text2)]);\n    return this.cosineSimilarity(e1, e2);\n  }\n\n  /**\n   * Compute NxN similarity matrix for a list of texts\n   * Uses parallel workers for ONNX backend\n   */\n  async similarityMatrix(texts: string[]): Promise<number[][]> {\n    const embeddings = await this.embedBatch(texts);\n    const n = texts.length;\n    const matrix: number[][] = Array(n).fill(null).map(() => Array(n).fill(0));\n\n    for (let i = 0; i < n; i++) {\n      matrix[i][i] = 1.0; // Self-similarity\n      for (let j = i + 1; j < n; j++) {\n        const sim = this.cosineSimilarity(embeddings[i], embeddings[j]);\n        matrix[i][j] = sim;\n        matrix[j][i] = sim; // Symmetric\n      }\n    }\n\n    return matrix;\n  }\n\n  /**\n   * Build a corpus for semantic search\n   */\n  async buildCorpus(texts: string[]): Promise<void> {\n    this.corpus.texts = texts;\n    this.corpus.embeddings = await this.embedBatch(texts);\n  }\n\n  /**\n   * Semantic search against the corpus\n   * Returns top-k most similar texts\n   */\n  async semanticSearch(query: string, topK: number = 5): Promise<SearchResult[]> {\n    if (this.corpus.texts.length === 0) {\n      throw new Error('Corpus not built. Call buildCorpus() first.');\n    }\n\n    const queryEmbedding = await this.embed(query);\n    const results: SearchResult[] = [];\n\n    for (let i = 0; i < this.corpus.texts.length; i++) {\n      const sim = this.cosineSimilarity(queryEmbedding, this.corpus.embeddings[i]);\n      results.push({\n        text: this.corpus.texts[i],\n        index: i,\n        similarity: sim,\n      });\n    }\n\n    // Sort by similarity (descending) and return top-k\n    results.sort((a, b) => b.similarity - a.similarity);\n    return results.slice(0, topK);\n  }\n\n  /**\n   * Find near-duplicate texts in a list\n   * Groups texts with similarity above threshold\n   */\n  async findDuplicates(texts: string[], threshold: number = 0.9): Promise<DuplicateGroup[]> {\n    const embeddings = await this.embedBatch(texts);\n    const n = texts.length;\n    const visited = new Set<number>();\n    const groups: DuplicateGroup[] = [];\n\n    for (let i = 0; i < n; i++) {\n      if (visited.has(i)) continue;\n\n      const group: DuplicateGroup = {\n        indices: [i],\n        texts: [texts[i]],\n        similarity: 1.0,\n      };\n\n      for (let j = i + 1; j < n; j++) {\n        if (visited.has(j)) continue;\n\n        const sim = this.cosineSimilarity(embeddings[i], embeddings[j]);\n        if (sim >= threshold) {\n          group.indices.push(j);\n          group.texts.push(texts[j]);\n          group.similarity = Math.min(group.similarity, sim);\n          visited.add(j);\n        }\n      }\n\n      if (group.indices.length > 1) {\n        visited.add(i);\n        groups.push(group);\n      }\n    }\n\n    return groups;\n  }\n\n  /**\n   * K-means clustering of texts\n   * Returns cluster assignments and centroids\n   */\n  async clusterTexts(\n    texts: string[],\n    k: number = 3,\n    maxIterations: number = 100\n  ): Promise<{ clusters: number[]; centroids: Float32Array[] }> {\n    const embeddings = await this.embedBatch(texts);\n    const n = texts.length;\n    const dim = this.dimension;\n\n    // Initialize centroids randomly (copy to new ArrayBuffer for consistent typing)\n    const centroidIndices = new Set<number>();\n    while (centroidIndices.size < k && centroidIndices.size < n) {\n      centroidIndices.add(Math.floor(Math.random() * n));\n    }\n    let centroids: Float32Array[] = Array.from(centroidIndices).map(i => {\n      const copy = new Float32Array(dim);\n      copy.set(embeddings[i]);\n      return copy;\n    });\n\n    let clusters = new Array(n).fill(0);\n\n    for (let iter = 0; iter < maxIterations; iter++) {\n      // Assign points to nearest centroid\n      const newClusters = embeddings.map(emb => {\n        let bestCluster = 0;\n        let bestSim = -Infinity;\n        for (let c = 0; c < k; c++) {\n          const sim = this.cosineSimilarity(emb, centroids[c]);\n          if (sim > bestSim) {\n            bestSim = sim;\n            bestCluster = c;\n          }\n        }\n        return bestCluster;\n      });\n\n      // Check convergence\n      const changed = newClusters.some((c, i) => c !== clusters[i]);\n      clusters = newClusters;\n      if (!changed) break;\n\n      // Update centroids\n      const newCentroids: Float32Array[] = [];\n      for (let c = 0; c < k; c++) {\n        newCentroids.push(new Float32Array(dim));\n      }\n      const counts = new Array(k).fill(0);\n\n      for (let i = 0; i < n; i++) {\n        const c = clusters[i];\n        counts[c]++;\n        for (let d = 0; d < dim; d++) {\n          newCentroids[c][d] += embeddings[i][d];\n        }\n      }\n\n      // Normalize centroids\n      for (let c = 0; c < k; c++) {\n        if (counts[c] > 0) {\n          let norm = 0;\n          for (let d = 0; d < dim; d++) {\n            newCentroids[c][d] /= counts[c];\n            norm += newCentroids[c][d] * newCentroids[c][d];\n          }\n          norm = Math.sqrt(norm) || 1;\n          for (let d = 0; d < dim; d++) {\n            newCentroids[c][d] /= norm;\n          }\n        }\n      }\n      centroids = newCentroids;\n    }\n\n    return { clusters, centroids };\n  }\n\n  /**\n   * Stream embeddings for large batches (memory efficient)\n   * Yields embeddings one at a time\n   */\n  async *streamEmbed(texts: string[], batchSize: number = 32): AsyncGenerator<{ index: number; text: string; embedding: Float32Array }> {\n    for (let i = 0; i < texts.length; i += batchSize) {\n      const batch = texts.slice(i, i + batchSize);\n      const embeddings = await this.embedBatch(batch);\n\n      for (let j = 0; j < batch.length; j++) {\n        yield {\n          index: i + j,\n          text: batch[j],\n          embedding: embeddings[j],\n        };\n      }\n    }\n  }\n\n  /**\n   * Simple hash-based embedding (fast, not semantic)\n   */\n  simpleEmbed(text: string, dim: number = 256): Float32Array {\n    const embedding = new Float32Array(dim);\n\n    // Multi-pass hash for better distribution\n    for (let i = 0; i < text.length; i++) {\n      const code = text.charCodeAt(i);\n      embedding[i % dim] += code / 255;\n      embedding[(i * 7) % dim] += (code * 0.3) / 255;\n      embedding[(i * 13) % dim] += (code * 0.2) / 255;\n    }\n\n    // Normalize\n    let norm = 0;\n    for (let i = 0; i < dim; i++) {\n      norm += embedding[i] * embedding[i];\n    }\n    norm = Math.sqrt(norm) || 1;\n    for (let i = 0; i < dim; i++) {\n      embedding[i] /= norm;\n    }\n\n    return embedding;\n  }\n\n  /**\n   * Compute cosine similarity between two embeddings\n   */\n  cosineSimilarity(a: Float32Array, b: Float32Array): number {\n    if (ruvectorModule?.cosineSimilarity) {\n      return ruvectorModule.cosineSimilarity(a, b);\n    }\n\n    // JS fallback\n    let dot = 0;\n    let normA = 0;\n    let normB = 0;\n    for (let i = 0; i < a.length; i++) {\n      dot += a[i] * b[i];\n      normA += a[i] * a[i];\n      normB += b[i] * b[i];\n    }\n    return dot / (Math.sqrt(normA) * Math.sqrt(normB) || 1);\n  }\n\n  /**\n   * Get statistics\n   */\n  getStats(): EmbeddingStats {\n    const effective = this.effectiveBackend || this.backend;\n    const ruvectorStats = ruvectorModule?.getStats?.() || {};\n\n    // Get persistent cache stats\n    let persistentCacheStats: EmbeddingStats['persistentCache'] | undefined;\n    if (this.persistentCache) {\n      const cacheStats = this.persistentCache.getStats();\n      persistentCacheStats = {\n        enabled: true,\n        entries: cacheStats.totalEntries,\n        hits: cacheStats.hits,\n        misses: cacheStats.misses,\n        hitRate: cacheStats.hitRate,\n        dbSizeKB: Math.round(cacheStats.dbSizeBytes / 1024),\n      };\n    }\n\n    return {\n      backend: this.backend,\n      effectiveBackend: effective,\n      dimension: this.dimension,\n      totalEmbeddings: this.totalEmbeddings,\n      totalLatencyMs: this.totalLatencyMs,\n      avgLatencyMs: this.totalEmbeddings > 0 ? this.totalLatencyMs / this.totalEmbeddings : 0,\n      cacheHits: this.cacheHits,\n      modelLoaded: this.modelLoaded,\n      modelName: effective === 'onnx' ? this.modelName : undefined,\n      simdAvailable: ruvectorStats.simdAvailable ?? onnxAvailable,\n      parallelWorkers: ruvectorStats.workerCount ?? undefined,\n      persistentCache: persistentCacheStats,\n    };\n  }\n\n  /**\n   * Clear in-memory cache\n   */\n  clearCache(): void {\n    this.cache.clear();\n  }\n\n  /**\n   * Clear persistent cache (SQLite)\n   */\n  clearPersistentCache(): void {\n    if (this.persistentCache) {\n      this.persistentCache.clear();\n    }\n  }\n\n  /**\n   * Clear all caches (memory + persistent)\n   */\n  clearAllCaches(): void {\n    this.cache.clear();\n    if (this.persistentCache) {\n      this.persistentCache.clear();\n    }\n  }\n\n  /**\n   * Get persistent cache stats\n   */\n  getPersistentCacheStats(): { entries: number; hits: number; misses: number; hitRate: number } | null {\n    if (!this.persistentCache) return null;\n    const stats = this.persistentCache.getStats();\n    return {\n      entries: stats.totalEntries,\n      hits: stats.hits,\n      misses: stats.misses,\n      hitRate: stats.hitRate,\n    };\n  }\n\n  /**\n   * Clear corpus\n   */\n  clearCorpus(): void {\n    this.corpus = { texts: [], embeddings: [] };\n  }\n\n  /**\n   * Shutdown (cleanup workers)\n   */\n  async shutdown(): Promise<void> {\n    if (ruvectorModule?.shutdown) {\n      await ruvectorModule.shutdown();\n    }\n  }\n\n  /**\n   * Reset instance (for testing)\n   */\n  static async reset(): Promise<void> {\n    if (EmbeddingService.instance) {\n      await EmbeddingService.instance.shutdown();\n    }\n    EmbeddingService.instance = null;\n    onnxAvailable = null;\n    ruvectorModule = null;\n  }\n\n  /**\n   * Pretrain cache with texts from files\n   * Embeds content and stores in persistent cache for fast retrieval\n   *\n   * @param sources - File paths or glob patterns, or array of texts\n   * @param options - Pretrain options\n   * @returns Stats about pretraining\n   */\n  async pretrain(\n    sources: string | string[],\n    options: {\n      batchSize?: number;\n      onProgress?: (processed: number, total: number) => void;\n      chunkSize?: number;      // Size of text chunks for large files\n      overlapSize?: number;    // Overlap between chunks\n      skipCached?: boolean;    // Skip already cached texts\n    } = {}\n  ): Promise<{\n    processed: number;\n    cached: number;\n    skipped: number;\n    timeMs: number;\n  }> {\n    const { batchSize = 32, onProgress, chunkSize = 512, overlapSize = 64, skipCached = true } = options;\n    const startTime = performance.now();\n    let processed = 0;\n    let cached = 0;\n    let skipped = 0;\n\n    // Resolve texts to embed\n    const texts: string[] = [];\n\n    if (typeof sources === 'string') {\n      sources = [sources];\n    }\n\n    for (const source of sources) {\n      // Check if it's a file path or glob pattern\n      if (source.includes('/') || source.includes('*') || source.includes('.')) {\n        try {\n          const fs = await import('fs');\n          const path = await import('path');\n          const { glob } = await import('glob').catch(() => ({ glob: null }));\n\n          // Handle glob patterns\n          let files: string[] = [];\n          if (source.includes('*') && glob) {\n            files = await glob(source);\n          } else if (fs.existsSync(source)) {\n            files = [source];\n          }\n\n          for (const file of files) {\n            try {\n              const content = fs.readFileSync(file, 'utf-8');\n              // Chunk large files\n              if (content.length > chunkSize * 2) {\n                for (let i = 0; i < content.length; i += chunkSize - overlapSize) {\n                  const chunk = content.slice(i, i + chunkSize);\n                  if (chunk.trim().length > 10) {\n                    texts.push(chunk);\n                  }\n                }\n              } else if (content.trim().length > 10) {\n                texts.push(content);\n              }\n            } catch {\n              // Skip unreadable files\n            }\n          }\n        } catch {\n          // Treat as plain text if file operations fail\n          texts.push(source);\n        }\n      } else {\n        texts.push(source);\n      }\n    }\n\n    // Filter out already cached texts\n    const toEmbed: string[] = [];\n    for (const text of texts) {\n      if (skipCached && this.persistentCache?.has(text, this.modelName)) {\n        skipped++;\n      } else {\n        toEmbed.push(text);\n      }\n    }\n\n    // Embed in batches\n    for (let i = 0; i < toEmbed.length; i += batchSize) {\n      const batch = toEmbed.slice(i, i + batchSize);\n      const embeddings = await this.embedBatch(batch);\n\n      // Store in persistent cache (embedBatch already handles this for ONNX)\n      cached += embeddings.length;\n      processed += batch.length;\n\n      if (onProgress) {\n        onProgress(processed, toEmbed.length);\n      }\n    }\n\n    return {\n      processed,\n      cached,\n      skipped,\n      timeMs: performance.now() - startTime,\n    };\n  }\n\n  /**\n   * Pretrain with common programming patterns\n   * Pre-caches embeddings for frequently used code patterns\n   */\n  async pretrainCodePatterns(): Promise<{ cached: number; timeMs: number }> {\n    const patterns = [\n      // Common programming constructs\n      'function implementation',\n      'class definition',\n      'interface declaration',\n      'type alias',\n      'import statement',\n      'export module',\n      'async await pattern',\n      'promise handling',\n      'error handling try catch',\n      'conditional logic if else',\n      'loop iteration for while',\n      'array map filter reduce',\n      'object destructuring',\n      'spread operator',\n      'rest parameters',\n\n      // Code operations\n      'refactor code',\n      'fix bug',\n      'add feature',\n      'write tests',\n      'add documentation',\n      'optimize performance',\n      'improve readability',\n      'handle edge cases',\n      'add validation',\n      'implement authentication',\n\n      // File types\n      'TypeScript file',\n      'JavaScript module',\n      'React component',\n      'Vue component',\n      'CSS stylesheet',\n      'JSON configuration',\n      'Markdown documentation',\n      'Python script',\n      'Shell script',\n      'SQL query',\n\n      // Agent routing patterns\n      'code review task',\n      'architecture design',\n      'testing strategy',\n      'debugging session',\n      'performance analysis',\n      'security audit',\n      'documentation update',\n      'API design',\n      'database schema',\n      'deployment configuration',\n    ];\n\n    const startTime = performance.now();\n    const embeddings = await this.embedBatch(patterns);\n\n    return {\n      cached: embeddings.length,\n      timeMs: performance.now() - startTime,\n    };\n  }\n\n  /**\n   * Pretrain from repository structure\n   * Analyzes file names and paths to pre-cache common patterns\n   */\n  async pretrainFromRepo(repoPath: string = '.'): Promise<{\n    files: number;\n    chunks: number;\n    timeMs: number;\n  }> {\n    const startTime = performance.now();\n    let files = 0;\n    let chunks = 0;\n\n    try {\n      const fs = await import('fs');\n      const path = await import('path');\n\n      // Common code file extensions\n      const extensions = ['.ts', '.tsx', '.js', '.jsx', '.py', '.md', '.json'];\n\n      const walkDir = (dir: string) => {\n        try {\n          const entries = fs.readdirSync(dir, { withFileTypes: true });\n          for (const entry of entries) {\n            const fullPath = path.join(dir, entry.name);\n            if (entry.isDirectory()) {\n              // Skip node_modules, .git, etc.\n              if (!entry.name.startsWith('.') && entry.name !== 'node_modules' && entry.name !== 'dist') {\n                walkDir(fullPath);\n              }\n            } else if (extensions.some(ext => entry.name.endsWith(ext))) {\n              return fullPath;\n            }\n          }\n        } catch {\n          // Skip unreadable directories\n        }\n        return null;\n      };\n\n      // Collect files\n      const filePaths: string[] = [];\n      const collectFiles = (dir: string) => {\n        try {\n          const entries = fs.readdirSync(dir, { withFileTypes: true });\n          for (const entry of entries) {\n            const fullPath = path.join(dir, entry.name);\n            if (entry.isDirectory()) {\n              if (!entry.name.startsWith('.') && entry.name !== 'node_modules' && entry.name !== 'dist') {\n                collectFiles(fullPath);\n              }\n            } else if (extensions.some(ext => entry.name.endsWith(ext))) {\n              filePaths.push(fullPath);\n            }\n          }\n        } catch {\n          // Skip unreadable\n        }\n      };\n\n      collectFiles(repoPath);\n      files = filePaths.length;\n\n      // Pretrain from collected files\n      if (filePaths.length > 0) {\n        const result = await this.pretrain(filePaths, {\n          batchSize: 16,\n          chunkSize: 512,\n          overlapSize: 64,\n        });\n        chunks = result.cached;\n      }\n    } catch (err) {\n      // Repository analysis failed\n    }\n\n    return {\n      files,\n      chunks,\n      timeMs: performance.now() - startTime,\n    };\n  }\n\n  /**\n   * Incremental pretrain - only process changed files since last run\n   * Uses git diff to detect modified files\n   */\n  async pretrainIncremental(options: {\n    since?: string;  // Git ref (commit, branch, tag) - default: HEAD~10\n    repoPath?: string;\n  } = {}): Promise<{\n    changedFiles: number;\n    newChunks: number;\n    skipped: number;\n    timeMs: number;\n  }> {\n    const { since = 'HEAD~10', repoPath = '.' } = options;\n    const startTime = performance.now();\n    let changedFiles = 0;\n    let newChunks = 0;\n    let skipped = 0;\n\n    try {\n      const { execSync } = await import('child_process');\n      const path = await import('path');\n      const fs = await import('fs');\n\n      // Get changed files from git\n      const gitOutput = execSync(`git diff --name-only ${since}`, {\n        cwd: repoPath,\n        encoding: 'utf-8',\n      });\n\n      const changedPaths = gitOutput\n        .split('\\n')\n        .filter(f => f.trim())\n        .map(f => path.join(repoPath, f))\n        .filter(f => {\n          try {\n            return fs.existsSync(f) && fs.statSync(f).isFile();\n          } catch {\n            return false;\n          }\n        });\n\n      changedFiles = changedPaths.length;\n\n      if (changedPaths.length > 0) {\n        const result = await this.pretrain(changedPaths, {\n          batchSize: 16,\n          chunkSize: 512,\n          overlapSize: 64,\n          skipCached: true,\n        });\n        newChunks = result.cached;\n        skipped = result.skipped;\n      }\n    } catch {\n      // Git not available or not a repo\n    }\n\n    return {\n      changedFiles,\n      newChunks,\n      skipped,\n      timeMs: performance.now() - startTime,\n    };\n  }\n\n  /**\n   * Smart chunking - split code by semantic boundaries\n   * (functions, classes, etc.) instead of fixed size\n   */\n  semanticChunk(content: string, fileType: string): string[] {\n    const chunks: string[] = [];\n\n    // TypeScript/JavaScript patterns\n    if (['.ts', '.tsx', '.js', '.jsx'].some(ext => fileType.endsWith(ext))) {\n      // Split on function/class/interface boundaries\n      const patterns = [\n        /^(export\\s+)?(async\\s+)?function\\s+\\w+/gm,\n        /^(export\\s+)?class\\s+\\w+/gm,\n        /^(export\\s+)?interface\\s+\\w+/gm,\n        /^(export\\s+)?type\\s+\\w+/gm,\n        /^(export\\s+)?const\\s+\\w+\\s*=/gm,\n      ];\n\n      let lastIndex = 0;\n      const boundaries: number[] = [0];\n\n      for (const pattern of patterns) {\n        let match;\n        while ((match = pattern.exec(content)) !== null) {\n          boundaries.push(match.index);\n        }\n      }\n\n      boundaries.push(content.length);\n      boundaries.sort((a, b) => a - b);\n\n      // Extract chunks between boundaries\n      for (let i = 0; i < boundaries.length - 1; i++) {\n        const chunk = content.slice(boundaries[i], boundaries[i + 1]).trim();\n        if (chunk.length > 20 && chunk.length < 2000) {\n          chunks.push(chunk);\n        }\n      }\n    }\n\n    // Python patterns\n    else if (fileType.endsWith('.py')) {\n      const patterns = [\n        /^(async\\s+)?def\\s+\\w+/gm,\n        /^class\\s+\\w+/gm,\n      ];\n\n      const boundaries: number[] = [0];\n      for (const pattern of patterns) {\n        let match;\n        while ((match = pattern.exec(content)) !== null) {\n          boundaries.push(match.index);\n        }\n      }\n      boundaries.push(content.length);\n      boundaries.sort((a, b) => a - b);\n\n      for (let i = 0; i < boundaries.length - 1; i++) {\n        const chunk = content.slice(boundaries[i], boundaries[i + 1]).trim();\n        if (chunk.length > 20 && chunk.length < 2000) {\n          chunks.push(chunk);\n        }\n      }\n    }\n\n    // Markdown - split by headers\n    else if (fileType.endsWith('.md')) {\n      const sections = content.split(/^#+\\s+/gm);\n      for (const section of sections) {\n        if (section.trim().length > 20) {\n          chunks.push(section.trim().slice(0, 1000));\n        }\n      }\n    }\n\n    // Fallback to fixed-size chunking\n    if (chunks.length === 0) {\n      const chunkSize = 512;\n      const overlap = 64;\n      for (let i = 0; i < content.length; i += chunkSize - overlap) {\n        const chunk = content.slice(i, i + chunkSize);\n        if (chunk.trim().length > 20) {\n          chunks.push(chunk);\n        }\n      }\n    }\n\n    return chunks;\n  }\n\n  /**\n   * Pretrain with semantic chunking\n   * Uses code structure to create meaningful chunks\n   */\n  async pretrainSemantic(\n    sources: string[],\n    options: {\n      batchSize?: number;\n      onProgress?: (processed: number, total: number) => void;\n    } = {}\n  ): Promise<{\n    files: number;\n    chunks: number;\n    timeMs: number;\n  }> {\n    const { batchSize = 32, onProgress } = options;\n    const startTime = performance.now();\n    let fileCount = 0;\n    let chunkCount = 0;\n\n    const allChunks: string[] = [];\n\n    try {\n      const fs = await import('fs');\n      const path = await import('path');\n\n      for (const source of sources) {\n        if (fs.existsSync(source)) {\n          try {\n            const content = fs.readFileSync(source, 'utf-8');\n            const ext = path.extname(source);\n            const chunks = this.semanticChunk(content, ext);\n            allChunks.push(...chunks);\n            fileCount++;\n          } catch {\n            // Skip unreadable files\n          }\n        }\n      }\n\n      // Embed and cache all chunks\n      for (let i = 0; i < allChunks.length; i += batchSize) {\n        const batch = allChunks.slice(i, i + batchSize);\n        await this.embedBatch(batch);\n        chunkCount += batch.length;\n        if (onProgress) {\n          onProgress(chunkCount, allChunks.length);\n        }\n      }\n    } catch {\n      // Pretrain failed\n    }\n\n    return {\n      files: fileCount,\n      chunks: chunkCount,\n      timeMs: performance.now() - startTime,\n    };\n  }\n\n  /**\n   * Priority pretrain - cache most frequently used patterns first\n   * Tracks access patterns and prioritizes high-frequency queries\n   */\n  private accessCounts: Map<string, number> = new Map();\n\n  recordAccess(text: string): void {\n    this.accessCounts.set(text, (this.accessCounts.get(text) || 0) + 1);\n  }\n\n  getTopPatterns(n: number = 100): string[] {\n    return Array.from(this.accessCounts.entries())\n      .sort((a, b) => b[1] - a[1])\n      .slice(0, n)\n      .map(([text]) => text);\n  }\n\n  async pretrainPriority(n: number = 100): Promise<{\n    cached: number;\n    timeMs: number;\n  }> {\n    const topPatterns = this.getTopPatterns(n);\n    const startTime = performance.now();\n\n    if (topPatterns.length > 0) {\n      await this.embedBatch(topPatterns);\n    }\n\n    return {\n      cached: topPatterns.length,\n      timeMs: performance.now() - startTime,\n    };\n  }\n\n  /**\n   * Warmup cache on session start\n   * Combines code patterns + recent repo changes\n   */\n  async warmup(repoPath: string = '.'): Promise<{\n    patterns: number;\n    recentChanges: number;\n    timeMs: number;\n  }> {\n    const startTime = performance.now();\n\n    // First: load common patterns\n    const patternResult = await this.pretrainCodePatterns();\n\n    // Second: load recent git changes\n    const incrementalResult = await this.pretrainIncremental({\n      since: 'HEAD~5',\n      repoPath,\n    });\n\n    return {\n      patterns: patternResult.cached,\n      recentChanges: incrementalResult.newChunks,\n      timeMs: performance.now() - startTime,\n    };\n  }\n\n  /**\n   * Intelligent pretrain using ruvector worker pool\n   * Analyzes repo structure, code patterns, and prepares cache\n   * Uses parallel workers for maximum throughput\n   */\n  async pretrainIntelligent(options: {\n    repoPath?: string;\n    parallel?: boolean;\n    onProgress?: (stage: string, progress: number) => void;\n  } = {}): Promise<{\n    stages: {\n      codePatterns: { count: number; timeMs: number };\n      astAnalysis: { files: number; functions: number; timeMs: number };\n      gitHistory: { commits: number; hotFiles: number; timeMs: number };\n      dependencies: { modules: number; imports: number; timeMs: number };\n      semanticChunks: { chunks: number; timeMs: number };\n    };\n    totalCached: number;\n    totalTimeMs: number;\n  }> {\n    const { repoPath = '.', parallel = true, onProgress } = options;\n    const startTime = performance.now();\n\n    const stages = {\n      codePatterns: { count: 0, timeMs: 0 },\n      astAnalysis: { files: 0, functions: 0, timeMs: 0 },\n      gitHistory: { commits: 0, hotFiles: 0, timeMs: 0 },\n      dependencies: { modules: 0, imports: 0, timeMs: 0 },\n      semanticChunks: { chunks: 0, timeMs: 0 },\n    };\n\n    let totalCached = 0;\n\n    try {\n      // Stage 1: Code patterns (common programming patterns)\n      onProgress?.('codePatterns', 0);\n      const stage1Start = performance.now();\n      const patternResult = await this.pretrainCodePatterns();\n      stages.codePatterns = {\n        count: patternResult.cached,\n        timeMs: performance.now() - stage1Start,\n      };\n      totalCached += patternResult.cached;\n      onProgress?.('codePatterns', 100);\n\n      // Stage 2: AST Analysis using ruvector workers (if available)\n      onProgress?.('astAnalysis', 0);\n      const stage2Start = performance.now();\n      try {\n        if (ruvectorModule && parallel) {\n          // Use ruvector's analyzeFilesParallel if available\n          const mod = ruvectorModule as any;\n          if (mod.analyzeFilesParallel) {\n            const fs = await import('fs');\n            const path = await import('path');\n\n            // Collect source files\n            const sourceFiles: string[] = [];\n            const collectSources = (dir: string) => {\n              try {\n                const entries = fs.readdirSync(dir, { withFileTypes: true });\n                for (const entry of entries) {\n                  const fullPath = path.join(dir, entry.name);\n                  if (entry.isDirectory()) {\n                    if (!entry.name.startsWith('.') && entry.name !== 'node_modules' && entry.name !== 'dist') {\n                      collectSources(fullPath);\n                    }\n                  } else if (['.ts', '.tsx', '.js', '.jsx'].some(ext => entry.name.endsWith(ext))) {\n                    sourceFiles.push(fullPath);\n                  }\n                }\n              } catch {}\n            };\n            collectSources(repoPath);\n\n            // Analyze in parallel\n            const astResult = await mod.analyzeFilesParallel(sourceFiles.slice(0, 100));\n            stages.astAnalysis = {\n              files: sourceFiles.length,\n              functions: astResult?.functions || 0,\n              timeMs: performance.now() - stage2Start,\n            };\n\n            // Extract function signatures for caching\n            if (astResult?.signatures) {\n              await this.embedBatch(astResult.signatures.slice(0, 200));\n              totalCached += Math.min(astResult.signatures.length, 200);\n            }\n          }\n        }\n      } catch {}\n      onProgress?.('astAnalysis', 100);\n\n      // Stage 3: Git history analysis (hot files = frequently changed)\n      onProgress?.('gitHistory', 0);\n      const stage3Start = performance.now();\n      try {\n        const { execSync } = await import('child_process');\n\n        // Get commit count\n        const commitCount = execSync('git rev-list --count HEAD', {\n          cwd: repoPath,\n          encoding: 'utf-8',\n        }).trim();\n\n        // Get hot files (most frequently changed)\n        const hotFilesOutput = execSync(\n          'git log --format=\"\" --name-only -n 100 | sort | uniq -c | sort -rn | head -20',\n          { cwd: repoPath, encoding: 'utf-8' }\n        );\n\n        const hotFiles = hotFilesOutput\n          .split('\\n')\n          .filter(l => l.trim())\n          .map(l => l.trim().split(/\\s+/).slice(1).join(' '))\n          .filter(f => f);\n\n        stages.gitHistory = {\n          commits: parseInt(commitCount) || 0,\n          hotFiles: hotFiles.length,\n          timeMs: performance.now() - stage3Start,\n        };\n\n        // Pretrain hot files\n        if (hotFiles.length > 0) {\n          const fs = await import('fs');\n          const path = await import('path');\n          const validFiles = hotFiles\n            .map(f => path.join(repoPath, f))\n            .filter(f => fs.existsSync(f));\n\n          if (validFiles.length > 0) {\n            const result = await this.pretrainSemantic(validFiles, { batchSize: 16 });\n            totalCached += result.chunks;\n          }\n        }\n      } catch {}\n      onProgress?.('gitHistory', 100);\n\n      // Stage 4: Dependency analysis\n      onProgress?.('dependencies', 0);\n      const stage4Start = performance.now();\n      try {\n        const fs = await import('fs');\n        const path = await import('path');\n\n        // Parse package.json for dependencies\n        const pkgPath = path.join(repoPath, 'package.json');\n        if (fs.existsSync(pkgPath)) {\n          const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf-8'));\n          const deps = Object.keys(pkg.dependencies || {});\n          const devDeps = Object.keys(pkg.devDependencies || {});\n          const allDeps = [...deps, ...devDeps];\n\n          stages.dependencies = {\n            modules: allDeps.length,\n            imports: 0,\n            timeMs: performance.now() - stage4Start,\n          };\n\n          // Cache dependency names for import resolution\n          if (allDeps.length > 0) {\n            const depPatterns = allDeps.map(d => `import from ${d}`);\n            await this.embedBatch(depPatterns);\n            totalCached += depPatterns.length;\n          }\n        }\n      } catch {}\n      onProgress?.('dependencies', 100);\n\n      // Stage 5: Semantic chunking with parallel embedding\n      onProgress?.('semanticChunks', 0);\n      const stage5Start = performance.now();\n      try {\n        const incrementalResult = await this.pretrainIncremental({\n          since: 'HEAD~20',\n          repoPath,\n        });\n        stages.semanticChunks = {\n          chunks: incrementalResult.newChunks,\n          timeMs: performance.now() - stage5Start,\n        };\n        totalCached += incrementalResult.newChunks;\n      } catch {}\n      onProgress?.('semanticChunks', 100);\n\n    } catch (err) {\n      // Pretrain failed, return partial results\n    }\n\n    return {\n      stages,\n      totalCached,\n      totalTimeMs: performance.now() - startTime,\n    };\n  }\n\n  /**\n   * Background pretrain - runs in worker if available\n   * Non-blocking, returns immediately with a promise\n   */\n  pretrainBackground(options: {\n    repoPath?: string;\n  } = {}): { promise: Promise<void>; cancel: () => void } {\n    let cancelled = false;\n\n    const promise = (async () => {\n      if (cancelled) return;\n\n      // Run warmup in background\n      await this.warmup(options.repoPath);\n\n      if (cancelled) return;\n\n      // Then run intelligent pretrain\n      await this.pretrainIntelligent({\n        ...options,\n        parallel: true,\n      });\n    })();\n\n    return {\n      promise,\n      cancel: () => { cancelled = true; },\n    };\n  }\n\n  /**\n   * AI-enhanced pretrain using ruvector attention mechanisms\n   * Uses HyperbolicAttention for code structure, MoE for routing\n   */\n  async pretrainWithAI(options: {\n    repoPath?: string;\n    attentionType?: 'hyperbolic' | 'moe' | 'graph' | 'auto';\n    onProgress?: (stage: string, detail: string) => void;\n  } = {}): Promise<{\n    patterns: { type: string; count: number }[];\n    attention: { type: string; timeMs: number };\n    predictions: { prefetch: number; confidence: number };\n    totalCached: number;\n    totalTimeMs: number;\n  }> {\n    const { repoPath = '.', attentionType = 'auto', onProgress } = options;\n    const startTime = performance.now();\n    const patterns: { type: string; count: number }[] = [];\n    let totalCached = 0;\n    let attentionInfo = { type: 'none', timeMs: 0 };\n    let predictions = { prefetch: 0, confidence: 0 };\n\n    try {\n      const mod = ruvectorModule as any;\n\n      // Step 1: Determine best attention type for codebase\n      onProgress?.('attention', 'Selecting optimal attention mechanism...');\n      let selectedAttention = attentionType;\n\n      if (attentionType === 'auto' && mod) {\n        // Use getAttentionForUseCase if available\n        if (mod.getAttentionForUseCase) {\n          const result = await mod.getAttentionForUseCase('code_analysis');\n          selectedAttention = result?.type || 'hyperbolic';\n        } else {\n          // Default to hyperbolic for hierarchical code structure\n          selectedAttention = 'hyperbolic';\n        }\n      }\n\n      attentionInfo.type = selectedAttention;\n      const attentionStart = performance.now();\n\n      // Step 2: Use attention to identify important code regions\n      onProgress?.('analysis', `Using ${selectedAttention} attention for code analysis...`);\n\n      if (mod) {\n        // Collect code samples for attention-based analysis\n        const fs = await import('fs');\n        const path = await import('path');\n\n        const codeSamples: string[] = [];\n        const collectCode = (dir: string, maxFiles: number = 50) => {\n          if (codeSamples.length >= maxFiles) return;\n          try {\n            const entries = fs.readdirSync(dir, { withFileTypes: true });\n            for (const entry of entries) {\n              if (codeSamples.length >= maxFiles) break;\n              const fullPath = path.join(dir, entry.name);\n              if (entry.isDirectory()) {\n                if (!entry.name.startsWith('.') && entry.name !== 'node_modules' && entry.name !== 'dist') {\n                  collectCode(fullPath, maxFiles);\n                }\n              } else if (['.ts', '.tsx', '.js', '.jsx'].some(ext => entry.name.endsWith(ext))) {\n                try {\n                  const content = fs.readFileSync(fullPath, 'utf-8');\n                  if (content.length < 5000) {\n                    codeSamples.push(content);\n                  }\n                } catch {}\n              }\n            }\n          } catch {}\n        };\n        collectCode(repoPath);\n\n        // Step 3: Use attention mechanisms to weight code importance\n        if (mod.HyperbolicAttention && selectedAttention === 'hyperbolic') {\n          try {\n            // Hyperbolic attention for hierarchical code structure\n            const attention = new mod.HyperbolicAttention({ dim: 384 });\n\n            // Identify structural patterns (classes, functions, imports)\n            const structuralPatterns = [\n              'class definition with constructor',\n              'async function with error handling',\n              'interface with multiple properties',\n              'type with generics',\n              'import statement block',\n              'export default component',\n              'hook implementation useEffect',\n              'API endpoint handler',\n              'database query function',\n              'authentication middleware',\n            ];\n\n            await this.embedBatch(structuralPatterns);\n            patterns.push({ type: 'structural', count: structuralPatterns.length });\n            totalCached += structuralPatterns.length;\n          } catch {}\n        }\n\n        if (mod.MoEAttention && selectedAttention === 'moe') {\n          try {\n            // MoE for routing different code patterns to experts\n            const routingPatterns = [\n              // Expert 1: Frontend\n              'React component with state',\n              'Vue component with props',\n              'CSS styling module',\n              // Expert 2: Backend\n              'Express route handler',\n              'GraphQL resolver',\n              'REST API endpoint',\n              // Expert 3: Data\n              'SQL query builder',\n              'MongoDB aggregation',\n              'Redis cache operation',\n              // Expert 4: Testing\n              'Jest test case',\n              'E2E test scenario',\n              'Mock implementation',\n            ];\n\n            await this.embedBatch(routingPatterns);\n            patterns.push({ type: 'routing', count: routingPatterns.length });\n            totalCached += routingPatterns.length;\n          } catch {}\n        }\n\n        if (mod.GraphRoPeAttention && selectedAttention === 'graph') {\n          try {\n            // Graph attention for dependency understanding\n            const graphPatterns = [\n              'module exports',\n              'circular dependency',\n              'shared utility import',\n              'type re-export',\n              'barrel file index',\n              'lazy import dynamic',\n              'peer dependency',\n              'optional dependency',\n            ];\n\n            await this.embedBatch(graphPatterns);\n            patterns.push({ type: 'graph', count: graphPatterns.length });\n            totalCached += graphPatterns.length;\n          } catch {}\n        }\n\n        attentionInfo.timeMs = performance.now() - attentionStart;\n\n        // Step 4: FastGRNN for pattern prediction (if available)\n        onProgress?.('prediction', 'Training pattern predictor...');\n        if (mod.FastGRNN) {\n          try {\n            // Use recent access patterns to predict what's needed next\n            const topPatterns = this.getTopPatterns(50);\n            if (topPatterns.length > 0) {\n              // Prefetch predicted patterns\n              const prefetchPatterns = [\n                ...topPatterns.slice(0, 20),\n                // Add related patterns\n                ...topPatterns.slice(0, 10).map(p => `similar to: ${p}`),\n              ];\n\n              await this.embedBatch(prefetchPatterns);\n              predictions = {\n                prefetch: prefetchPatterns.length,\n                confidence: 0.85, // Estimated based on access history\n              };\n              totalCached += prefetchPatterns.length;\n            }\n          } catch {}\n        }\n      }\n\n      // Step 5: Standard warmup\n      onProgress?.('warmup', 'Running standard warmup...');\n      const warmupResult = await this.warmup(repoPath);\n      totalCached += warmupResult.patterns + warmupResult.recentChanges;\n      patterns.push({ type: 'warmup', count: warmupResult.patterns + warmupResult.recentChanges });\n\n    } catch (err) {\n      // AI pretrain failed, continue with basic\n    }\n\n    return {\n      patterns,\n      attention: attentionInfo,\n      predictions,\n      totalCached,\n      totalTimeMs: performance.now() - startTime,\n    };\n  }\n\n  /**\n   * Context-aware prefetch using attention\n   * Predicts what embeddings will be needed based on current context\n   */\n  async prefetchForContext(context: {\n    currentFile?: string;\n    recentFiles?: string[];\n    taskType?: 'edit' | 'review' | 'debug' | 'test' | 'refactor';\n    userQuery?: string;\n  }): Promise<{\n    prefetched: number;\n    confidence: number;\n    timeMs: number;\n  }> {\n    const startTime = performance.now();\n    let prefetched = 0;\n    let confidence = 0;\n\n    try {\n      const patterns: string[] = [];\n\n      // Add patterns based on current file type\n      if (context.currentFile) {\n        const ext = context.currentFile.split('.').pop() || '';\n        const filePatterns: Record<string, string[]> = {\n          ts: ['TypeScript type checking', 'interface implementation', 'generic types'],\n          tsx: ['React component', 'JSX rendering', 'hook usage'],\n          js: ['JavaScript module', 'CommonJS require', 'ES6 import'],\n          jsx: ['React component', 'JSX element', 'props handling'],\n          py: ['Python function', 'class method', 'import statement'],\n          md: ['documentation', 'README section', 'code example'],\n        };\n        patterns.push(...(filePatterns[ext] || []));\n      }\n\n      // Add patterns based on task type\n      if (context.taskType) {\n        const taskPatterns: Record<string, string[]> = {\n          edit: ['code modification', 'variable rename', 'function update'],\n          review: ['code review', 'bug detection', 'style check'],\n          debug: ['error trace', 'stack analysis', 'variable inspection'],\n          test: ['test case', 'assertion', 'mock setup'],\n          refactor: ['code cleanup', 'pattern extraction', 'abstraction'],\n        };\n        patterns.push(...(taskPatterns[context.taskType] || []));\n      }\n\n      // Add patterns based on user query similarity\n      if (context.userQuery) {\n        patterns.push(context.userQuery);\n        // Add variations\n        patterns.push(`how to ${context.userQuery}`);\n        patterns.push(`implement ${context.userQuery}`);\n      }\n\n      if (patterns.length > 0) {\n        await this.embedBatch(patterns);\n        prefetched = patterns.length;\n        confidence = Math.min(0.9, 0.5 + patterns.length * 0.05);\n      }\n    } catch {\n      // Prefetch failed\n    }\n\n    return {\n      prefetched,\n      confidence,\n      timeMs: performance.now() - startTime,\n    };\n  }\n}\n\n// Export singleton getter\nexport function getEmbeddingService(): EmbeddingService {\n  return EmbeddingService.getInstance();\n}\n\n// Export convenience functions\nexport async function embed(text: string): Promise<Float32Array> {\n  return getEmbeddingService().embed(text);\n}\n\nexport async function embedBatch(texts: string[]): Promise<Float32Array[]> {\n  return getEmbeddingService().embedBatch(texts);\n}\n\nexport async function pretrainCodePatterns(): Promise<{ cached: number; timeMs: number }> {\n  return getEmbeddingService().pretrainCodePatterns();\n}\n\nexport async function pretrainFromRepo(repoPath: string = '.'): Promise<{\n  files: number;\n  chunks: number;\n  timeMs: number;\n}> {\n  return getEmbeddingService().pretrainFromRepo(repoPath);\n}\n\nexport async function textSimilarity(text1: string, text2: string): Promise<number> {\n  return getEmbeddingService().similarity(text1, text2);\n}\n\nexport function simpleEmbed(text: string, dim: number = 256): Float32Array {\n  return getEmbeddingService().simpleEmbed(text, dim);\n}\n\nexport async function similarityMatrix(texts: string[]): Promise<number[][]> {\n  return getEmbeddingService().similarityMatrix(texts);\n}\n\nexport async function semanticSearch(query: string, topK: number = 5): Promise<SearchResult[]> {\n  return getEmbeddingService().semanticSearch(query, topK);\n}\n\nexport async function findDuplicates(texts: string[], threshold: number = 0.9): Promise<DuplicateGroup[]> {\n  return getEmbeddingService().findDuplicates(texts, threshold);\n}\n\nexport async function clusterTexts(texts: string[], k: number = 3): Promise<{ clusters: number[]; centroids: Float32Array[] }> {\n  return getEmbeddingService().clusterTexts(texts, k);\n}\n"]}
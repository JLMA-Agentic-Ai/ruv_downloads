{"version":3,"file":"auth.middleware.js","sourceRoot":"","sources":["../../src/middleware/auth.middleware.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Authentication Middleware\n *\n * Provides authentication for RuVector integration endpoints:\n * - API key validation\n * - JWT token verification (HMAC-SHA256)\n * - Role-based access control (RBAC)\n * - Audit logging\n */\n\nimport { createHmac, timingSafeEqual } from 'crypto';\n\nexport interface AuthConfig {\n  /** Enable API key authentication */\n  enableApiKey?: boolean;\n  /** Enable JWT authentication */\n  enableJWT?: boolean;\n  /** API keys (key -> user mapping) */\n  apiKeys?: Map<string, { userId: string; tier: string }>;\n  /** JWT secret */\n  jwtSecret?: string;\n  /** Required roles */\n  requiredRoles?: string[];\n}\n\nexport interface AuthUser {\n  id: string;\n  tier: string;\n  roles: string[];\n  apiKey?: string;\n}\n\n/**\n * Authentication Error\n */\nexport class AuthenticationError extends Error {\n  constructor(\n    message: string,\n    public code: 'MISSING_AUTH' | 'INVALID_KEY' | 'EXPIRED_TOKEN' | 'INSUFFICIENT_PERMISSIONS' = 'MISSING_AUTH'\n  ) {\n    super(message);\n    this.name = 'AuthenticationError';\n  }\n}\n\n/**\n * Authentication Middleware\n *\n * Validates requests using:\n * - API key (X-API-Key header)\n * - JWT token (Authorization: Bearer <token>)\n * - Role-based permissions\n */\nexport class AuthMiddleware {\n  private config: Required<AuthConfig>;\n\n  constructor(config?: AuthConfig) {\n    this.config = {\n      enableApiKey: config?.enableApiKey ?? true,\n      enableJWT: config?.enableJWT ?? false,\n      apiKeys: config?.apiKeys ?? new Map(),\n      jwtSecret: config?.jwtSecret ?? (process.env.JWT_SECRET || ''),\n      requiredRoles: config?.requiredRoles ?? [],\n    };\n  }\n\n  /**\n   * Authenticate request\n   *\n   * @param req - Express request\n   * @returns Authenticated user\n   * @throws AuthenticationError if authentication fails\n   */\n  async authenticate(req: any): Promise<AuthUser> {\n    // Try API key authentication\n    if (this.config.enableApiKey) {\n      const apiKey = req.headers['x-api-key'] as string;\n      if (apiKey) {\n        return this.authenticateApiKey(apiKey);\n      }\n    }\n\n    // Try JWT authentication\n    if (this.config.enableJWT) {\n      const authHeader = req.headers['authorization'] as string;\n      if (authHeader?.startsWith('Bearer ')) {\n        const token = authHeader.substring(7);\n        return this.authenticateJWT(token);\n      }\n    }\n\n    throw new AuthenticationError(\n      'No authentication provided',\n      'MISSING_AUTH'\n    );\n  }\n\n  /**\n   * Authenticate using API key\n   *\n   * @param apiKey - API key from header\n   * @returns Authenticated user\n   * @throws AuthenticationError if invalid\n   */\n  private authenticateApiKey(apiKey: string): AuthUser {\n    const userInfo = this.config.apiKeys.get(apiKey);\n\n    if (!userInfo) {\n      throw new AuthenticationError(\n        'Invalid API key',\n        'INVALID_KEY'\n      );\n    }\n\n    return {\n      id: userInfo.userId,\n      tier: userInfo.tier,\n      roles: ['user'],\n      apiKey: apiKey,\n    };\n  }\n\n  /**\n   * Authenticate using JWT with HMAC-SHA256 signature verification\n   *\n   * @param token - JWT token\n   * @returns Authenticated user\n   * @throws AuthenticationError if invalid or signature mismatch\n   */\n  private authenticateJWT(token: string): AuthUser {\n    try {\n      const parts = token.split('.');\n      if (parts.length !== 3) {\n        throw new Error('Invalid token format');\n      }\n\n      const [header, payload, signature] = parts;\n\n      // CRITICAL: Verify JWT secret is configured\n      if (!this.config.jwtSecret || this.config.jwtSecret.length < 32) {\n        throw new AuthenticationError(\n          'JWT authentication not properly configured',\n          'INVALID_KEY'\n        );\n      }\n\n      // CRITICAL: Verify signature using HMAC-SHA256\n      const signatureInput = `${header}.${payload}`;\n      const expectedSignature = this.base64UrlEncode(\n        createHmac('sha256', this.config.jwtSecret)\n          .update(signatureInput)\n          .digest()\n      );\n\n      // Use timing-safe comparison to prevent timing attacks\n      const providedSigBuffer = Buffer.from(signature);\n      const expectedSigBuffer = Buffer.from(expectedSignature);\n\n      if (providedSigBuffer.length !== expectedSigBuffer.length ||\n          !timingSafeEqual(providedSigBuffer, expectedSigBuffer)) {\n        throw new AuthenticationError(\n          'Invalid token signature',\n          'INVALID_KEY'\n        );\n      }\n\n      // Decode and parse payload after signature verification\n      const decodedPayload = JSON.parse(\n        Buffer.from(this.base64UrlDecode(payload), 'base64').toString('utf-8')\n      );\n\n      // Check expiration\n      if (decodedPayload.exp && decodedPayload.exp < Date.now() / 1000) {\n        throw new AuthenticationError(\n          'Token expired',\n          'EXPIRED_TOKEN'\n        );\n      }\n\n      // Check not-before time\n      if (decodedPayload.nbf && decodedPayload.nbf > Date.now() / 1000) {\n        throw new AuthenticationError(\n          'Token not yet valid',\n          'INVALID_KEY'\n        );\n      }\n\n      return {\n        id: decodedPayload.sub || decodedPayload.userId,\n        tier: decodedPayload.tier || 'free',\n        roles: decodedPayload.roles || ['user'],\n      };\n    } catch (error) {\n      if (error instanceof AuthenticationError) {\n        throw error;\n      }\n      throw new AuthenticationError(\n        'Invalid token',\n        'INVALID_KEY'\n      );\n    }\n  }\n\n  /**\n   * Convert base64url to standard base64\n   */\n  private base64UrlDecode(input: string): string {\n    return input.replace(/-/g, '+').replace(/_/g, '/');\n  }\n\n  /**\n   * Convert buffer to base64url encoding\n   */\n  private base64UrlEncode(buffer: Buffer): string {\n    return buffer\n      .toString('base64')\n      .replace(/\\+/g, '-')\n      .replace(/\\//g, '_')\n      .replace(/=+$/, '');\n  }\n\n  /**\n   * Check if user has required roles\n   *\n   * @param user - Authenticated user\n   * @param requiredRoles - Required roles\n   * @returns True if user has all required roles\n   */\n  hasRequiredRoles(user: AuthUser, requiredRoles: string[]): boolean {\n    if (requiredRoles.length === 0) {\n      return true;\n    }\n\n    return requiredRoles.every(role => user.roles.includes(role));\n  }\n\n  /**\n   * Create Express middleware\n   *\n   * @param requiredRoles - Optional required roles\n   * @returns Express middleware function\n   */\n  createMiddleware(requiredRoles?: string[]) {\n    return async (req: any, res: any, next: any) => {\n      try {\n        const user = await this.authenticate(req);\n\n        // Check roles if specified\n        const roles = requiredRoles || this.config.requiredRoles;\n        if (roles.length > 0 && !this.hasRequiredRoles(user, roles)) {\n          throw new AuthenticationError(\n            'Insufficient permissions',\n            'INSUFFICIENT_PERMISSIONS'\n          );\n        }\n\n        // Attach user to request\n        req.user = user;\n        next();\n      } catch (error) {\n        if (error instanceof AuthenticationError) {\n          const statusCode = error.code === 'INSUFFICIENT_PERMISSIONS' ? 403 : 401;\n          res.status(statusCode).json({\n            error: error.name,\n            message: error.message,\n            code: error.code,\n          });\n        } else {\n          res.status(500).json({\n            error: 'Internal Server Error',\n            message: 'Authentication failed',\n          });\n        }\n      }\n    };\n  }\n\n  /**\n   * Register API key\n   *\n   * @param apiKey - API key\n   * @param userId - User ID\n   * @param tier - User tier\n   */\n  registerApiKey(apiKey: string, userId: string, tier: string = 'free'): void {\n    this.config.apiKeys.set(apiKey, { userId, tier });\n  }\n\n  /**\n   * Revoke API key\n   *\n   * @param apiKey - API key to revoke\n   */\n  revokeApiKey(apiKey: string): void {\n    this.config.apiKeys.delete(apiKey);\n  }\n}\n\n/**\n * Create authentication middleware (factory function)\n *\n * @param config - Authentication configuration\n * @returns Middleware function\n */\nexport function createAuthMiddleware(config?: AuthConfig) {\n  const auth = new AuthMiddleware(config);\n  return auth.createMiddleware();\n}\n\n/**\n * Require API key (simple helper)\n */\nexport function requireApiKey(req: any, res: any, next: any) {\n  const apiKey = req.headers['x-api-key'] as string;\n\n  if (!apiKey) {\n    res.status(401).json({\n      error: 'Unauthorized',\n      message: 'API key required',\n    });\n    return;\n  }\n\n  // In production, validate against database\n  if (!apiKey.startsWith('ak_')) {\n    res.status(401).json({\n      error: 'Unauthorized',\n      message: 'Invalid API key format',\n    });\n    return;\n  }\n\n  req.user = {\n    id: 'api-user',\n    tier: 'free',\n    roles: ['user'],\n  };\n\n  next();\n}\n"]}
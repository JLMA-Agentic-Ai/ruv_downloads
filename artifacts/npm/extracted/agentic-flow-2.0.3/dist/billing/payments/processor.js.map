{"version":3,"file":"processor.js","sourceRoot":"","sources":["../../../src/billing/payments/processor.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Payment Processing\n * Integration with agentic-payments library\n */\n\nimport {\n  PaymentProvider,\n  PaymentRequest,\n  PaymentResult,\n  PaymentStatus,\n  PaymentMethod,\n  StorageAdapter\n} from '../types.js';\n\nexport interface PaymentConfig {\n  provider: PaymentProvider;\n  apiKey?: string;\n  secretKey?: string;\n  webhookSecret?: string;\n  testMode?: boolean;\n}\n\nexport class PaymentProcessor {\n  private config: PaymentConfig;\n  private storage?: StorageAdapter;\n\n  constructor(config: PaymentConfig, storage?: StorageAdapter) {\n    this.config = config;\n    this.storage = storage;\n  }\n\n  /**\n   * Process a payment\n   */\n  async processPayment(request: PaymentRequest): Promise<PaymentResult> {\n    try {\n      const result = await this.chargePaymentMethod(\n        request.paymentMethodId,\n        request.amount,\n        request.currency,\n        request.description,\n        request.metadata\n      );\n\n      return result;\n    } catch (error) {\n      return {\n        transactionId: this.generateTransactionId(),\n        status: PaymentStatus.Failed,\n        amount: request.amount,\n        currency: request.currency,\n        error: error instanceof Error ? error.message : 'Payment failed',\n        processedAt: new Date()\n      };\n    }\n  }\n\n  /**\n   * Charge a payment method\n   */\n  async chargePaymentMethod(\n    paymentMethodId: string,\n    amount: number,\n    currency: string,\n    description?: string,\n    metadata?: Record<string, any>\n  ): Promise<PaymentResult> {\n    // In production, this would integrate with agentic-payments\n    // For now, simulate payment processing\n\n    const result: PaymentResult = {\n      transactionId: this.generateTransactionId(),\n      status: PaymentStatus.Succeeded,\n      amount,\n      currency,\n      processedAt: new Date()\n    };\n\n    // Simulate provider-specific transaction IDs\n    switch (this.config.provider) {\n      case PaymentProvider.Stripe:\n        result.providerTransactionId = `pi_${this.generateRandomCode(24)}`;\n        break;\n\n      case PaymentProvider.PayPal:\n        result.providerTransactionId = `PAYID-${this.generateRandomCode(20)}`;\n        break;\n\n      case PaymentProvider.Crypto:\n        result.providerTransactionId = `0x${this.generateRandomCode(64)}`;\n        break;\n    }\n\n    // Simulate 1% payment failure rate in test mode\n    if (this.config.testMode && Math.random() < 0.01) {\n      result.status = PaymentStatus.Failed;\n      result.error = 'Card declined';\n    }\n\n    return result;\n  }\n\n  /**\n   * Refund a payment\n   */\n  async refundPayment(\n    transactionId: string,\n    amount?: number,\n    reason?: string\n  ): Promise<PaymentResult> {\n    // Simulate refund processing\n    return {\n      transactionId: this.generateTransactionId(),\n      status: PaymentStatus.Refunded,\n      amount: amount || 0,\n      currency: 'USD',\n      providerTransactionId: `re_${this.generateRandomCode(24)}`,\n      processedAt: new Date()\n    };\n  }\n\n  /**\n   * Validate payment method\n   */\n  async validatePaymentMethod(paymentMethodId: string): Promise<boolean> {\n    // In production, validate with payment provider\n    // For now, accept any non-empty ID\n    return paymentMethodId.length > 0;\n  }\n\n  /**\n   * Create setup intent (for adding payment methods)\n   */\n  async createSetupIntent(userId: string): Promise<{\n    clientSecret: string;\n    setupIntentId: string;\n  }> {\n    return {\n      clientSecret: `seti_${this.generateRandomCode(32)}`,\n      setupIntentId: `seti_${this.generateRandomCode(24)}`\n    };\n  }\n\n  /**\n   * Create payment intent\n   */\n  async createPaymentIntent(\n    amount: number,\n    currency: string,\n    metadata?: Record<string, any>\n  ): Promise<{\n    clientSecret: string;\n    paymentIntentId: string;\n  }> {\n    return {\n      clientSecret: `pi_${this.generateRandomCode(32)}`,\n      paymentIntentId: `pi_${this.generateRandomCode(24)}`\n    };\n  }\n\n  /**\n   * Handle webhook events from payment provider\n   */\n  async handleWebhook(\n    payload: string,\n    signature: string\n  ): Promise<{\n    event: string;\n    data: any;\n  }> {\n    // Verify webhook signature\n    if (this.config.webhookSecret) {\n      const isValid = this.verifyWebhookSignature(payload, signature);\n      if (!isValid) {\n        throw new Error('Invalid webhook signature');\n      }\n    }\n\n    // Parse webhook payload\n    const event = JSON.parse(payload);\n    return event;\n  }\n\n  private verifyWebhookSignature(payload: string, signature: string): boolean {\n    // In production, verify with provider's signature algorithm\n    // For now, simple check\n    return signature.length > 0;\n  }\n\n  private generateTransactionId(): string {\n    return `txn_${Date.now()}_${this.generateRandomCode(16)}`;\n  }\n\n  private generateRandomCode(length: number): string {\n    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\n    let result = '';\n    for (let i = 0; i < length; i++) {\n      result += chars.charAt(Math.floor(Math.random() * chars.length));\n    }\n    return result;\n  }\n}\n\n/**\n * Payment Provider Factory\n * Creates payment processor for specific provider\n */\nexport class PaymentProviderFactory {\n  static create(provider: PaymentProvider, config: any, storage?: StorageAdapter): PaymentProcessor {\n    const paymentConfig: PaymentConfig = {\n      provider,\n      ...config\n    };\n\n    return new PaymentProcessor(paymentConfig, storage);\n  }\n\n  static createStripe(apiKey: string, storage?: StorageAdapter): PaymentProcessor {\n    return this.create(PaymentProvider.Stripe, { apiKey }, storage);\n  }\n\n  static createPayPal(clientId: string, clientSecret: string, storage?: StorageAdapter): PaymentProcessor {\n    return this.create(PaymentProvider.PayPal, { apiKey: clientId, secretKey: clientSecret }, storage);\n  }\n\n  static createCrypto(walletAddress: string, storage?: StorageAdapter): PaymentProcessor {\n    return this.create(PaymentProvider.Crypto, { apiKey: walletAddress }, storage);\n  }\n}\n"]}